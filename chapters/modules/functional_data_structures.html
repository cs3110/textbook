

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>5.6. Functional Data Structures &#8212; OCaml Programming: Correct + Efficient + Beautiful</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=bd9e20870c6007c4c509" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=bd9e20870c6007c4c509" />
  <script src="../../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=bd9e20870c6007c4c509"></script>

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js"></script>
    <script async="async" kind="hypothesis" src="https://hypothes.is/embed.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'chapters/modules/functional_data_structures';</script>
    <link rel="shortcut icon" href="../../_static/op.png"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="5.7. Module Type Constraints" href="module_type_constraints.html" />
    <link rel="prev" title="5.5. Compilation Units" href="compilation_units.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <header>


  <div class="bd-header-announcement container-fluid bd-header-announcement">
    <div class="bd-header-announcement__content">Using this book as part of a course? Please <a style="color:white" href="https://docs.google.com/forms/d/e/1FAIpQLSfEW65AJPBnk732zZZM9CFpWMobWUkym6Nf-pgslRqqwoWYIA/viewform?usp=preview">let us know</a>!</div>
  </div>

  
    <div class="bd-header navbar navbar-expand-lg bd-navbar">
    </div>
  
  </header>

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="../../cover.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/op_title.png" class="logo__image only-light" alt="OCaml Programming: Correct + Efficient + Beautiful - Home"/>
    <script>document.write(`<img src="../../_static/op_title.png" class="logo__image only-dark" alt="OCaml Programming: Correct + Efficient + Beautiful - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Preface</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../preface/about.html">About This Book</a></li>
<li class="toctree-l1"><a class="reference internal" href="../preface/install.html">Installing OCaml</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../intro/intro.html">1. Better Programming Through OCaml</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../intro/past.html">1.1. The Past of OCaml</a></li>
<li class="toctree-l2"><a class="reference internal" href="../intro/present.html">1.2. The Present of OCaml</a></li>
<li class="toctree-l2"><a class="reference internal" href="../intro/future.html">1.3. Look to Your Future</a></li>
<li class="toctree-l2"><a class="reference internal" href="../intro/3110.html">1.4. A Brief History of CS 3110</a></li>
<li class="toctree-l2"><a class="reference internal" href="../intro/summary.html">1.5. Summary</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../basics/intro.html">2. The Basics of OCaml</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../basics/toplevel.html">2.1. The OCaml Toplevel</a></li>
<li class="toctree-l2"><a class="reference internal" href="../basics/compiling.html">2.2. Compiling OCaml Programs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../basics/expressions.html">2.3. Expressions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../basics/functions.html">2.4. Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../basics/documentation.html">2.5. Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../basics/printing.html">2.6. Printing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../basics/debugging.html">2.7. Debugging</a></li>
<li class="toctree-l2"><a class="reference internal" href="../basics/summary.html">2.8. Summary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../basics/exercises.html">2.9. Exercises</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">OCaml Programming</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../data/intro.html">3. Data and Types</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-3"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../data/lists.html">3.1. Lists</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data/variants.html">3.2. Variants</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data/ounit.html">3.3. Unit Testing with OUnit</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data/records_tuples.html">3.4. Records and Tuples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data/pattern_matching_advanced.html">3.5. Advanced Pattern Matching</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data/type_synonym.html">3.6. Type Synonyms</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data/options.html">3.7. Options</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data/assoc_list.html">3.8. Association Lists</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data/algebraic_data_types.html">3.9. Algebraic Data Types</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data/exceptions.html">3.10. Exceptions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data/trees.html">3.11. Example: Trees</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data/nats.html">3.12. Example: Natural Numbers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data/summary.html">3.13. Summary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data/exercises.html">3.14. Exercises</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../hop/intro.html">4. Higher-Order Programming</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-4"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../hop/higher_order.html">4.1. Higher-Order Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hop/map.html">4.2. Map</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hop/filter.html">4.3. Filter</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hop/fold.html">4.4. Fold</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hop/beyond_lists.html">4.5. Beyond Lists</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hop/pipelining.html">4.6. Pipelining</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hop/currying.html">4.7. Currying</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hop/summary.html">4.8. Summary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hop/exercises.html">4.9. Exercises</a></li>
</ul>
</li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="intro.html">5. Modular Programming</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-5"><i class="fa-solid fa-chevron-down"></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="module_systems.html">5.1. Module Systems</a></li>
<li class="toctree-l2"><a class="reference internal" href="modules.html">5.2. Modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="toplevel.html">5.3. Modules and the Toplevel</a></li>
<li class="toctree-l2"><a class="reference internal" href="encapsulation.html">5.4. Encapsulation</a></li>
<li class="toctree-l2"><a class="reference internal" href="compilation_units.html">5.5. Compilation Units</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">5.6. Functional Data Structures</a></li>
<li class="toctree-l2"><a class="reference internal" href="module_type_constraints.html">5.7. Module Type Constraints</a></li>
<li class="toctree-l2"><a class="reference internal" href="includes.html">5.8. Includes</a></li>
<li class="toctree-l2"><a class="reference internal" href="functors.html">5.9. Functors</a></li>
<li class="toctree-l2"><a class="reference internal" href="summary.html">5.10. Summary</a></li>
<li class="toctree-l2"><a class="reference internal" href="exercises.html">5.11. Exercises</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../mut/intro.html">6. Mutability</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-6"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../mut/refs.html">6.1. Refs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mut/mutable_fields.html">6.2. Mutable Fields</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mut/arrays.html">6.3. Arrays and Loops</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mut/summary.html">6.4. Summary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mut/exercises.html">6.5. Exercises</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../conc/intro.html">7. Concurrency</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-7"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../conc/concurrency.html">7.1. Concurrency</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conc/promises.html">7.2. Promises</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conc/impl_promises.html">7.3. Implementing Promises</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conc/io_promises.html">7.4. Asynchronous Input and Output</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conc/callbacks.html">7.5. Callbacks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conc/impl_callbacks.html">7.6. Implementing Callbacks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conc/full_promises_impl.html">7.7. The Full Promises Implementation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conc/monads.html">7.8. Monads</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conc/summary.html">7.9. Summary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conc/exercises.html">7.10. Exercises</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Correctness and Efficiency</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../correctness/intro.html">8. Correctness</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-8"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../correctness/specifications.html">8.1. Specifications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../correctness/function_docs.html">8.2. Function Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../correctness/module_docs.html">8.3. Module Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../correctness/test_debug.html">8.4. Testing and Debugging</a></li>
<li class="toctree-l2"><a class="reference internal" href="../correctness/black_glass_box.html">8.5. Black-box and Glass-box Testing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../correctness/randomized.html">8.6. Randomized Testing with QCheck</a></li>
<li class="toctree-l2"><a class="reference internal" href="../correctness/proving_correctness.html">8.7. Proving Correctness</a></li>
<li class="toctree-l2"><a class="reference internal" href="../correctness/structural_induction.html">8.8. Structural Induction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../correctness/eq_spec.html">8.9. Equational Specification</a></li>
<li class="toctree-l2"><a class="reference internal" href="../correctness/summary.html">8.10. Summary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../correctness/exercises.html">8.11. Exercises</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../ds/intro.html">9. Data Structures</a><input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-9"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../ds/hash_tables.html">9.1. Hash Tables</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ds/amortized.html">9.2. Amortized Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ds/rb.html">9.3. Red-Black Trees</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ds/sequence.html">9.4. Sequences</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ds/memoization.html">9.5. Memoization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ds/parrays.html">9.6. Persistent Arrays</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ds/summary.html">9.7. Summary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ds/exercises.html">9.8. Exercises</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Language Implementation</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../interp/intro.html">10. Interpreters</a><input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-10"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../interp/calculator.html">10.1. Example: Calculator</a></li>
<li class="toctree-l2"><a class="reference internal" href="../interp/parsing.html">10.2. Parsing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../interp/substitution.html">10.3. Substitution Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../interp/environment.html">10.4. Environment Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../interp/typecheck.html">10.5. Type Checking</a></li>
<li class="toctree-l2"><a class="reference internal" href="../interp/inference.html">10.6. Type Inference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../interp/summary.html">10.7. Summary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../interp/exercises.html">10.8. Exercises</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Lagniappe</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../adv/curry-howard.html">The Curry-Howard Correspondence</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Appendix</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../appendix/bigoh.html">Big-Oh Notation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../appendix/vm.html">Virtual Machine</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/cs3110/textbook/main?urlpath=tree/src/chapters/modules/functional_data_structures.md" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onBinder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../../_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="initThebeSBT()"
  class="btn btn-sm btn-launch-thebe dropdown-item"
  title="Launch Thebe"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="btn__text-container">Live Code</span>
</button>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/cs3110/textbook" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/cs3110/textbook/edit/main/src/chapters/modules/functional_data_structures.md" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/cs3110/textbook/issues/new?title=Issue%20on%20page%20%2Fchapters/modules/functional_data_structures.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/chapters/modules/functional_data_structures.ipynb" target="_blank"
   class="btn btn-sm btn-download-notebook-button dropdown-item"
   title="Download notebook file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-code"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li><a href="../../_sources/chapters/modules/functional_data_structures.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Functional Data Structures</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lists">5.6.1. Lists</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#stacks">5.6.2. Stacks</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#options-vs-exceptions">5.6.3. Options vs Exceptions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#queues">5.6.4. Queues</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#maps">5.6.5. Maps</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#sets">5.6.6. Sets</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="functional-data-structures">
<h1><span class="section-number">5.6. </span>Functional Data Structures<a class="headerlink" href="#functional-data-structures" title="Permalink to this heading">#</a></h1>
<div class="container16x9"><iframe src="https://www.youtube.com/embed/CLeXXZDkkCI" class="responsive-iframe" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>
<p>A <em>functional data structure</em> is one that does not make use of mutability.
It’s possible to build functional data structures both in functional languages
and in imperative languages. For example, you could build
a Java equivalent to OCaml’s <code class="docutils literal notranslate"><span class="pre">list</span></code> type by creating a <code class="docutils literal notranslate"><span class="pre">Node</span></code>
class whose fields are immutable by virtue of using
the <code class="docutils literal notranslate"><span class="pre">final</span></code> keyword.</p>
<p>Functional data structures have the property of being <em>persistent</em>: updating the
data structure with one of its operations does not change the existing version
of the data structure but instead produces a new version. Both exist and both
can still be accessed. A good language implementation will ensure that any parts
of the data structure that are not changed by an operation will be <em>shared</em>
between the old version and the new version. Any parts that do change will be
<em>copied</em> so that the old version may persist. The opposite of a persistent data
structure is an <em>ephemeral</em> data structure: changes are destructive, so that
only one version exists at any time. Both persistent and ephemeral data
structures can be built in both functional and imperative languages.</p>
<section id="lists">
<h2><span class="section-number">5.6.1. </span>Lists<a class="headerlink" href="#lists" title="Permalink to this heading">#</a></h2>
<p>The built-in singly-linked <code class="docutils literal notranslate"><span class="pre">list</span></code> data structure in OCaml is functional. We know
that, because we’ve seen how to implement it with algebraic data types. It’s
also persistent, which we can demonstrate:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-OCaml notranslate"><div class="highlight"><pre><span></span><span class="k">let</span> <span class="n">lst</span> <span class="o">=</span> <span class="o">[</span><span class="mi">1</span><span class="o">;</span> <span class="mi">2</span><span class="o">];;</span>
<span class="k">let</span> <span class="n">lst&#39;</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">tl</span> <span class="n">lst</span><span class="o">;;</span>
<span class="n">lst</span><span class="o">;;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val lst : int list = [1; 2]
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val lst&#39; : int list = [2]
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>- : int list = [1; 2]
</pre></div>
</div>
</div>
</div>
<p>Taking the tail of <code class="docutils literal notranslate"><span class="pre">lst</span></code> does not change the list. Both <code class="docutils literal notranslate"><span class="pre">lst</span></code> and <code class="docutils literal notranslate"><span class="pre">lst'</span></code>
coexist without affecting one another.</p>
</section>
<section id="stacks">
<h2><span class="section-number">5.6.2. </span>Stacks<a class="headerlink" href="#stacks" title="Permalink to this heading">#</a></h2>
<div class="container16x9"><iframe src="https://www.youtube.com/embed/LWmGzSCpvVY" class="responsive-iframe" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>
<p>We implemented stacks earlier in this chapter. Here’s a terse variant of one of
those implementations, in which we add a <code class="docutils literal notranslate"><span class="pre">to_list</span></code> operation to make it easier to
view the contents of the stack in examples:</p>
<div class="cell tag_hide-output docutils container">
<div class="cell_input above-output-prompt docutils container">
<div class="highlight-OCaml notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="k">type</span> <span class="nc">Stack</span> <span class="o">=</span> <span class="k">sig</span>
  <span class="k">type</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span>
  <span class="k">exception</span> <span class="nc">Empty</span>
  <span class="k">val</span> <span class="n">empty</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span>
  <span class="k">val</span> <span class="n">is_empty</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="kt">bool</span>
  <span class="k">val</span> <span class="n">push</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span>
  <span class="k">val</span> <span class="n">peek</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span>
  <span class="k">val</span> <span class="n">pop</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span>
  <span class="k">val</span> <span class="n">size</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="kt">int</span>
  <span class="k">val</span> <span class="n">to_list</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="kt">list</span>
<span class="k">end</span>

<span class="k">module</span> <span class="nc">ListStack</span> <span class="o">:</span> <span class="nc">Stack</span> <span class="o">=</span> <span class="k">struct</span>
  <span class="k">type</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span> <span class="o">=</span> <span class="k">&#39;</span><span class="n">a</span> <span class="kt">list</span>
  <span class="k">exception</span> <span class="nc">Empty</span>
  <span class="k">let</span> <span class="n">empty</span> <span class="o">=</span> <span class="bp">[]</span>
  <span class="k">let</span> <span class="n">is_empty</span> <span class="o">=</span> <span class="k">function</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="bp">true</span> <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">false</span>
  <span class="k">let</span> <span class="n">push</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">cons</span>
  <span class="k">let</span> <span class="n">peek</span> <span class="o">=</span> <span class="k">function</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="k">raise</span> <span class="nc">Empty</span> <span class="o">|</span> <span class="n">x</span> <span class="o">::</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">x</span>
  <span class="k">let</span> <span class="n">pop</span> <span class="o">=</span> <span class="k">function</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="k">raise</span> <span class="nc">Empty</span> <span class="o">|</span> <span class="o">_</span> <span class="o">::</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="n">s</span>
  <span class="k">let</span> <span class="n">size</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">length</span>
  <span class="k">let</span> <span class="n">to_list</span> <span class="o">=</span> <span class="nn">Fun</span><span class="p">.</span><span class="n">id</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<details class="hide below-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell output</span>
<span class="expanded">Hide code cell output</span>
</summary>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>module type Stack =
  sig
    type &#39;a t
    exception Empty
    val empty : &#39;a t
    val is_empty : &#39;a t -&gt; bool
    val push : &#39;a -&gt; &#39;a t -&gt; &#39;a t
    val peek : &#39;a t -&gt; &#39;a
    val pop : &#39;a t -&gt; &#39;a t
    val size : &#39;a t -&gt; int
    val to_list : &#39;a t -&gt; &#39;a list
  end
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>module ListStack : Stack
</pre></div>
</div>
</div>
</details>
</div>
<p>That implementation is functional, as can be seen above, and also persistent:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-OCaml notranslate"><div class="highlight"><pre><span></span><span class="k">open</span> <span class="nc">ListStack</span><span class="o">;;</span>
<span class="k">let</span> <span class="n">s</span> <span class="o">=</span> <span class="n">empty</span> <span class="o">|&gt;</span> <span class="n">push</span> <span class="mi">1</span> <span class="o">|&gt;</span> <span class="n">push</span> <span class="mi">2</span><span class="o">;;</span>
<span class="k">let</span> <span class="n">s&#39;</span> <span class="o">=</span> <span class="n">pop</span> <span class="n">s</span><span class="o">;;</span>
<span class="n">to_list</span> <span class="n">s</span><span class="o">;;</span>
<span class="n">to_list</span> <span class="n">s&#39;</span><span class="o">;;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val s : int ListStack.t = &lt;abstr&gt;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val s&#39; : int ListStack.t = &lt;abstr&gt;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>- : int list = [2; 1]
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>- : int list = [1]
</pre></div>
</div>
</div>
</div>
<p>The value <code class="docutils literal notranslate"><span class="pre">s</span></code> is unchanged by the <code class="docutils literal notranslate"><span class="pre">pop</span></code> operation that creates <code class="docutils literal notranslate"><span class="pre">s'</span></code>. Both
versions of the stack coexist.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">Stack</span></code> module type gives us a strong hint that the data structure is
persistent in the types it provides for <code class="docutils literal notranslate"><span class="pre">push</span></code> and <code class="docutils literal notranslate"><span class="pre">pop</span></code>:</p>
<div class="highlight-ocaml notranslate"><div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">push</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span>
<span class="k">val</span> <span class="n">pop</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span>
</pre></div>
</div>
<p>Both of those take a stack as an argument and return a new stack as a result. An
ephemeral data structure usually would not bother to return a stack. In Java,
for example, similar methods might have a <code class="docutils literal notranslate"><span class="pre">void</span></code> return type; the equivalent in
OCaml would be returning <code class="docutils literal notranslate"><span class="pre">unit</span></code>.</p>
</section>
<section id="options-vs-exceptions">
<h2><span class="section-number">5.6.3. </span>Options vs Exceptions<a class="headerlink" href="#options-vs-exceptions" title="Permalink to this heading">#</a></h2>
<div class="container16x9"><iframe src="https://www.youtube.com/embed/tbMU_pv0p9o" class="responsive-iframe" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>
<p>All of our stack implementations so far have raised an exception whenever <code class="docutils literal notranslate"><span class="pre">peek</span></code>
or <code class="docutils literal notranslate"><span class="pre">pop</span></code> is applied to the empty stack. Another possibility would be to use an
<code class="docutils literal notranslate"><span class="pre">option</span></code> for the return value. If the input stack is empty, then <code class="docutils literal notranslate"><span class="pre">peek</span></code> and
<code class="docutils literal notranslate"><span class="pre">pop</span></code> return <code class="docutils literal notranslate"><span class="pre">None</span></code>; otherwise, they return <code class="docutils literal notranslate"><span class="pre">Some</span></code>.</p>
<div class="cell tag_hide-output docutils container">
<div class="cell_input above-output-prompt docutils container">
<div class="highlight-OCaml notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="k">type</span> <span class="nc">Stack</span> <span class="o">=</span> <span class="k">sig</span>
  <span class="k">type</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span>
  <span class="k">val</span> <span class="n">empty</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span>
  <span class="k">val</span> <span class="n">is_empty</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="kt">bool</span>
  <span class="k">val</span> <span class="n">push</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span>
  <span class="k">val</span> <span class="n">peek</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">option</span>
  <span class="k">val</span> <span class="n">pop</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span> <span class="n">option</span>
  <span class="k">val</span> <span class="n">size</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="kt">int</span>
  <span class="k">val</span> <span class="n">to_list</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="kt">list</span>
<span class="k">end</span>

<span class="k">module</span> <span class="nc">ListStack</span> <span class="o">:</span> <span class="nc">Stack</span> <span class="o">=</span> <span class="k">struct</span>
  <span class="k">type</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span> <span class="o">=</span> <span class="k">&#39;</span><span class="n">a</span> <span class="kt">list</span>
  <span class="k">exception</span> <span class="nc">Empty</span>
  <span class="k">let</span> <span class="n">empty</span> <span class="o">=</span> <span class="bp">[]</span>
  <span class="k">let</span> <span class="n">is_empty</span> <span class="o">=</span> <span class="k">function</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="bp">true</span> <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">false</span>
  <span class="k">let</span> <span class="n">push</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">cons</span>
  <span class="k">let</span> <span class="n">peek</span> <span class="o">=</span> <span class="k">function</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="nc">None</span> <span class="o">|</span> <span class="n">x</span> <span class="o">::</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="nc">Some</span> <span class="n">x</span>
  <span class="k">let</span> <span class="n">pop</span> <span class="o">=</span> <span class="k">function</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="nc">None</span> <span class="o">|</span> <span class="o">_</span> <span class="o">::</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="nc">Some</span> <span class="n">s</span>
  <span class="k">let</span> <span class="n">size</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">length</span>
  <span class="k">let</span> <span class="n">to_list</span> <span class="o">=</span> <span class="nn">Fun</span><span class="p">.</span><span class="n">id</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<details class="hide below-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell output</span>
<span class="expanded">Hide code cell output</span>
</summary>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>module type Stack =
  sig
    type &#39;a t
    val empty : &#39;a t
    val is_empty : &#39;a t -&gt; bool
    val push : &#39;a -&gt; &#39;a t -&gt; &#39;a t
    val peek : &#39;a t -&gt; &#39;a option
    val pop : &#39;a t -&gt; &#39;a t option
    val size : &#39;a t -&gt; int
    val to_list : &#39;a t -&gt; &#39;a list
  end
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>module ListStack : Stack
</pre></div>
</div>
</div>
</details>
</div>
<p>But that makes it harder to pipeline:</p>
<div class="cell tag_raises-exception docutils container">
<div class="cell_input docutils container">
<div class="highlight-OCaml notranslate"><div class="highlight"><pre><span></span><span class="nn">ListStack</span><span class="p">.</span><span class="o">(</span><span class="n">empty</span> <span class="o">|&gt;</span> <span class="n">push</span> <span class="mi">1</span> <span class="o">|&gt;</span> <span class="n">pop</span> <span class="o">|&gt;</span> <span class="n">peek</span><span class="o">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="n">File</span> <span class="s2">&quot;[5]&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1</span><span class="p">,</span> <span class="n">characters</span> <span class="mi">11</span><span class="o">-</span><span class="mi">33</span><span class="p">:</span>
<span class="mi">1</span> <span class="o">|</span> <span class="n">ListStack</span><span class="o">.</span><span class="p">(</span><span class="n">empty</span> <span class="o">|&gt;</span> <span class="n">push</span> <span class="mi">1</span> <span class="o">|&gt;</span> <span class="n">pop</span> <span class="o">|&gt;</span> <span class="n">peek</span><span class="p">)</span>
               <span class="o">^^^^^^^^^^^^^^^^^^^^^^</span>
<span class="ne">Error</span>: This expression has type int ListStack.t option
       <span class="n">but</span> <span class="n">an</span> <span class="n">expression</span> <span class="n">was</span> <span class="n">expected</span> <span class="n">of</span> <span class="nb">type</span> <span class="s1">&#39;a ListStack.t</span>
</pre></div>
</div>
</div>
</div>
<p>The types break down for the pipeline right after the <code class="docutils literal notranslate"><span class="pre">pop</span></code>, because that
now returns an <code class="docutils literal notranslate"><span class="pre">'a</span> <span class="pre">t</span> <span class="pre">option</span></code>, but <code class="docutils literal notranslate"><span class="pre">peek</span></code> expects an input that is merely
an <code class="docutils literal notranslate"><span class="pre">'a</span> <span class="pre">t</span></code>.</p>
<p>It is possible to define some additional operators to help restore the ability
to pipeline. In fact, these functions are already defined in the <code class="docutils literal notranslate"><span class="pre">Option</span></code> module
in the standard library, though not as infix operators:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-OCaml notranslate"><div class="highlight"><pre><span></span><span class="c">(* Option.map aka fmap *)</span>
<span class="k">let</span> <span class="o">(</span> <span class="o">&gt;&gt;|</span> <span class="o">)</span> <span class="n">opt</span> <span class="n">f</span> <span class="o">=</span>
  <span class="k">match</span> <span class="n">opt</span> <span class="k">with</span>
  <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="nc">None</span>
  <span class="o">|</span> <span class="nc">Some</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="nc">Some</span> <span class="o">(</span><span class="n">f</span> <span class="n">x</span><span class="o">)</span>

<span class="c">(* Option.bind *)</span>
<span class="k">let</span> <span class="o">(</span> <span class="o">&gt;&gt;=</span> <span class="o">)</span> <span class="n">opt</span> <span class="n">f</span> <span class="o">=</span>
  <span class="k">match</span> <span class="n">opt</span> <span class="k">with</span>
  <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="nc">None</span>
  <span class="o">|</span> <span class="nc">Some</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">x</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val ( &gt;&gt;| ) : &#39;a option -&gt; (&#39;a -&gt; &#39;b) -&gt; &#39;b option = &lt;fun&gt;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val ( &gt;&gt;= ) : &#39;a option -&gt; (&#39;a -&gt; &#39;b option) -&gt; &#39;b option = &lt;fun&gt;
</pre></div>
</div>
</div>
</div>
<p>We can use those as needed for pipelining:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-OCaml notranslate"><div class="highlight"><pre><span></span><span class="nn">ListStack</span><span class="p">.</span><span class="o">(</span><span class="n">empty</span> <span class="o">|&gt;</span> <span class="n">push</span> <span class="mi">1</span> <span class="o">|&gt;</span> <span class="n">pop</span> <span class="o">&gt;&gt;|</span> <span class="n">push</span> <span class="mi">2</span> <span class="o">&gt;&gt;=</span> <span class="n">pop</span> <span class="o">&gt;&gt;|</span> <span class="n">push</span> <span class="mi">3</span> <span class="o">&gt;&gt;|</span> <span class="n">to_list</span><span class="o">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>- : int list option = Some [3]
</pre></div>
</div>
</div>
</div>
<p>But it’s not so pleasant to figure out which of the three operators to use
where.</p>
<p>There is therefore a tradeoff in the interface design:</p>
<ul class="simple">
<li><p>Using options ensures that surprising exceptions regarding empty stacks never
occur at run-time. The program is therefore more robust. But the convenient
pipeline operator is lost.</p></li>
<li><p>Using exceptions means that programmers don’t have to write as much code. If
they are sure that an exception can’t occur, they can omit the code for
handling it. The program is less robust, but writing it is more convenient.</p></li>
</ul>
<p>There is thus a tradeoff between writing more code early (with options) or doing
more debugging later (with exceptions). The OCaml standard library has recently
begun providing both versions of the interface in a data structure, so that the
client can make the choice of how they want to use it.  For example, we could
provide both <code class="docutils literal notranslate"><span class="pre">peek</span></code> and <code class="docutils literal notranslate"><span class="pre">peek_opt</span></code>, and the same for <code class="docutils literal notranslate"><span class="pre">pop</span></code>, for clients of
our stack module:</p>
<div class="cell tag_hide-output docutils container">
<div class="cell_input above-output-prompt docutils container">
<div class="highlight-OCaml notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="k">type</span> <span class="nc">Stack</span> <span class="o">=</span> <span class="k">sig</span>
  <span class="k">type</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span>
  <span class="k">exception</span> <span class="nc">Empty</span>
  <span class="k">val</span> <span class="n">empty</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span>
  <span class="k">val</span> <span class="n">is_empty</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="kt">bool</span>
  <span class="k">val</span> <span class="n">push</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span>
  <span class="k">val</span> <span class="n">peek</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span>
  <span class="k">val</span> <span class="n">peek_opt</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">option</span>
  <span class="k">val</span> <span class="n">pop</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span>
  <span class="k">val</span> <span class="n">pop_opt</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span> <span class="n">option</span>
  <span class="k">val</span> <span class="n">size</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="kt">int</span>
  <span class="k">val</span> <span class="n">to_list</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="kt">list</span>
<span class="k">end</span>

<span class="k">module</span> <span class="nc">ListStack</span> <span class="o">:</span> <span class="nc">Stack</span> <span class="o">=</span> <span class="k">struct</span>
  <span class="k">type</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span> <span class="o">=</span> <span class="k">&#39;</span><span class="n">a</span> <span class="kt">list</span>
  <span class="k">exception</span> <span class="nc">Empty</span>
  <span class="k">let</span> <span class="n">empty</span> <span class="o">=</span> <span class="bp">[]</span>
  <span class="k">let</span> <span class="n">is_empty</span> <span class="o">=</span> <span class="k">function</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="bp">true</span> <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">false</span>
  <span class="k">let</span> <span class="n">push</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">cons</span>
  <span class="k">let</span> <span class="n">peek</span> <span class="o">=</span> <span class="k">function</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="k">raise</span> <span class="nc">Empty</span> <span class="o">|</span> <span class="n">x</span> <span class="o">::</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">x</span>
  <span class="k">let</span> <span class="n">peek_opt</span> <span class="o">=</span> <span class="k">function</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="nc">None</span> <span class="o">|</span> <span class="n">x</span> <span class="o">::</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="nc">Some</span> <span class="n">x</span>
  <span class="k">let</span> <span class="n">pop</span> <span class="o">=</span> <span class="k">function</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="k">raise</span> <span class="nc">Empty</span> <span class="o">|</span> <span class="o">_</span> <span class="o">::</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="n">s</span>
  <span class="k">let</span> <span class="n">pop_opt</span> <span class="o">=</span> <span class="k">function</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="nc">None</span> <span class="o">|</span> <span class="o">_</span> <span class="o">::</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="nc">Some</span> <span class="n">s</span>
  <span class="k">let</span> <span class="n">size</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">length</span>
  <span class="k">let</span> <span class="n">to_list</span> <span class="o">=</span> <span class="nn">Fun</span><span class="p">.</span><span class="n">id</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<details class="hide below-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell output</span>
<span class="expanded">Hide code cell output</span>
</summary>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>module type Stack =
  sig
    type &#39;a t
    exception Empty
    val empty : &#39;a t
    val is_empty : &#39;a t -&gt; bool
    val push : &#39;a -&gt; &#39;a t -&gt; &#39;a t
    val peek : &#39;a t -&gt; &#39;a
    val peek_opt : &#39;a t -&gt; &#39;a option
    val pop : &#39;a t -&gt; &#39;a t
    val pop_opt : &#39;a t -&gt; &#39;a t option
    val size : &#39;a t -&gt; int
    val to_list : &#39;a t -&gt; &#39;a list
  end
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>module ListStack : Stack
</pre></div>
</div>
</div>
</details>
</div>
<p>One nice thing about this implementation is that it is efficient. All the
operations except for <code class="docutils literal notranslate"><span class="pre">size</span></code> are constant time. We saw earlier in the chapter
that <code class="docutils literal notranslate"><span class="pre">size</span></code> could be made constant time as well, at the cost of some extra space
— though just a constant factor more — by caching the size of the
stack at each node in the list.</p>
</section>
<section id="queues">
<h2><span class="section-number">5.6.4. </span>Queues<a class="headerlink" href="#queues" title="Permalink to this heading">#</a></h2>
<div class="container16x9"><iframe src="https://www.youtube.com/embed/rCiBfZO67A4" class="responsive-iframe" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>
<p>Queues and stacks are fairly similar interfaces.  We’ll stick with exceptions
instead of options for now.</p>
<div class="cell tag_hide-output docutils container">
<div class="cell_input above-output-prompt docutils container">
<div class="highlight-OCaml notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="k">type</span> <span class="nc">Queue</span> <span class="o">=</span> <span class="k">sig</span>
  <span class="c">(** An [&#39;a t] is a queue whose elements have type [&#39;a]. *)</span>
  <span class="k">type</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span>

  <span class="c">(** Raised if [front] or [dequeue] is applied to the empty queue. *)</span>
  <span class="k">exception</span> <span class="nc">Empty</span>

  <span class="c">(** [empty] is the empty queue. *)</span>
  <span class="k">val</span> <span class="n">empty</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span>

  <span class="c">(** [is_empty q] is whether [q] is empty. *)</span>
  <span class="k">val</span> <span class="n">is_empty</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="kt">bool</span>

  <span class="c">(** [enqueue x q] is the queue [q] with [x] added to the end. *)</span>
  <span class="k">val</span> <span class="n">enqueue</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span>

  <span class="c">(** [front q] is the element at the front of the queue. Raises [Empty]</span>
<span class="c">      if [q] is empty. *)</span>
  <span class="k">val</span> <span class="n">front</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span>

  <span class="c">(** [dequeue q] is the queue containing all the elements of [q] except the</span>
<span class="c">      front of [q]. Raises [Empty] is [q] is empty. *)</span>
  <span class="k">val</span> <span class="n">dequeue</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span>

  <span class="c">(** [size q] is the number of elements in [q]. *)</span>
  <span class="k">val</span> <span class="n">size</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="kt">int</span>

  <span class="c">(** [to_list q] is a list containing the elements of [q] in order from</span>
<span class="c">      front to back. *)</span>
  <span class="k">val</span> <span class="n">to_list</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="kt">list</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<details class="hide below-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell output</span>
<span class="expanded">Hide code cell output</span>
</summary>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>module type Queue =
  sig
    type &#39;a t
    exception Empty
    val empty : &#39;a t
    val is_empty : &#39;a t -&gt; bool
    val enqueue : &#39;a -&gt; &#39;a t -&gt; &#39;a t
    val front : &#39;a t -&gt; &#39;a
    val dequeue : &#39;a t -&gt; &#39;a t
    val size : &#39;a t -&gt; int
    val to_list : &#39;a t -&gt; &#39;a list
  end
</pre></div>
</div>
</div>
</details>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Similarly to <code class="docutils literal notranslate"><span class="pre">peek</span></code> and <code class="docutils literal notranslate"><span class="pre">pop</span></code>, note how <code class="docutils literal notranslate"><span class="pre">front</span></code> and <code class="docutils literal notranslate"><span class="pre">dequeue</span></code> divide the
responsibility of getting the first element vs. getting all the rest of the
elements.</p>
</div>
<p>It’s easy to implement queues with lists, just as it was for implementing
stacks:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-OCaml notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="nc">ListQueue</span> <span class="o">:</span> <span class="nc">Queue</span> <span class="o">=</span> <span class="k">struct</span>
  <span class="c">(** The list [x1; x2; ...; xn] represents the queue with [x1] at its front,</span>
<span class="c">      followed by [x2], ..., followed by [xn]. *)</span>
  <span class="k">type</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span> <span class="o">=</span> <span class="k">&#39;</span><span class="n">a</span> <span class="kt">list</span>
  <span class="k">exception</span> <span class="nc">Empty</span>
  <span class="k">let</span> <span class="n">empty</span> <span class="o">=</span> <span class="bp">[]</span>
  <span class="k">let</span> <span class="n">is_empty</span> <span class="o">=</span> <span class="k">function</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="bp">true</span> <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">false</span>
  <span class="k">let</span> <span class="n">enqueue</span> <span class="n">x</span> <span class="n">q</span> <span class="o">=</span> <span class="n">q</span> <span class="o">@</span> <span class="o">[</span><span class="n">x</span><span class="o">]</span>
  <span class="k">let</span> <span class="n">front</span> <span class="o">=</span> <span class="k">function</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="k">raise</span> <span class="nc">Empty</span> <span class="o">|</span> <span class="n">x</span> <span class="o">::</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">x</span>
  <span class="k">let</span> <span class="n">dequeue</span> <span class="o">=</span> <span class="k">function</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="k">raise</span> <span class="nc">Empty</span> <span class="o">|</span> <span class="o">_</span> <span class="o">::</span> <span class="n">q</span> <span class="o">-&gt;</span> <span class="n">q</span>
  <span class="k">let</span> <span class="n">size</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">length</span>
  <span class="k">let</span> <span class="n">to_list</span> <span class="o">=</span> <span class="nn">Fun</span><span class="p">.</span><span class="n">id</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>module ListQueue : Queue
</pre></div>
</div>
</div>
</div>
<p>But despite being as easy, this implementation is not as efficient as our
list-based stacks. Dequeueing is a constant-time operation with this
representation, but enqueueing is a linear-time operation. That’s because
<code class="docutils literal notranslate"><span class="pre">dequeue</span></code> does a single pattern match, whereas <code class="docutils literal notranslate"><span class="pre">enqueue</span></code> must traverse the
entire list to append the new element at the end.</p>
<p>There’s a very clever way to do better on efficiency. We can use two lists to
represent a single queue. This representation was invented by Robert Melville as
part of his PhD dissertation at Cornell (<em>Asymptotic Complexity of Iterative
Computations</em>, Jan 1981), which was advised by Prof. David Gries. Chris Okasaki
(<em>Purely Functional Data Structures</em>, Cambridge University Press, 1988) calls
these <em>batched queues</em>. Sometimes you will see this same implementation referred
to as “implementing a queue with two stacks”. That’s because stacks and lists
are so similar (as we’ve already seen) that you could rewrite <code class="docutils literal notranslate"><span class="pre">pop</span></code> as
<code class="docutils literal notranslate"><span class="pre">List.tl</span></code>, and so forth.</p>
<p>The core idea has a Part A and a Part B. Part A is: we use the two lists to
split the queue into two pieces, the <em>inbox</em> and <em>outbox</em>. When new elements are
enqueued, we put them in the inbox. Eventually (we’ll soon come to how) elements
are transferred from the inbox to the outbox. When a dequeue is requested, that
element is removed from the outbox; or when the front element is requested, we
check the outbox for it. For example, if the inbox currently had <code class="docutils literal notranslate"><span class="pre">[3;</span> <span class="pre">4;</span> <span class="pre">5]</span></code> and
the outbox had <code class="docutils literal notranslate"><span class="pre">[1;</span> <span class="pre">2]</span></code>, then the front element would be <code class="docutils literal notranslate"><span class="pre">1</span></code>, which is the head
of the outbox. Dequeuing would remove that element and leave the outbox with
just <code class="docutils literal notranslate"><span class="pre">[2]</span></code>. Likewise, enqueuing <code class="docutils literal notranslate"><span class="pre">6</span></code> would make the inbox become <code class="docutils literal notranslate"><span class="pre">[3;</span> <span class="pre">4;</span> <span class="pre">5;</span> <span class="pre">6]</span></code>.</p>
<p>The efficiency of <code class="docutils literal notranslate"><span class="pre">front</span></code> and <code class="docutils literal notranslate"><span class="pre">dequeue</span></code> is very good so far. We just have to
take the head or tail of the outbox, respectively, assuming it is non-empty.
Those are constant-time operations. But the efficiency of <code class="docutils literal notranslate"><span class="pre">enqueue</span></code> is still
bad. It’s linear time, because we have to append the new element to the end of
the list. It’s too bad we have to use the append operator, which is inherently
linear time. It would be much better if we could use cons, which is constant
time.</p>
<p>So here’s Part B of the core idea: let’s keep the inbox in reverse order.  For
example, if we enqueued <code class="docutils literal notranslate"><span class="pre">3</span></code> then <code class="docutils literal notranslate"><span class="pre">4</span></code> then <code class="docutils literal notranslate"><span class="pre">5</span></code>, the inbox would actually
be <code class="docutils literal notranslate"><span class="pre">[5;</span> <span class="pre">4;</span> <span class="pre">3]</span></code>, not <code class="docutils literal notranslate"><span class="pre">[3;</span> <span class="pre">4;</span> <span class="pre">5]</span></code>.  Then if <code class="docutils literal notranslate"><span class="pre">6</span></code> were enqueued next, we could
cons it onto the beginning of the inbox, which becomes <code class="docutils literal notranslate"><span class="pre">[6;</span> <span class="pre">5;</span> <span class="pre">4;</span> <span class="pre">3]</span></code>.  The
queue represented by inbox <code class="docutils literal notranslate"><span class="pre">i</span></code> and outbox <code class="docutils literal notranslate"><span class="pre">o</span></code> is therefore <code class="docutils literal notranslate"><span class="pre">o</span> <span class="pre">&#64;</span> <span class="pre">List.rev</span> <span class="pre">i</span></code>.
So <code class="docutils literal notranslate"><span class="pre">enqueue</span></code> can now always be a constant-time operation.</p>
<p>But what about <code class="docutils literal notranslate"><span class="pre">dequeue</span></code> (and <code class="docutils literal notranslate"><span class="pre">front</span></code>)? They’re constant time too, <strong>as long as
the outbox is not empty.</strong> If it’s empty, we have a problem. We need to transfer
whatever is in the inbox to the outbox at that point.  For example, if the
outbox is empty, and the inbox is <code class="docutils literal notranslate"><span class="pre">[6;</span> <span class="pre">5;</span> <span class="pre">4;</span> <span class="pre">3]</span></code>, then we need to switch them
around, making the outbox be <code class="docutils literal notranslate"><span class="pre">[3;</span> <span class="pre">4;</span> <span class="pre">5;</span> <span class="pre">6]</span></code> and the inbox be empty.  That’s
actually easy:  we just have to reverse the list.</p>
<p>Unfortunately, we just re-introduced a linear-time operation. But with one
crucial difference: we don’t have to do that linear-time reverse on every
<code class="docutils literal notranslate"><span class="pre">dequeue</span></code>, whereas with <code class="docutils literal notranslate"><span class="pre">ListQueue</span></code> above we had to do the linear-time append on
every <code class="docutils literal notranslate"><span class="pre">enqueue</span></code>. Instead, we only have to do the reverse on those rare occasions
when the outbox becomes empty.</p>
<p>So even though in the worst case <code class="docutils literal notranslate"><span class="pre">dequeue</span></code> (and <code class="docutils literal notranslate"><span class="pre">front</span></code>) will be linear time,
most of the time they will not be. In fact, later in this book when we study
<em>amortized analysis</em> we will show that in the long run they can be understood as
constant-time operations. For now, here’s a piece of intuition to support that
claim: every individual element enters the inbox once (with a cons), moves to
the outbox once (with a pattern match then cons), and leaves the outbox once (with
a pattern match). Each of those is constant time. So each element only ever
experiences constant-time operations from its own perspective.</p>
<p>For now, let’s move on to implementing these ideas. In the implementation, we’ll
add one more idea: the outbox always has to have an element in it, unless the
queue is empty. In other words, if the outbox is empty, we’re guaranteed the
inbox is too. That requirement isn’t necessary for batched queues, but it does
keep the code simpler by reducing the number of times we have to check whether a
list is empty. The tiny tradeoff is that if the queue is empty, <code class="docutils literal notranslate"><span class="pre">enqueue</span></code> now
has to directly put an element into the outbox. No matter, that’s still a
constant-time operation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-OCaml notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="nc">BatchedQueue</span> <span class="o">:</span> <span class="nc">Queue</span> <span class="o">=</span> <span class="k">struct</span>
  <span class="c">(** [{o; i}] represents the queue [o @ List.rev i]. For example,</span>
<span class="c">      [{o = [1; 2]; i = [5; 4; 3]}] represents the queue [1, 2, 3, 4, 5],</span>
<span class="c">      where [1] is the front element. To avoid ambiguity about emptiness,</span>
<span class="c">      whenever only one of the lists is empty, it must be [i]. For example,</span>
<span class="c">      [{o = [1]; i = []}] is a legal representation, but [{o = []; i = [1]}]</span>
<span class="c">      is not. This implies that if [o] is empty, [i] must also be empty. *)</span>
  <span class="k">type</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span> <span class="o">=</span> <span class="o">{</span><span class="n">o</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="kt">list</span><span class="o">;</span> <span class="n">i</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="kt">list</span><span class="o">}</span>

  <span class="k">exception</span> <span class="nc">Empty</span>

  <span class="k">let</span> <span class="n">empty</span> <span class="o">=</span> <span class="o">{</span><span class="n">o</span> <span class="o">=</span> <span class="bp">[]</span><span class="o">;</span> <span class="n">i</span> <span class="o">=</span> <span class="bp">[]</span><span class="o">}</span>

  <span class="k">let</span> <span class="n">is_empty</span> <span class="o">=</span> <span class="k">function</span>
    <span class="o">|</span> <span class="o">{</span><span class="n">o</span> <span class="o">=</span> <span class="bp">[]</span><span class="o">}</span> <span class="o">-&gt;</span> <span class="bp">true</span>
    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">false</span>

  <span class="k">let</span> <span class="n">enqueue</span> <span class="n">x</span> <span class="o">=</span> <span class="k">function</span>
    <span class="o">|</span> <span class="o">{</span><span class="n">o</span> <span class="o">=</span> <span class="bp">[]</span><span class="o">}</span> <span class="o">-&gt;</span> <span class="o">{</span><span class="n">o</span> <span class="o">=</span> <span class="o">[</span><span class="n">x</span><span class="o">];</span> <span class="n">i</span> <span class="o">=</span> <span class="bp">[]</span><span class="o">}</span>
    <span class="o">|</span> <span class="o">{</span><span class="n">o</span><span class="o">;</span> <span class="n">i</span><span class="o">}</span> <span class="o">-&gt;</span> <span class="o">{</span><span class="n">o</span><span class="o">;</span> <span class="n">i</span> <span class="o">=</span> <span class="n">x</span> <span class="o">::</span> <span class="n">i</span><span class="o">}</span>

  <span class="k">let</span> <span class="n">front</span> <span class="o">=</span> <span class="k">function</span>
    <span class="o">|</span> <span class="o">{</span><span class="n">o</span> <span class="o">=</span> <span class="bp">[]</span><span class="o">}</span> <span class="o">-&gt;</span> <span class="k">raise</span> <span class="nc">Empty</span>
    <span class="o">|</span> <span class="o">{</span><span class="n">o</span> <span class="o">=</span> <span class="n">h</span> <span class="o">::</span> <span class="o">_}</span> <span class="o">-&gt;</span> <span class="n">h</span>

  <span class="k">let</span> <span class="n">dequeue</span> <span class="o">=</span> <span class="k">function</span>
    <span class="o">|</span> <span class="o">{</span><span class="n">o</span> <span class="o">=</span> <span class="bp">[]</span><span class="o">}</span> <span class="o">-&gt;</span> <span class="k">raise</span> <span class="nc">Empty</span>
    <span class="o">|</span> <span class="o">{</span><span class="n">o</span> <span class="o">=</span> <span class="o">[_];</span> <span class="n">i</span><span class="o">}</span> <span class="o">-&gt;</span> <span class="o">{</span><span class="n">o</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="n">i</span><span class="o">;</span> <span class="n">i</span> <span class="o">=</span> <span class="bp">[]</span><span class="o">}</span>
    <span class="o">|</span> <span class="o">{</span><span class="n">o</span> <span class="o">=</span> <span class="o">_</span> <span class="o">::</span> <span class="n">t</span><span class="o">;</span> <span class="n">i</span><span class="o">}</span> <span class="o">-&gt;</span> <span class="o">{</span><span class="n">o</span> <span class="o">=</span> <span class="n">t</span><span class="o">;</span> <span class="n">i</span><span class="o">}</span>

  <span class="k">let</span> <span class="n">size</span> <span class="o">{</span><span class="n">o</span><span class="o">;</span> <span class="n">i</span><span class="o">}</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="o">(</span><span class="n">length</span> <span class="n">o</span> <span class="o">+</span> <span class="n">length</span> <span class="n">i</span><span class="o">)</span>

  <span class="k">let</span> <span class="n">to_list</span> <span class="o">{</span><span class="n">o</span><span class="o">;</span> <span class="n">i</span><span class="o">}</span> <span class="o">=</span> <span class="n">o</span> <span class="o">@</span> <span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="n">i</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>module BatchedQueue : Queue
</pre></div>
</div>
</div>
</div>
<p>The efficiency of batched queues comes at a price in readability. If we compare
<code class="docutils literal notranslate"><span class="pre">ListQueue</span></code> and <code class="docutils literal notranslate"><span class="pre">BatchedQueue</span></code>, it’s hopefully clear that <code class="docutils literal notranslate"><span class="pre">ListQueue</span></code> is a
simple and correct implementation of a queue data structure. It’s probably far
less clear that <code class="docutils literal notranslate"><span class="pre">BatchedQueue</span></code> is a correct implementation. Just look at how
many paragraphs of writing it took to explain it above!</p>
</section>
<section id="maps">
<h2><span class="section-number">5.6.5. </span>Maps<a class="headerlink" href="#maps" title="Permalink to this heading">#</a></h2>
<p>Recall that a <em>map</em> (aka <em>dictionary</em>) binds keys to values. Here is a module
type for maps. There are many other operations a map might support, but
these will suffice for now.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-OCaml notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="k">type</span> <span class="nc">Map</span> <span class="o">=</span> <span class="k">sig</span>
  <span class="c">(** [(&#39;k, &#39;v) t] is the type of maps that bind keys of type [&#39;k] to</span>
<span class="c">      values of type [&#39;v]. *)</span>
  <span class="k">type</span> <span class="o">(</span><span class="k">&#39;</span><span class="n">k</span><span class="o">,</span> <span class="k">&#39;</span><span class="n">v</span><span class="o">)</span> <span class="n">t</span>

  <span class="c">(** [empty] does not bind any keys. *)</span>
  <span class="k">val</span> <span class="n">empty</span>  <span class="o">:</span> <span class="o">(</span><span class="k">&#39;</span><span class="n">k</span><span class="o">,</span> <span class="k">&#39;</span><span class="n">v</span><span class="o">)</span> <span class="n">t</span>

  <span class="c">(** [insert k v m] is the map that binds [k] to [v], and also contains</span>
<span class="c">      all the bindings of [m].  If [k] was already bound in [m], that old</span>
<span class="c">      binding is superseded by the binding to [v] in the returned map. *)</span>
  <span class="k">val</span> <span class="n">insert</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">k</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">v</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="k">&#39;</span><span class="n">k</span><span class="o">,</span> <span class="k">&#39;</span><span class="n">v</span><span class="o">)</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="k">&#39;</span><span class="n">k</span><span class="o">,</span> <span class="k">&#39;</span><span class="n">v</span><span class="o">)</span> <span class="n">t</span>

  <span class="c">(** [lookup k m] is the value bound to [k] in [m]. Raises: [Not_found] if [k]</span>
<span class="c">      is not bound in [m]. *)</span>
  <span class="k">val</span> <span class="n">lookup</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">k</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="k">&#39;</span><span class="n">k</span><span class="o">,</span> <span class="k">&#39;</span><span class="n">v</span><span class="o">)</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">v</span>

  <span class="c">(** [bindings m] is an association list containing the same bindings as [m].</span>
<span class="c">      The keys in the list are guaranteed to be unique. *)</span>
  <span class="k">val</span> <span class="n">bindings</span> <span class="o">:</span> <span class="o">(</span><span class="k">&#39;</span><span class="n">k</span><span class="o">,</span> <span class="k">&#39;</span><span class="n">v</span><span class="o">)</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="k">&#39;</span><span class="n">k</span> <span class="o">*</span> <span class="k">&#39;</span><span class="n">v</span><span class="o">)</span> <span class="kt">list</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>module type Map =
  sig
    type (&#39;k, &#39;v) t
    val empty : (&#39;k, &#39;v) t
    val insert : &#39;k -&gt; &#39;v -&gt; (&#39;k, &#39;v) t -&gt; (&#39;k, &#39;v) t
    val lookup : &#39;k -&gt; (&#39;k, &#39;v) t -&gt; &#39;v
    val bindings : (&#39;k, &#39;v) t -&gt; (&#39;k * &#39;v) list
  end
</pre></div>
</div>
</div>
</div>
<p>Note how <code class="docutils literal notranslate"><span class="pre">Map.t</span></code> is parameterized on two types, <code class="docutils literal notranslate"><span class="pre">'k</span></code> and <code class="docutils literal notranslate"><span class="pre">'v</span></code>, which are written
in parentheses and separated by commas. Although <code class="docutils literal notranslate"><span class="pre">('k,</span> <span class="pre">'v)</span></code> might look like a
pair of values, it is not: it is a syntax for writing multiple type variables.</p>
<p>Recall that association lists are lists of pairs, where the first element of
each pair is a key, and the second element is the value it binds. For example,
here is an association list that maps some well-known names to an approximation
of their numeric value:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[(</span><span class="s2">&quot;pi&quot;</span><span class="p">,</span> <span class="mf">3.14</span><span class="p">);</span> <span class="p">(</span><span class="s2">&quot;e&quot;</span><span class="p">,</span> <span class="mf">2.718</span><span class="p">);</span> <span class="p">(</span><span class="s2">&quot;phi&quot;</span><span class="p">,</span> <span class="mf">1.618</span><span class="p">)]</span>
</pre></div>
</div>
<p>Naturally we can implement the <code class="docutils literal notranslate"><span class="pre">Map</span></code> module type with association lists:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-OCaml notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="nc">AssocListMap</span> <span class="o">:</span> <span class="nc">Map</span> <span class="o">=</span> <span class="k">struct</span>
  <span class="c">(** The list [(k1, v1); ...; (kn, vn)] binds key [ki] to value [vi].</span>
<span class="c">      If a key appears more than once in the list, it is bound to the</span>
<span class="c">      the left-most occurrence in the list. *)</span>
  <span class="k">type</span> <span class="o">(</span><span class="k">&#39;</span><span class="n">k</span><span class="o">,</span> <span class="k">&#39;</span><span class="n">v</span><span class="o">)</span> <span class="n">t</span> <span class="o">=</span> <span class="o">(</span><span class="k">&#39;</span><span class="n">k</span> <span class="o">*</span> <span class="k">&#39;</span><span class="n">v</span><span class="o">)</span> <span class="kt">list</span>
  <span class="k">let</span> <span class="n">empty</span> <span class="o">=</span> <span class="bp">[]</span>
  <span class="k">let</span> <span class="n">insert</span> <span class="n">k</span> <span class="n">v</span> <span class="n">m</span> <span class="o">=</span> <span class="o">(</span><span class="n">k</span><span class="o">,</span> <span class="n">v</span><span class="o">)</span> <span class="o">::</span> <span class="n">m</span>
  <span class="k">let</span> <span class="n">lookup</span> <span class="n">k</span> <span class="n">m</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">assoc</span> <span class="n">k</span> <span class="n">m</span>
  <span class="k">let</span> <span class="n">keys</span> <span class="n">m</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="o">(</span><span class="n">m</span> <span class="o">|&gt;</span> <span class="n">map</span> <span class="n">fst</span> <span class="o">|&gt;</span> <span class="n">sort_uniq</span> <span class="nn">Stdlib</span><span class="p">.</span><span class="n">compare</span><span class="o">)</span>
  <span class="k">let</span> <span class="n">bindings</span> <span class="n">m</span> <span class="o">=</span> <span class="n">m</span> <span class="o">|&gt;</span> <span class="n">keys</span> <span class="o">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">k</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">k</span><span class="o">,</span> <span class="n">lookup</span> <span class="n">k</span> <span class="n">m</span><span class="o">))</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>module AssocListMap : Map
</pre></div>
</div>
</div>
</div>
<p>This implementation of maps is persistent.  For example, adding a new
binding to the map <code class="docutils literal notranslate"><span class="pre">m</span></code> below does not change <code class="docutils literal notranslate"><span class="pre">m</span></code> itself:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-OCaml notranslate"><div class="highlight"><pre><span></span><span class="k">open</span> <span class="nc">AssocListMap</span>
<span class="k">let</span> <span class="n">m</span> <span class="o">=</span> <span class="n">empty</span> <span class="o">|&gt;</span> <span class="n">insert</span> <span class="s2">&quot;pi&quot;</span> <span class="mi">3</span><span class="o">.</span><span class="mi">14</span> <span class="o">|&gt;</span> <span class="n">insert</span> <span class="s2">&quot;e&quot;</span> <span class="mi">2</span><span class="o">.</span><span class="mi">718</span>
<span class="k">let</span> <span class="n">m&#39;</span> <span class="o">=</span> <span class="n">m</span> <span class="o">|&gt;</span> <span class="n">insert</span> <span class="s2">&quot;phi&quot;</span> <span class="mi">1</span><span class="o">.</span><span class="mi">618</span>
<span class="k">let</span> <span class="n">b</span> <span class="o">=</span> <span class="n">bindings</span> <span class="n">m</span>
<span class="k">let</span> <span class="n">b&#39;</span> <span class="o">=</span> <span class="n">bindings</span> <span class="n">m&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val m : (string, float) AssocListMap.t = &lt;abstr&gt;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val m&#39; : (string, float) AssocListMap.t = &lt;abstr&gt;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val b : (string * float) list = [(&quot;e&quot;, 2.718); (&quot;pi&quot;, 3.14)]
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val b&#39; : (string * float) list = [(&quot;e&quot;, 2.718); (&quot;phi&quot;, 1.618); (&quot;pi&quot;, 3.14)]
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">insert</span></code> operation is constant time, which is great. But the <code class="docutils literal notranslate"><span class="pre">lookup</span></code>
operation is linear time. It’s possible to do much better than that. In a later
chapter, we’ll see how to do better. Logarithmic-time performance is achievable
with balanced binary trees, and something like constant-time performance with
hash tables. Neither of those, however, achieves the simplicity of the code
above.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">bindings</span></code> operation is complicated by potential duplicate keys in the list.
It uses a <code class="docutils literal notranslate"><span class="pre">keys</span></code> helper function to extract the unique list of keys with the
help of library function <code class="docutils literal notranslate"><span class="pre">List.sort_uniq</span></code>. That function sorts an input list and
in the process discards duplicates. It requires a comparison function as input.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>A comparison function must return 0 if its arguments compare as equal, a
positive integer if the first is greater, and a negative integer if the first is
smaller.</p>
</div>
<p>Here we use the standard library’s comparison function <code class="docutils literal notranslate"><span class="pre">Stdlib.compare</span></code>, which
behaves essentially the same as the built-in comparison operators <code class="docutils literal notranslate"><span class="pre">=</span></code>, <code class="docutils literal notranslate"><span class="pre">&lt;</span></code>, <code class="docutils literal notranslate"><span class="pre">&gt;</span></code>,
etc. Custom comparison functions are useful if you want to have a relaxed notion
of what being a duplicate means. For example, maybe you’d like to ignore the
case of strings, or the sign of a number, etc.</p>
<p>The running time of <code class="docutils literal notranslate"><span class="pre">List.sort_uniq</span></code> is linearithmic, and it produces a linear
number of keys as output.  For each of those keys, we do a linear-time lookup
operation.  So the total running time of <code class="docutils literal notranslate"><span class="pre">bindings</span></code> is <span class="math notranslate nohighlight">\(O(n \log n) + O(n) \cdot
O(n)\)</span>, which is <span class="math notranslate nohighlight">\(O(n^2)\)</span>.  We can definitely do better than that with
more advanced data structures.</p>
<p>Actually we can have a constant-time <code class="docutils literal notranslate"><span class="pre">bindings</span></code> operation even with association
lists, if we are willing to pay for a linear-time <code class="docutils literal notranslate"><span class="pre">insert</span></code> operation:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-OCaml notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="nc">UniqAssocListMap</span> <span class="o">:</span> <span class="nc">Map</span> <span class="o">=</span> <span class="k">struct</span>
  <span class="c">(** The list [(k1, v1); ...; (kn, vn)] binds key [ki] to value [vi].</span>
<span class="c">      No duplicate keys may occur. *)</span>
  <span class="k">type</span> <span class="o">(</span><span class="k">&#39;</span><span class="n">k</span><span class="o">,</span> <span class="k">&#39;</span><span class="n">v</span><span class="o">)</span> <span class="n">t</span> <span class="o">=</span> <span class="o">(</span><span class="k">&#39;</span><span class="n">k</span> <span class="o">*</span> <span class="k">&#39;</span><span class="n">v</span><span class="o">)</span> <span class="kt">list</span>
  <span class="k">let</span> <span class="n">empty</span> <span class="o">=</span> <span class="bp">[]</span>
  <span class="k">let</span> <span class="n">insert</span> <span class="n">k</span> <span class="n">v</span> <span class="n">m</span> <span class="o">=</span> <span class="o">(</span><span class="n">k</span><span class="o">,</span> <span class="n">v</span><span class="o">)</span> <span class="o">::</span> <span class="nn">List</span><span class="p">.</span><span class="n">remove_assoc</span> <span class="n">k</span> <span class="n">m</span>
  <span class="k">let</span> <span class="n">lookup</span> <span class="n">k</span> <span class="n">m</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">assoc</span> <span class="n">k</span> <span class="n">m</span>
  <span class="k">let</span> <span class="n">bindings</span> <span class="n">m</span> <span class="o">=</span> <span class="n">m</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>module UniqAssocListMap : Map
</pre></div>
</div>
</div>
</div>
<p>That implementation removes any duplicate binding of <code class="docutils literal notranslate"><span class="pre">k</span></code> before inserting
a new binding.</p>
</section>
<section id="sets">
<h2><span class="section-number">5.6.6. </span>Sets<a class="headerlink" href="#sets" title="Permalink to this heading">#</a></h2>
<p>Here is a module type for sets. There are many other operations a set data
structure might be expected to support, but these will suffice for now.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-OCaml notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="k">type</span> <span class="nc">Set</span> <span class="o">=</span> <span class="k">sig</span>
  <span class="c">(** [&#39;a t] is the type of sets whose elements are of type [&#39;a]. *)</span>
  <span class="k">type</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span>

  <span class="c">(** [empty] is the empty set. *)</span>
  <span class="k">val</span> <span class="n">empty</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span>

  <span class="c">(** [mem x s] is whether [x] is an element of [s]. *)</span>
  <span class="k">val</span> <span class="n">mem</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="kt">bool</span>

  <span class="c">(** [add x s] is the set that contains [x] and all the elements of [s]. *)</span>
  <span class="k">val</span> <span class="n">add</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span>

  <span class="c">(** [elements s] is a list containing the elements of [s].  No guarantee</span>
<span class="c">      is made about the ordering of that list, but each element is guaranteed</span>
<span class="c">      to be unique. *)</span>
  <span class="k">val</span> <span class="n">elements</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="kt">list</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>module type Set =
  sig
    type &#39;a t
    val empty : &#39;a t
    val mem : &#39;a -&gt; &#39;a t -&gt; bool
    val add : &#39;a -&gt; &#39;a t -&gt; &#39;a t
    val elements : &#39;a t -&gt; &#39;a list
  end
</pre></div>
</div>
</div>
</div>
<p>Here’s an implementation of that interface using a list to represent the set.
This implementation ensures that the list never contains any duplicate elements,
since sets themselves do not:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-OCaml notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="nc">UniqListSet</span> <span class="o">:</span> <span class="nc">Set</span> <span class="o">=</span> <span class="k">struct</span>
  <span class="k">type</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span> <span class="o">=</span> <span class="k">&#39;</span><span class="n">a</span> <span class="kt">list</span>
  <span class="k">let</span> <span class="n">empty</span> <span class="o">=</span> <span class="bp">[]</span>
  <span class="k">let</span> <span class="n">mem</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">mem</span>
  <span class="k">let</span> <span class="n">add</span> <span class="n">x</span> <span class="n">s</span> <span class="o">=</span> <span class="k">if</span> <span class="n">mem</span> <span class="n">x</span> <span class="n">s</span> <span class="k">then</span> <span class="n">s</span> <span class="k">else</span> <span class="n">x</span> <span class="o">::</span> <span class="n">s</span>
  <span class="k">let</span> <span class="n">elements</span> <span class="o">=</span> <span class="nn">Fun</span><span class="p">.</span><span class="n">id</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>module UniqListSet : Set
</pre></div>
</div>
</div>
</div>
<p>Note how <code class="docutils literal notranslate"><span class="pre">add</span></code> ensures that the representation never contains any duplicates, so
the implementation of <code class="docutils literal notranslate"><span class="pre">elements</span></code> is easy. Of course, that comes with the
tradeoff of <code class="docutils literal notranslate"><span class="pre">add</span></code> being linear time.</p>
<p>Here’s a second implementation, which permits duplicates in the list:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-OCaml notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="nc">ListSet</span> <span class="o">:</span> <span class="nc">Set</span> <span class="o">=</span> <span class="k">struct</span>
  <span class="k">type</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span> <span class="o">=</span> <span class="k">&#39;</span><span class="n">a</span> <span class="kt">list</span>
  <span class="k">let</span> <span class="n">empty</span> <span class="o">=</span> <span class="bp">[]</span>
  <span class="k">let</span> <span class="n">mem</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">mem</span>
  <span class="k">let</span> <span class="n">add</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">cons</span>
  <span class="k">let</span> <span class="n">elements</span> <span class="n">s</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">sort_uniq</span> <span class="nn">Stdlib</span><span class="p">.</span><span class="n">compare</span> <span class="n">s</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>module ListSet : Set
</pre></div>
</div>
</div>
</div>
<p>In that implementation, the <code class="docutils literal notranslate"><span class="pre">add</span></code> operation is now constant time, and the
<code class="docutils literal notranslate"><span class="pre">elements</span></code> operation is linearithmic time.</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "cs3110/textbook",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "ocaml-jupyter"
        },
        kernelOptions: {
            name: "ocaml-jupyter",
            path: "./chapters/modules"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'ocaml-jupyter'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="compilation_units.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title"><span class="section-number">5.5. </span>Compilation Units</p>
      </div>
    </a>
    <a class="right-next"
       href="module_type_constraints.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">5.7. </span>Module Type Constraints</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lists">5.6.1. Lists</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#stacks">5.6.2. Stacks</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#options-vs-exceptions">5.6.3. Options vs Exceptions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#queues">5.6.4. Queues</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#maps">5.6.5. Maps</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#sets">5.6.6. Sets</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Michael R. Clarkson et al.
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2025.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=bd9e20870c6007c4c509"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=bd9e20870c6007c4c509"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>