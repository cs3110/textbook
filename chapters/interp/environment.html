

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>9.4. Environment Model &#8212; OCaml Programming: Correct + Efficient + Beautiful</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=bd9e20870c6007c4c509" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=bd9e20870c6007c4c509" />
  <script src="../../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=bd9e20870c6007c4c509"></script>

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js"></script>
    <script async="async" kind="hypothesis" src="https://hypothes.is/embed.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'chapters/interp/environment';</script>
    <link rel="shortcut icon" href="../../_static/op.png"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="9.5. Type Checking" href="typecheck.html" />
    <link rel="prev" title="9.3. Substitution Model" href="substitution.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <header>
  
    <div class="bd-header navbar navbar-expand-lg bd-navbar">
    </div>
  
  </header>

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="../../cover.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/op_title.png" class="logo__image only-light" alt="OCaml Programming: Correct + Efficient + Beautiful - Home"/>
    <script>document.write(`<img src="../../_static/op_title.png" class="logo__image only-dark" alt="OCaml Programming: Correct + Efficient + Beautiful - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Preface</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../preface/about.html">About This Book</a></li>
<li class="toctree-l1"><a class="reference internal" href="../preface/install.html">Installing OCaml</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../intro/intro.html">1. Better Programming Through OCaml</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../intro/past.html">1.1. The Past of OCaml</a></li>
<li class="toctree-l2"><a class="reference internal" href="../intro/present.html">1.2. The Present of OCaml</a></li>
<li class="toctree-l2"><a class="reference internal" href="../intro/future.html">1.3. Look to Your Future</a></li>
<li class="toctree-l2"><a class="reference internal" href="../intro/3110.html">1.4. A Brief History of CS 3110</a></li>
<li class="toctree-l2"><a class="reference internal" href="../intro/summary.html">1.5. Summary</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../basics/intro.html">2. The Basics of OCaml</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../basics/toplevel.html">2.1. The OCaml Toplevel</a></li>
<li class="toctree-l2"><a class="reference internal" href="../basics/compiling.html">2.2. Compiling OCaml Programs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../basics/expressions.html">2.3. Expressions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../basics/functions.html">2.4. Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../basics/documentation.html">2.5. Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../basics/printing.html">2.6. Printing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../basics/debugging.html">2.7. Debugging</a></li>
<li class="toctree-l2"><a class="reference internal" href="../basics/summary.html">2.8. Summary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../basics/exercises.html">2.9. Exercises</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">OCaml Programming</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../data/intro.html">3. Data and Types</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-3"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../data/lists.html">3.1. Lists</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data/variants.html">3.2. Variants</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data/ounit.html">3.3. Unit Testing with OUnit</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data/records_tuples.html">3.4. Records and Tuples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data/pattern_matching_advanced.html">3.5. Advanced Pattern Matching</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data/type_synonym.html">3.6. Type Synonyms</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data/options.html">3.7. Options</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data/assoc_list.html">3.8. Association Lists</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data/algebraic_data_types.html">3.9. Algebraic Data Types</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data/exceptions.html">3.10. Exceptions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data/trees.html">3.11. Example: Trees</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data/nats.html">3.12. Example: Natural Numbers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data/summary.html">3.13. Summary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data/exercises.html">3.14. Exercises</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../hop/intro.html">4. Higher-Order Programming</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-4"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../hop/higher_order.html">4.1. Higher-Order Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hop/map.html">4.2. Map</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hop/filter.html">4.3. Filter</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hop/fold.html">4.4. Fold</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hop/beyond_lists.html">4.5. Beyond Lists</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hop/pipelining.html">4.6. Pipelining</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hop/currying.html">4.7. Currying</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hop/summary.html">4.8. Summary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hop/exercises.html">4.9. Exercises</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../modules/intro.html">5. Modular Programming</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-5"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../modules/module_systems.html">5.1. Module Systems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/modules.html">5.2. Modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/toplevel.html">5.3. Modules and the Toplevel</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/encapsulation.html">5.4. Encapsulation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/compilation_units.html">5.5. Compilation Units</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/functional_data_structures.html">5.6. Functional Data Structures</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/module_type_constraints.html">5.7. Module Type Constraints</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/includes.html">5.8. Includes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/functors.html">5.9. Functors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/summary.html">5.10. Summary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/exercises.html">5.11. Exercises</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Correctness and Efficiency</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../correctness/intro.html">6. Correctness</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-6"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../correctness/specifications.html">6.1. Specifications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../correctness/function_docs.html">6.2. Function Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../correctness/module_docs.html">6.3. Module Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../correctness/test_debug.html">6.4. Testing and Debugging</a></li>
<li class="toctree-l2"><a class="reference internal" href="../correctness/black_glass_box.html">6.5. Black-box and Glass-box Testing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../correctness/randomized.html">6.6. Randomized Testing with QCheck</a></li>
<li class="toctree-l2"><a class="reference internal" href="../correctness/proving_correctness.html">6.7. Proving Correctness</a></li>
<li class="toctree-l2"><a class="reference internal" href="../correctness/structural_induction.html">6.8. Structural Induction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../correctness/eq_spec.html">6.9. Equational Specification</a></li>
<li class="toctree-l2"><a class="reference internal" href="../correctness/summary.html">6.10. Summary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../correctness/exercises.html">6.11. Exercises</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../mut/intro.html">7. Mutability</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-7"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../mut/refs.html">7.1. Refs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mut/mutable_fields.html">7.2. Mutable Fields</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mut/arrays.html">7.3. Arrays and Loops</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mut/summary.html">7.4. Summary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mut/exercises.html">7.5. Exercises</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../ds/intro.html">8. Data Structures</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-8"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../ds/hash_tables.html">8.1. Hash Tables</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ds/amortized.html">8.2. Amortized Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ds/rb.html">8.3. Red-Black Trees</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ds/sequence.html">8.4. Sequences</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ds/memoization.html">8.5. Memoization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ds/parrays.html">8.6. Persistent Arrays</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ds/promises.html">8.7. Promises</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ds/monads.html">8.8. Monads</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ds/summary.html">8.9. Summary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ds/exercises.html">8.10. Exercises</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Language Implementation</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active has-children"><a class="reference internal" href="intro.html">9. Interpreters</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-9"><i class="fa-solid fa-chevron-down"></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="calculator.html">9.1. Example: Calculator</a></li>
<li class="toctree-l2"><a class="reference internal" href="parsing.html">9.2. Parsing</a></li>
<li class="toctree-l2"><a class="reference internal" href="substitution.html">9.3. Substitution Model</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">9.4. Environment Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="typecheck.html">9.5. Type Checking</a></li>
<li class="toctree-l2"><a class="reference internal" href="inference.html">9.6. Type Inference</a></li>
<li class="toctree-l2"><a class="reference internal" href="summary.html">9.7. Summary</a></li>
<li class="toctree-l2"><a class="reference internal" href="exercises.html">9.8. Exercises</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Lagniappe</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../adv/curry-howard.html">The Curry-Howard Correspondence</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Appendix</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../appendix/bigoh.html">Big-Oh Notation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../appendix/vm.html">Virtual Machine</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/cs3110/textbook" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/cs3110/textbook/edit/main/src/chapters/interp/environment.md" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/cs3110/textbook/issues/new?title=Issue%20on%20page%20%2Fchapters/interp/environment.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/chapters/interp/environment.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Environment Model</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#evaluating-the-lambda-calculus-in-the-environment-model">9.4.1. Evaluating the Lambda Calculus in the Environment Model</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lexical-vs-dynamic-scope">9.4.2. Lexical vs. Dynamic Scope</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-second-attempt-at-evaluating-the-lambda-calculus-in-the-environment-model">9.4.3. A Second Attempt at Evaluating the Lambda Calculus in the Environment Model</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#an-implementation-of-the-lambda-calculus-in-the-environment-model">9.4.4. An Implementation of the Lambda Calculus in the Environment Model</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#evaluating-core-ocaml-in-the-environment-model">9.4.5. Evaluating Core OCaml in the Environment Model</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="environment-model">
<h1><span class="section-number">9.4. </span>Environment Model<a class="headerlink" href="#environment-model" title="Permalink to this heading">#</a></h1>
<div class="container16x9"><iframe src="https://www.youtube.com/embed/cYnSVZIczJE" class="responsive-iframe" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>
<p>So far we’ve been using the substitution model to evaluate programs. It’s a
great mental model for evaluation, and it’s commonly used in programming
languages theory.</p>
<p>But when it comes to implementation, the substitution model is not the best
choice. It’s too <em>eager</em>: it substitutes for every occurrence of a variable,
even if that occurrence will never be needed. For example, <code class="docutils literal notranslate"><span class="pre">let</span> <span class="pre">x</span> <span class="pre">=</span> <span class="pre">42</span> <span class="pre">in</span> <span class="pre">e</span></code>
will require crawling over all of <code class="docutils literal notranslate"><span class="pre">e</span></code>, which might be a very large expression,
even if <code class="docutils literal notranslate"><span class="pre">x</span></code> never occurs in <code class="docutils literal notranslate"><span class="pre">e</span></code>, or even if <code class="docutils literal notranslate"><span class="pre">x</span></code> occurs only inside a branch of
an if expression that never ends up being evaluated.</p>
<p>For sake of efficiency, it would be better to substitute <em>lazily</em>: only when the
value of a variable is needed should the interpreter have to do the
substitution. That’s the key idea behind the <em>environment model</em>. In this model,
there is a data structure called the <em>dynamic environment</em>, or just
“environment” for short, that is a dictionary mapping variable names to values.
Whenever the value of a variable is needed, it’s looked up in that dictionary.</p>
<p>To account for the environment, the evaluation relation needs to change. Instead
of <code class="docutils literal notranslate"><span class="pre">e</span> <span class="pre">--&gt;</span> <span class="pre">e'</span></code> or <code class="docutils literal notranslate"><span class="pre">e</span> <span class="pre">==&gt;</span> <span class="pre">v</span></code>, both of which are binary relations, we now need a
ternary relation, which is either</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;env,</span> <span class="pre">e&gt;</span> <span class="pre">--&gt;</span> <span class="pre">e'</span></code>, or</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;env,</span> <span class="pre">e&gt;</span> <span class="pre">==&gt;</span> <span class="pre">v</span></code>,</p></li>
</ul>
<p>where <code class="docutils literal notranslate"><span class="pre">env</span></code> denotes the environment, and <code class="docutils literal notranslate"><span class="pre">&lt;env,</span> <span class="pre">e&gt;</span></code> is called a <em>machine
configuration</em>. That configuration represents the state of the computer as it
evaluates a program: <code class="docutils literal notranslate"><span class="pre">env</span></code> represents a part of the computer’s memory (the
binding of variables to values), and <code class="docutils literal notranslate"><span class="pre">e</span></code> represents the program.</p>
<p>As notation, let:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">{}</span></code> represent the empty environment,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">{x1:v1,</span> <span class="pre">x2:v2,</span> <span class="pre">...}</span></code> represent the environment that binds <code class="docutils literal notranslate"><span class="pre">x1</span></code> to <code class="docutils literal notranslate"><span class="pre">v1</span></code>, etc.,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">env[x</span> <span class="pre">-&gt;</span> <span class="pre">v]</span></code> represent the environment <code class="docutils literal notranslate"><span class="pre">env</span></code> with the variable <code class="docutils literal notranslate"><span class="pre">x</span></code>
additionally bound to the value <code class="docutils literal notranslate"><span class="pre">v</span></code>, and</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">env(x)</span></code> represent the binding of <code class="docutils literal notranslate"><span class="pre">x</span></code> in <code class="docutils literal notranslate"><span class="pre">env</span></code>.</p></li>
</ul>
<p>If we wanted a more mathematical notation we would write <span class="math notranslate nohighlight">\(\mapsto\)</span> instead of
<code class="docutils literal notranslate"><span class="pre">-&gt;</span></code> in <code class="docutils literal notranslate"><span class="pre">env[x</span> <span class="pre">-&gt;</span> <span class="pre">v]</span></code>, but we’re aiming for notation that is easily typed on a
standard keyboard.</p>
<p>We’ll concentrate in the rest of this chapter on the big-step version of the
environment model. It would of course be possible to define a small-step
version, too.</p>
<div class="container16x9"><iframe src="https://www.youtube.com/embed/93CN7gV_G2w" class="responsive-iframe" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>
<div class="container16x9"><iframe src="https://www.youtube.com/embed/YZO-vQohBYA" class="responsive-iframe" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>
<section id="evaluating-the-lambda-calculus-in-the-environment-model">
<h2><span class="section-number">9.4.1. </span>Evaluating the Lambda Calculus in the Environment Model<a class="headerlink" href="#evaluating-the-lambda-calculus-in-the-environment-model" title="Permalink to this heading">#</a></h2>
<div class="container16x9"><iframe src="https://www.youtube.com/embed/l0Db3KW5X_U" class="responsive-iframe" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>
<p>Recall that the lambda calculus is the fragment of a functional language
involving functions and application:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>e ::= x | e1 e2 | fun x -&gt; e

v ::= fun x -&gt; e
</pre></div>
</div>
<p>Let’s explore how to define a big-step evaluation relation for the lambda
calculus in the environment model. The rule for variables just says to look up
the variable name in the environment:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>&lt;env, x&gt; ==&gt; env(x)
</pre></div>
</div>
<p>This rule for functions says that an anonymous function evaluates
just to itself.  After all, functions are values:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>&lt;env, fun x -&gt; e&gt; ==&gt; fun x -&gt; e
</pre></div>
</div>
<p>Finally, this rule for application says to evaluate the left-hand side <code class="docutils literal notranslate"><span class="pre">e1</span></code> to a
function <code class="docutils literal notranslate"><span class="pre">fun</span> <span class="pre">x</span> <span class="pre">-&gt;</span> <span class="pre">e</span></code>, the right-hand side to a value <code class="docutils literal notranslate"><span class="pre">v2</span></code>, then to evaluate the
body <code class="docutils literal notranslate"><span class="pre">e</span></code> of the function in an extended environment that maps the function’s
argument <code class="docutils literal notranslate"><span class="pre">x</span></code> to <code class="docutils literal notranslate"><span class="pre">v2</span></code>:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>&lt;env, e1 e2&gt; ==&gt; v
  if &lt;env, e1&gt; ==&gt; fun x -&gt; e
  and &lt;env, e2&gt; ==&gt; v2
  and &lt;env[x -&gt; v2], e&gt; ==&gt; v
</pre></div>
</div>
<p>Seems reasonable, right? The problem is, <strong>it’s wrong.</strong> At least, it’s wrong if
you want evaluation to behave the same as OCaml. Or, to be honest, nearly any
other modern language.</p>
<p>It will be easier to explain why it’s wrong if we add two more language
features: let expressions and integer constants. Integer constants would
evaluate to themselves:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>&lt;env, i&gt; ==&gt; i
</pre></div>
</div>
<p>As for let expressions, recall that we don’t actually <em>need</em> them,
because <code class="docutils literal notranslate"><span class="pre">let</span> <span class="pre">x</span> <span class="pre">=</span> <span class="pre">e1</span> <span class="pre">in</span> <span class="pre">e2</span></code> can be rewritten as <code class="docutils literal notranslate"><span class="pre">(fun</span> <span class="pre">x</span> <span class="pre">-&gt;</span> <span class="pre">e2)</span> <span class="pre">e1</span></code>.
Nonetheless, their semantics would be:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>&lt;env, let x = e1 in e2&gt; ==&gt; v
  if &lt;env, e1&gt; ==&gt; v1
  and &lt;env[x -&gt; v1], e2&gt; ==&gt; v
</pre></div>
</div>
<p>Which is a rule that really just follows from the other rules above, using that
rewriting.</p>
<p>What would this expression evaluate to?</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>let x = 1 in
let f = fun y -&gt; x in
let x = 2 in
f 0
</pre></div>
</div>
<p>According to our semantics thus far, it would evaluate as follows:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">let</span> <span class="pre">x</span> <span class="pre">=</span> <span class="pre">1</span></code> would produce the environment <code class="docutils literal notranslate"><span class="pre">{x:1}</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">let</span> <span class="pre">f</span> <span class="pre">=</span> <span class="pre">fun</span> <span class="pre">y</span> <span class="pre">-&gt;</span> <span class="pre">x</span></code> would produce the environment <code class="docutils literal notranslate"><span class="pre">{x:1,</span> <span class="pre">f:(fun</span> <span class="pre">y</span> <span class="pre">-&gt;</span> <span class="pre">x)}</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">let</span> <span class="pre">x</span> <span class="pre">=</span> <span class="pre">2</span></code> would produce the environment <code class="docutils literal notranslate"><span class="pre">{x:2,</span> <span class="pre">f:(fun</span> <span class="pre">y</span> <span class="pre">-&gt;</span> <span class="pre">x)}</span></code>. Note how
the binding of <code class="docutils literal notranslate"><span class="pre">x</span></code> to <code class="docutils literal notranslate"><span class="pre">1</span></code> is shadowed by the new binding.</p></li>
<li><p>Now we would evaluate <code class="docutils literal notranslate"><span class="pre">&lt;{x:2,</span> <span class="pre">f:(fun</span> <span class="pre">y</span> <span class="pre">-&gt;</span> <span class="pre">x)},</span> <span class="pre">f</span> <span class="pre">0&gt;</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="p">{</span><span class="n">x</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="n">f</span><span class="p">:(</span><span class="n">fun</span> <span class="n">y</span> <span class="o">-&gt;</span> <span class="n">x</span><span class="p">)},</span> <span class="n">f</span> <span class="mi">0</span><span class="o">&gt;</span> <span class="o">==&gt;</span> <span class="mi">2</span>
  <span class="n">because</span> <span class="o">&lt;</span><span class="p">{</span><span class="n">x</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="n">f</span><span class="p">:(</span><span class="n">fun</span> <span class="n">y</span> <span class="o">-&gt;</span> <span class="n">x</span><span class="p">)},</span> <span class="n">f</span><span class="o">&gt;</span> <span class="o">==&gt;</span> <span class="n">fun</span> <span class="n">y</span> <span class="o">-&gt;</span> <span class="n">x</span>
  <span class="ow">and</span> <span class="o">&lt;</span><span class="p">{</span><span class="n">x</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="n">f</span><span class="p">:(</span><span class="n">fun</span> <span class="n">y</span> <span class="o">-&gt;</span> <span class="n">x</span><span class="p">)},</span> <span class="mi">0</span><span class="o">&gt;</span> <span class="o">==&gt;</span> <span class="mi">0</span>
  <span class="ow">and</span> <span class="o">&lt;</span><span class="p">{</span><span class="n">x</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="n">f</span><span class="p">:(</span><span class="n">fun</span> <span class="n">y</span> <span class="o">-&gt;</span> <span class="n">x</span><span class="p">)}[</span><span class="n">y</span> <span class="o">-&gt;</span> <span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="o">&gt;</span> <span class="o">==&gt;</span> <span class="mi">2</span>
    <span class="n">because</span> <span class="o">&lt;</span><span class="p">{</span><span class="n">x</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="n">f</span><span class="p">:(</span><span class="n">fun</span> <span class="n">y</span> <span class="o">-&gt;</span> <span class="n">x</span><span class="p">),</span> <span class="n">y</span><span class="p">:</span><span class="mi">0</span><span class="p">},</span> <span class="n">x</span><span class="o">&gt;</span> <span class="o">==&gt;</span> <span class="mi">2</span>
</pre></div>
</div>
</li>
<li><p>The result is therefore <code class="docutils literal notranslate"><span class="pre">2</span></code>.</p></li>
</ul>
<p>But according to utop (and the substitution model), it evaluates as follows:</p>
<div class="highlight-ocaml notranslate"><div class="highlight"><pre><span></span><span class="o">#</span> <span class="k">let</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">f</span> <span class="o">=</span> <span class="k">fun</span> <span class="n">y</span> <span class="o">-&gt;</span> <span class="n">x</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">in</span>
  <span class="n">f</span> <span class="mi">0</span><span class="o">;;</span>
<span class="o">-</span> <span class="o">:</span> <span class="kt">int</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>
</div>
<p>And the result is therefore <code class="docutils literal notranslate"><span class="pre">1</span></code>. Obviously, <code class="docutils literal notranslate"><span class="pre">1</span></code> and <code class="docutils literal notranslate"><span class="pre">2</span></code> are different answers!</p>
<p>What went wrong??  It has to do with scope.</p>
</section>
<section id="lexical-vs-dynamic-scope">
<h2><span class="section-number">9.4.2. </span>Lexical vs. Dynamic Scope<a class="headerlink" href="#lexical-vs-dynamic-scope" title="Permalink to this heading">#</a></h2>
<div class="container16x9"><iframe src="https://www.youtube.com/embed/s9kiXx0cSb4" class="responsive-iframe" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>
<p>There are two different ways to understand the scope of a variable: variables
can be <em>dynamically</em> scoped or <em>lexically</em> scoped. It all comes down to the
environment that is used when a function body is being evaluated:</p>
<ul class="simple">
<li><p>With the <strong>rule of dynamic scope</strong>, the body of a function is evaluated in the
current dynamic environment at the time the function is applied, not the old
dynamic environment that existed at the time the function was defined.</p></li>
<li><p>With the <strong>rule of lexical scope</strong>, the body of a function is evaluated in the
old dynamic environment that existed at the time the function was defined, not
the current environment when the function is applied.</p></li>
</ul>
<p>The rule of dynamic scope is what our semantics, above, implemented. Let’s look
back at the semantics of function application:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>&lt;env, e1 e2&gt; ==&gt; v
  if &lt;env, e1&gt; ==&gt; fun x -&gt; e
  and &lt;env, e2&gt; ==&gt; v2
  and &lt;env[x -&gt; v2], e&gt; ==&gt; v
</pre></div>
</div>
<p>Note how the body <code class="docutils literal notranslate"><span class="pre">e</span></code> is being evaluated in the same environment <code class="docutils literal notranslate"><span class="pre">env</span></code>
as when the function is applied.  In the example program</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>let x = 1 in
let f = fun y -&gt; x in
let x = 2 in
f 0
</pre></div>
</div>
<p>that means that <code class="docutils literal notranslate"><span class="pre">f</span></code> is evaluated in an environment in which <code class="docutils literal notranslate"><span class="pre">x</span></code> is bound to <code class="docutils literal notranslate"><span class="pre">2</span></code>,
because that’s the most recent binding of <code class="docutils literal notranslate"><span class="pre">x</span></code>.</p>
<p>But OCaml implements the rule of lexical scope, which coincides with the
substitution model. With that rule, <code class="docutils literal notranslate"><span class="pre">x</span></code> is bound to <code class="docutils literal notranslate"><span class="pre">1</span></code> in the body of <code class="docutils literal notranslate"><span class="pre">f</span></code> when
<code class="docutils literal notranslate"><span class="pre">f</span></code> is defined, and the later binding of <code class="docutils literal notranslate"><span class="pre">x</span></code> to <code class="docutils literal notranslate"><span class="pre">2</span></code> doesn’t change that fact.</p>
<p>The consensus after decades of experience with programming language design is
that lexical scope is the right choice. Perhaps the main reason for that is that
lexical scope supports the Principle of Name Irrelevance. Recall, that principle
says that the name of a variable shouldn’t matter to the meaning of program, as
long as the name is used consistently.</p>
<p>Nonetheless, dynamic scope is useful in some situations. Some languages use it
as the norm (e.g., Emacs LISP, LaTeX), and some languages have special ways to
do it (e.g., Perl, Racket). But these days, most languages just don’t have it.</p>
<p>There is one language feature that modern languages <em>do</em> have that resembles
dynamic scope, and that is exceptions. Exception handling resembles dynamic
scope, in that raising an exception transfers control to the “most recent”
exception handler, just like how dynamic scope uses the “most recent” binding of
variable.</p>
</section>
<section id="a-second-attempt-at-evaluating-the-lambda-calculus-in-the-environment-model">
<h2><span class="section-number">9.4.3. </span>A Second Attempt at Evaluating the Lambda Calculus in the Environment Model<a class="headerlink" href="#a-second-attempt-at-evaluating-the-lambda-calculus-in-the-environment-model" title="Permalink to this heading">#</a></h2>
<div class="container16x9"><iframe src="https://www.youtube.com/embed/Y0V_92x5J-Q" class="responsive-iframe" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>
<p>The question then becomes, how do we implement lexical scope? It seems to
require time travel, because function bodies need to be evaluated in old dynamic
environment that have long since disappeared.</p>
<p>The answer is that the language implementation must arrange to keep old
environments around. And that is indeed what OCaml and other languages must do.
They use a data structure called a <em>closure</em> for this purpose.</p>
<p>A closure has two parts:</p>
<ul class="simple">
<li><p>a <em>code</em> part, which contains a function <code class="docutils literal notranslate"><span class="pre">fun</span> <span class="pre">x</span> <span class="pre">-&gt;</span> <span class="pre">e</span></code>, and</p></li>
<li><p>an <em>environment</em> part, which contains the environment <code class="docutils literal notranslate"><span class="pre">env</span></code> at the time that
function was defined.</p></li>
</ul>
<p>You can think of a closure as being like a pair, except that there’s no way to
directly write a closure in OCaml source code, and there’s no way to destruct
the pair into its components in OCaml source code. The pair is entirely hidden
from you by the language implementation.</p>
<p>Let’s notate a closure as <code class="docutils literal notranslate"><span class="pre">(|</span> <span class="pre">fun</span> <span class="pre">x</span> <span class="pre">-&gt;</span> <span class="pre">e,</span> <span class="pre">env</span> <span class="pre">|)</span></code>. The delimiters <code class="docutils literal notranslate"><span class="pre">(|</span> <span class="pre">...</span> <span class="pre">|)</span></code>
are meant to evoke an OCaml pair, but of course they are not legal OCaml syntax.</p>
<p>Using that notation, we can re-define the evaluation relation as follows:</p>
<p>The rule for functions now says that an anonymous function evaluates to a
closure:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>&lt;env, fun x -&gt; e&gt; ==&gt; (| fun x -&gt; e, env |)
</pre></div>
</div>
<p>That rule saves the defining environment as part of the closure, so that it can
be used at some future point.</p>
<p>The rule for application says to use that closure:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>&lt;env, e1 e2&gt; ==&gt; v
  if &lt;env, e1&gt; ==&gt; (| fun x -&gt; e, defenv |)
  and &lt;env, e2&gt; ==&gt; v2
  and &lt;defenv[x -&gt; v2], e&gt; ==&gt; v
</pre></div>
</div>
<p>That rule uses the closure’s environment <code class="docutils literal notranslate"><span class="pre">defenv</span></code> (whose name is meant to
suggest the “defining environment”) to evaluate the function body <code class="docutils literal notranslate"><span class="pre">e</span></code>.</p>
<p>The derived rule for let expressions remains unchanged:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>&lt;env, let x = e1 in e2&gt; ==&gt; v
  if &lt;env, e1&gt; ==&gt; v1
  and &lt;env[x -&gt; v1], e2&gt; ==&gt; v
</pre></div>
</div>
<p>That’s because the defining environment for the body <code class="docutils literal notranslate"><span class="pre">e2</span></code> is the same as the
current environment <code class="docutils literal notranslate"><span class="pre">env</span></code> when the let expression is being evaluated.</p>
</section>
<section id="an-implementation-of-the-lambda-calculus-in-the-environment-model">
<h2><span class="section-number">9.4.4. </span>An Implementation of the Lambda Calculus in the Environment Model<a class="headerlink" href="#an-implementation-of-the-lambda-calculus-in-the-environment-model" title="Permalink to this heading">#</a></h2>
<p>You can download a complete implementation of the above two lambda calculus semantics:
<a href="../../code/lambda-env.zip">lambda-env.zip</a>. In <code class="docutils literal notranslate"><span class="pre">main.ml</span></code>, there is a
definition named <code class="docutils literal notranslate"><span class="pre">scope</span></code> that you can use to switch between lexical and dynamic
scope.</p>
</section>
<section id="evaluating-core-ocaml-in-the-environment-model">
<h2><span class="section-number">9.4.5. </span>Evaluating Core OCaml in the Environment Model<a class="headerlink" href="#evaluating-core-ocaml-in-the-environment-model" title="Permalink to this heading">#</a></h2>
<div class="container16x9"><iframe src="https://www.youtube.com/embed/z2ktAgYTCRw" class="responsive-iframe" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>
<p>There isn’t anything new in the (big step) environment model semantics of Core
OCaml, now that we know about closures, but for sake of completeness let’s state
it anyway.</p>
<p><strong>Syntax.</strong></p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>e ::= x | e1 e2 | fun x -&gt; e
    | i | b | e1 bop e2
    | (e1,e2) | fst e1 | snd e2
    | Left e | Right e
    | match e with Left x1 -&gt; e1 | Right x2 -&gt; e2
    | if e1 then e2 else e3
    | let x = e1 in e2
</pre></div>
</div>
<p><strong>Semantics.</strong></p>
<p>We’ve already seen the semantics of the lambda calculus fragment of Core OCaml:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>&lt;env, x&gt; ==&gt; v
  if env(x) = v

&lt;env, e1 e2&gt; ==&gt; v
  if  &lt;env, e1&gt; ==&gt; (| fun x -&gt; e, defenv |)
  and &lt;env, e2&gt; ==&gt; v2
  and &lt;defenv[x -&gt; v2], e&gt; ==&gt; v

&lt;env, fun x -&gt; e&gt; ==&gt; (|fun x -&gt; e, env|)
</pre></div>
</div>
<p>Evaluation of constants ignores the environment:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>&lt;env, i&gt; ==&gt; i

&lt;env, b&gt; ==&gt; b
</pre></div>
</div>
<p>Evaluation of most other language features just uses the environment without
changing it:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>&lt;env, e1 bop e2&gt; ==&gt; v
  if  &lt;env, e1&gt; ==&gt; v1
  and &lt;env, e2&gt; ==&gt; v2
  and v is the result of applying the primitive operation bop to v1 and v2

&lt;env, (e1, e2)&gt; ==&gt; (v1, v2)
  if  &lt;env, e1&gt; ==&gt; v1
  and &lt;env, e2&gt; ==&gt; v2

&lt;env, fst e&gt; ==&gt; v1
  if &lt;env, e&gt; ==&gt; (v1, v2)

&lt;env, snd e&gt; ==&gt; v2
  if &lt;env, e&gt; ==&gt; (v1, v2)

&lt;env, Left e&gt; ==&gt; Left v
  if &lt;env, e&gt; ==&gt; v

&lt;env, Right e&gt; ==&gt; Right v
  if &lt;env, e&gt; ==&gt; v

&lt;env, if e1 then e2 else e3&gt; ==&gt; v2
  if &lt;env, e1&gt; ==&gt; true
  and &lt;env, e2&gt; ==&gt; v2

&lt;env, if e1 then e2 else e3&gt; ==&gt; v3
  if &lt;env, e1&gt; ==&gt; false
  and &lt;env, e3&gt; ==&gt; v3
</pre></div>
</div>
<p>Finally, evaluation of binding constructs (i.e., match
and let expression) extends the environment with a new binding:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>&lt;env, match e with Left x1 -&gt; e1 | Right x2 -&gt; e2&gt; ==&gt; v1
  if  &lt;env, e&gt; ==&gt; Left v
  and &lt;env[x1 -&gt; v], e1&gt; ==&gt; v1

&lt;env, match e with Left x1 -&gt; e1 | Right x2 -&gt; e2&gt; ==&gt; v2
  if  &lt;env, e&gt; ==&gt; Right v
  and &lt;env[x2 -&gt; v], e2&gt; ==&gt; v2

&lt;env, let x = e1 in e2&gt; ==&gt; v2
  if  &lt;env, e1&gt; ==&gt; v1
  and &lt;env[x -&gt; v1], e2&gt; ==&gt; v2
</pre></div>
</div>
<div class="container16x9"><iframe src="https://www.youtube.com/embed/VZTrEYb6PPk" class="responsive-iframe" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "cs3110/textbook",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./chapters/interp"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="substitution.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title"><span class="section-number">9.3. </span>Substitution Model</p>
      </div>
    </a>
    <a class="right-next"
       href="typecheck.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">9.5. </span>Type Checking</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#evaluating-the-lambda-calculus-in-the-environment-model">9.4.1. Evaluating the Lambda Calculus in the Environment Model</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lexical-vs-dynamic-scope">9.4.2. Lexical vs. Dynamic Scope</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-second-attempt-at-evaluating-the-lambda-calculus-in-the-environment-model">9.4.3. A Second Attempt at Evaluating the Lambda Calculus in the Environment Model</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#an-implementation-of-the-lambda-calculus-in-the-environment-model">9.4.4. An Implementation of the Lambda Calculus in the Environment Model</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#evaluating-core-ocaml-in-the-environment-model">9.4.5. Evaluating Core OCaml in the Environment Model</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Michael R. Clarkson et al.
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=bd9e20870c6007c4c509"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=bd9e20870c6007c4c509"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>