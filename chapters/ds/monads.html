

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>8.8. Monads &#8212; OCaml Programming: Correct + Efficient + Beautiful</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=bd9e20870c6007c4c509" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=bd9e20870c6007c4c509" />
  <script src="../../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=bd9e20870c6007c4c509"></script>

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js"></script>
    <script async="async" kind="hypothesis" src="https://hypothes.is/embed.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'chapters/ds/monads';</script>
    <link rel="shortcut icon" href="../../_static/op.png"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="8.9. Summary" href="summary.html" />
    <link rel="prev" title="8.7. Promises" href="promises.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <header>
  
    <div class="bd-header navbar navbar-expand-lg bd-navbar">
    </div>
  
  </header>

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="../../cover.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/op_title.png" class="logo__image only-light" alt="OCaml Programming: Correct + Efficient + Beautiful - Home"/>
    <script>document.write(`<img src="../../_static/op_title.png" class="logo__image only-dark" alt="OCaml Programming: Correct + Efficient + Beautiful - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Preface</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../preface/about.html">About This Book</a></li>
<li class="toctree-l1"><a class="reference internal" href="../preface/install.html">Installing OCaml</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../intro/intro.html">1. Better Programming Through OCaml</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../intro/past.html">1.1. The Past of OCaml</a></li>
<li class="toctree-l2"><a class="reference internal" href="../intro/present.html">1.2. The Present of OCaml</a></li>
<li class="toctree-l2"><a class="reference internal" href="../intro/future.html">1.3. Look to Your Future</a></li>
<li class="toctree-l2"><a class="reference internal" href="../intro/3110.html">1.4. A Brief History of CS 3110</a></li>
<li class="toctree-l2"><a class="reference internal" href="../intro/summary.html">1.5. Summary</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../basics/intro.html">2. The Basics of OCaml</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../basics/toplevel.html">2.1. The OCaml Toplevel</a></li>
<li class="toctree-l2"><a class="reference internal" href="../basics/compiling.html">2.2. Compiling OCaml Programs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../basics/expressions.html">2.3. Expressions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../basics/functions.html">2.4. Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../basics/documentation.html">2.5. Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../basics/printing.html">2.6. Printing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../basics/debugging.html">2.7. Debugging</a></li>
<li class="toctree-l2"><a class="reference internal" href="../basics/summary.html">2.8. Summary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../basics/exercises.html">2.9. Exercises</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">OCaml Programming</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../data/intro.html">3. Data and Types</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-3"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../data/lists.html">3.1. Lists</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data/variants.html">3.2. Variants</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data/ounit.html">3.3. Unit Testing with OUnit</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data/records_tuples.html">3.4. Records and Tuples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data/pattern_matching_advanced.html">3.5. Advanced Pattern Matching</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data/type_synonym.html">3.6. Type Synonyms</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data/options.html">3.7. Options</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data/assoc_list.html">3.8. Association Lists</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data/algebraic_data_types.html">3.9. Algebraic Data Types</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data/exceptions.html">3.10. Exceptions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data/trees.html">3.11. Example: Trees</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data/nats.html">3.12. Example: Natural Numbers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data/summary.html">3.13. Summary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data/exercises.html">3.14. Exercises</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../hop/intro.html">4. Higher-Order Programming</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-4"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../hop/higher_order.html">4.1. Higher-Order Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hop/map.html">4.2. Map</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hop/filter.html">4.3. Filter</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hop/fold.html">4.4. Fold</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hop/beyond_lists.html">4.5. Beyond Lists</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hop/pipelining.html">4.6. Pipelining</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hop/currying.html">4.7. Currying</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hop/summary.html">4.8. Summary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hop/exercises.html">4.9. Exercises</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../modules/intro.html">5. Modular Programming</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-5"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../modules/module_systems.html">5.1. Module Systems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/modules.html">5.2. Modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/toplevel.html">5.3. Modules and the Toplevel</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/encapsulation.html">5.4. Encapsulation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/compilation_units.html">5.5. Compilation Units</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/functional_data_structures.html">5.6. Functional Data Structures</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/module_type_constraints.html">5.7. Module Type Constraints</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/includes.html">5.8. Includes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/functors.html">5.9. Functors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/summary.html">5.10. Summary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/exercises.html">5.11. Exercises</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Correctness and Efficiency</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../correctness/intro.html">6. Correctness</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-6"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../correctness/specifications.html">6.1. Specifications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../correctness/function_docs.html">6.2. Function Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../correctness/module_docs.html">6.3. Module Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../correctness/test_debug.html">6.4. Testing and Debugging</a></li>
<li class="toctree-l2"><a class="reference internal" href="../correctness/black_glass_box.html">6.5. Black-box and Glass-box Testing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../correctness/randomized.html">6.6. Randomized Testing with QCheck</a></li>
<li class="toctree-l2"><a class="reference internal" href="../correctness/proving_correctness.html">6.7. Proving Correctness</a></li>
<li class="toctree-l2"><a class="reference internal" href="../correctness/structural_induction.html">6.8. Structural Induction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../correctness/eq_spec.html">6.9. Equational Specification</a></li>
<li class="toctree-l2"><a class="reference internal" href="../correctness/summary.html">6.10. Summary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../correctness/exercises.html">6.11. Exercises</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../mut/intro.html">7. Mutability</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-7"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../mut/refs.html">7.1. Refs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mut/mutable_fields.html">7.2. Mutable Fields</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mut/arrays.html">7.3. Arrays and Loops</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mut/summary.html">7.4. Summary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mut/exercises.html">7.5. Exercises</a></li>
</ul>
</li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="intro.html">8. Data Structures</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-8"><i class="fa-solid fa-chevron-down"></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="hash_tables.html">8.1. Hash Tables</a></li>
<li class="toctree-l2"><a class="reference internal" href="amortized.html">8.2. Amortized Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="rb.html">8.3. Red-Black Trees</a></li>
<li class="toctree-l2"><a class="reference internal" href="sequence.html">8.4. Sequences</a></li>
<li class="toctree-l2"><a class="reference internal" href="memoization.html">8.5. Memoization</a></li>
<li class="toctree-l2"><a class="reference internal" href="parrays.html">8.6. Persistent Arrays</a></li>
<li class="toctree-l2"><a class="reference internal" href="promises.html">8.7. Promises</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">8.8. Monads</a></li>
<li class="toctree-l2"><a class="reference internal" href="summary.html">8.9. Summary</a></li>
<li class="toctree-l2"><a class="reference internal" href="exercises.html">8.10. Exercises</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Language Implementation</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../interp/intro.html">9. Interpreters</a><input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-9"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../interp/calculator.html">9.1. Example: Calculator</a></li>
<li class="toctree-l2"><a class="reference internal" href="../interp/parsing.html">9.2. Parsing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../interp/substitution.html">9.3. Substitution Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../interp/environment.html">9.4. Environment Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../interp/typecheck.html">9.5. Type Checking</a></li>
<li class="toctree-l2"><a class="reference internal" href="../interp/inference.html">9.6. Type Inference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../interp/summary.html">9.7. Summary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../interp/exercises.html">9.8. Exercises</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Lagniappe</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../adv/curry-howard.html">The Curry-Howard Correspondence</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Appendix</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../appendix/bigoh.html">Big-Oh Notation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../appendix/vm.html">Virtual Machine</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/cs3110/textbook/main?urlpath=tree/src/chapters/ds/monads.md" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onBinder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../../_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="initThebeSBT()"
  class="btn btn-sm btn-launch-thebe dropdown-item"
  title="Launch Thebe"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="btn__text-container">Live Code</span>
</button>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/cs3110/textbook" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/cs3110/textbook/edit/main/src/chapters/ds/monads.md" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/cs3110/textbook/issues/new?title=Issue%20on%20page%20%2Fchapters/ds/monads.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/chapters/ds/monads.ipynb" target="_blank"
   class="btn btn-sm btn-download-notebook-button dropdown-item"
   title="Download notebook file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-code"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li><a href="../../_sources/chapters/ds/monads.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Monads</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-monad-signature">8.8.1. The Monad Signature</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-maybe-monad">8.8.2. The Maybe Monad</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#example-the-writer-monad">8.8.3. Example: The Writer Monad</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#example-the-lwt-monad">8.8.4. Example: The Lwt Monad</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#monad-laws">8.8.5. Monad Laws</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#composition-and-monad-laws">8.8.6. Composition and Monad Laws</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="monads">
<h1><span class="section-number">8.8. </span>Monads<a class="headerlink" href="#monads" title="Permalink to this heading">#</a></h1>
<p>A <em>monad</em> is more of a design pattern than a data structure. That is, there are
many data structures that, if you look at them in the right way, turn out to be
monads.</p>
<p>The name “monad” comes from the mathematical field of <em>category theory</em>, which
studies abstractions of mathematical structures. If you ever take a PhD level
class on programming language theory, you will likely encounter that idea in
more detail. Here, though, we will omit most of the mathematical theory and
concentrate on code.</p>
<p>Monads became popular in the programming world through their use in Haskell, a
functional programming language that is even more pure than OCaml—that is,
Haskell avoids side effects and imperative features even more than OCaml. But no
practical language can do without side effects. After all, printing to the
screen is a side effect. So Haskell set out to control the use of side effects
through the monad design pattern. Since then, monads have become recognized as
useful in other functional programming languages, and are even starting to
appear in imperative languages.</p>
<p>Monads are used to model <em>computations</em>. Think of a computation as being like a
function, which maps an input to an output, but as also doing “something more.”
The something more is an effect that the function has as a result of being
computed. For example, the effect might involve printing to the screen. Monads
provide an abstraction of effects, and help to make sure that effects happen in
a controlled order.</p>
<section id="the-monad-signature">
<h2><span class="section-number">8.8.1. </span>The Monad Signature<a class="headerlink" href="#the-monad-signature" title="Permalink to this heading">#</a></h2>
<p>For our purposes, a monad is a structure that satisfies two properties. First,
it must match the following signature:</p>
<div class="cell tag_hide-output docutils container">
<div class="cell_input above-output-prompt docutils container">
<div class="highlight-OCaml notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="k">type</span> <span class="nc">Monad</span> <span class="o">=</span> <span class="k">sig</span>
  <span class="k">type</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span>
  <span class="k">val</span> <span class="n">return</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span>
  <span class="k">val</span> <span class="n">bind</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="k">&#39;</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">b</span> <span class="n">t</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">b</span> <span class="n">t</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<details class="hide below-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell output</span>
<span class="expanded">Hide code cell output</span>
</summary>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>module type Monad =
  sig
    type &#39;a t
    val return : &#39;a -&gt; &#39;a t
    val bind : &#39;a t -&gt; (&#39;a -&gt; &#39;b t) -&gt; &#39;b t
  end
</pre></div>
</div>
</div>
</details>
</div>
<p>Second, a monad must obey what are called the <em>monad laws</em>. We will return to
those much later, after we have studied the <code class="docutils literal notranslate"><span class="pre">return</span></code> and <code class="docutils literal notranslate"><span class="pre">bind</span></code> operations.</p>
<p>Think of a monad as being like a box that contains some value. The value has
type <code class="docutils literal notranslate"><span class="pre">'a</span></code>, and the box that contains it is of type <code class="docutils literal notranslate"><span class="pre">'a</span> <span class="pre">t</span></code>. We have previously
used a similar box metaphor for both options and promises. That was no accident:
options and promises are both examples of monads, as we will see in detail,
below.</p>
<p><strong>Return.</strong> The <code class="docutils literal notranslate"><span class="pre">return</span></code> operation metaphorically puts a value into a box. You
can see that in its type: the input is of type <code class="docutils literal notranslate"><span class="pre">'a</span></code>, and the output is of type
<code class="docutils literal notranslate"><span class="pre">'a</span> <span class="pre">t</span></code>.</p>
<p>In terms of computations, <code class="docutils literal notranslate"><span class="pre">return</span></code> is intended to have some kind of trivial
effect. For example, if the monad represents computations whose side effect is
printing to the screen, the trivial effect would be to not print anything.</p>
<p><strong>Bind.</strong> The <code class="docutils literal notranslate"><span class="pre">bind</span></code> operation metaphorically takes as input:</p>
<ul class="simple">
<li><p>a boxed value, which has type <code class="docutils literal notranslate"><span class="pre">'a</span> <span class="pre">t</span></code>, and</p></li>
<li><p>a function that itself takes an <em>unboxed</em> value of type <code class="docutils literal notranslate"><span class="pre">'a</span></code> as input and
returns a <em>boxed</em> value of type <code class="docutils literal notranslate"><span class="pre">'b</span> <span class="pre">t</span></code> as output.</p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">bind</span></code> applies its second argument to the first. That requires taking the
<code class="docutils literal notranslate"><span class="pre">'a</span></code> value out of its box, applying the function to it, and returning the
result.</p>
<p>In terms of computations, <code class="docutils literal notranslate"><span class="pre">bind</span></code> is intended to sequence effects one after
another. Continuing the running example of printing, sequencing would mean first
printing one string, then another, and <code class="docutils literal notranslate"><span class="pre">bind</span></code> would be making sure that the
printing happens in the correct order.</p>
<p>The usual notation for <code class="docutils literal notranslate"><span class="pre">bind</span></code> is as an infix operator written <code class="docutils literal notranslate"><span class="pre">&gt;&gt;=</span></code> and still
pronounced “bind”. So let’s revise our signature for monads:</p>
<div class="cell tag_hide-output docutils container">
<div class="cell_input above-output-prompt docutils container">
<div class="highlight-OCaml notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="k">type</span> <span class="nc">Monad</span> <span class="o">=</span> <span class="k">sig</span>
  <span class="k">type</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span>
  <span class="k">val</span> <span class="n">return</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span>
  <span class="k">val</span> <span class="o">(</span> <span class="o">&gt;&gt;=</span> <span class="o">)</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="k">&#39;</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">b</span> <span class="n">t</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">b</span> <span class="n">t</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<details class="hide below-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell output</span>
<span class="expanded">Hide code cell output</span>
</summary>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>module type Monad =
  sig
    type &#39;a t
    val return : &#39;a -&gt; &#39;a t
    val ( &gt;&gt;= ) : &#39;a t -&gt; (&#39;a -&gt; &#39;b t) -&gt; &#39;b t
  end
</pre></div>
</div>
</div>
</details>
</div>
<p>All of the above is likely to feel very abstract upon first reading. It will
help to see some concrete examples of monads. Once you understand several <code class="docutils literal notranslate"><span class="pre">&gt;&gt;=</span></code>
and <code class="docutils literal notranslate"><span class="pre">return</span></code> operations, the design pattern itself should make more sense.</p>
<p>So the next few sections look at several different examples of code in which
monads can be discovered. Because monads are a design pattern, they aren’t
always obvious; it can take some study to tease out where the monad operations
are being used.</p>
</section>
<section id="the-maybe-monad">
<h2><span class="section-number">8.8.2. </span>The Maybe Monad<a class="headerlink" href="#the-maybe-monad" title="Permalink to this heading">#</a></h2>
<p>As we’ve seen before, sometimes functions are partial: there is no good output
they can produce for some inputs. For example, the function
<code class="docutils literal notranslate"><span class="pre">max_list</span> <span class="pre">:</span> <span class="pre">int</span> <span class="pre">list</span> <span class="pre">-&gt;</span> <span class="pre">int</span></code> doesn’t necessarily have a good output value to
return for the empty list. One possibility is to raise an exception. Another
possibility is to change the return type to be <code class="docutils literal notranslate"><span class="pre">int</span> <span class="pre">option</span></code>, and use <code class="docutils literal notranslate"><span class="pre">None</span></code> to
represent the function’s inability to produce an output. In other words, <em>maybe</em>
the function produces an output, or <em>maybe</em> it is unable to do so hence returns
<code class="docutils literal notranslate"><span class="pre">None</span></code>.</p>
<p>As another example, consider the built-in OCaml integer division function
<code class="docutils literal notranslate"><span class="pre">(</span> <span class="pre">/</span> <span class="pre">)</span> <span class="pre">:</span> <span class="pre">int</span> <span class="pre">-&gt;</span> <span class="pre">int</span> <span class="pre">-&gt;</span> <span class="pre">int</span></code>. If its second argument is zero, it raises an
exception. Another possibility, though, would be to change its type to be
<code class="docutils literal notranslate"><span class="pre">(</span> <span class="pre">/</span> <span class="pre">)</span> <span class="pre">:</span> <span class="pre">int</span> <span class="pre">-&gt;</span> <span class="pre">int</span> <span class="pre">-&gt;</span> <span class="pre">int</span> <span class="pre">option</span></code>, and return <code class="docutils literal notranslate"><span class="pre">None</span></code> whenever the divisor is
zero.</p>
<p>Both of those examples involved changing the output type of a partial function
to be an option, thus making the function total. That’s a nice way to program,
until you start trying to combine many functions together. For example, because
all the integer operations—addition, subtraction, division,
multiplication, negation, etc.—expect an <code class="docutils literal notranslate"><span class="pre">int</span></code> (or two) as input, you can
form large expressions out of them. But as soon as you change the output type of
division to be an option, you lose that <em>compositionality</em>.</p>
<p>Here’s some code to make that idea concrete:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-OCaml notranslate"><div class="highlight"><pre><span></span><span class="c">(* works fine *)</span>
<span class="k">let</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="o">(</span><span class="mi">4</span> <span class="o">/</span> <span class="mi">2</span><span class="o">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val x : int = 3
</pre></div>
</div>
</div>
</div>
<div class="cell tag_raises-exception docutils container">
<div class="cell_input docutils container">
<div class="highlight-OCaml notranslate"><div class="highlight"><pre><span></span><span class="k">let</span> <span class="n">div</span> <span class="o">(</span><span class="n">x</span><span class="o">:</span><span class="kt">int</span><span class="o">)</span> <span class="o">(</span><span class="n">y</span><span class="o">:</span><span class="kt">int</span><span class="o">)</span> <span class="o">:</span> <span class="kt">int</span> <span class="n">option</span> <span class="o">=</span>
  <span class="k">if</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">then</span> <span class="nc">None</span> <span class="k">else</span> <span class="nc">Some</span> <span class="o">(</span><span class="n">x</span> <span class="o">/</span> <span class="n">y</span><span class="o">)</span>

<span class="k">let</span> <span class="o">(</span> <span class="o">/</span> <span class="o">)</span> <span class="o">=</span> <span class="n">div</span>

<span class="c">(* won&#39;t type check *)</span>
<span class="k">let</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="o">(</span><span class="mi">4</span> <span class="o">/</span> <span class="mi">2</span><span class="o">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val div : int -&gt; int -&gt; int option = &lt;fun&gt;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val ( / ) : int -&gt; int -&gt; int option = &lt;fun&gt;
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="n">File</span> <span class="s2">&quot;[4]&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">7</span><span class="p">,</span> <span class="n">characters</span> <span class="mi">12</span><span class="o">-</span><span class="mi">19</span><span class="p">:</span>
<span class="mi">7</span> <span class="o">|</span> <span class="n">let</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
                <span class="o">^^^^^^^</span>
<span class="ne">Error</span>: This expression has type int option
       <span class="n">but</span> <span class="n">an</span> <span class="n">expression</span> <span class="n">was</span> <span class="n">expected</span> <span class="n">of</span> <span class="nb">type</span> <span class="nb">int</span>
</pre></div>
</div>
</div>
</div>
<p>The problem is that we can’t add an <code class="docutils literal notranslate"><span class="pre">int</span></code> to an <code class="docutils literal notranslate"><span class="pre">int</span> <span class="pre">option</span></code>:  the addition
operator expects its second input to be of type <code class="docutils literal notranslate"><span class="pre">int</span></code>, but the new division
operator returns a value of type <code class="docutils literal notranslate"><span class="pre">int</span> <span class="pre">option</span></code>.</p>
<p>One possibility would be to re-code all the existing operators to
accept <code class="docutils literal notranslate"><span class="pre">int</span> <span class="pre">option</span></code> as input.  For example,</p>
<div class="cell tag_hide-output docutils container">
<div class="cell_input above-output-prompt docutils container">
<div class="highlight-OCaml notranslate"><div class="highlight"><pre><span></span><span class="k">let</span> <span class="n">plus_opt</span> <span class="o">(</span><span class="n">x</span><span class="o">:</span><span class="kt">int</span> <span class="n">option</span><span class="o">)</span> <span class="o">(</span><span class="n">y</span><span class="o">:</span><span class="kt">int</span> <span class="n">option</span><span class="o">)</span> <span class="o">:</span> <span class="kt">int</span> <span class="n">option</span> <span class="o">=</span>
  <span class="k">match</span> <span class="n">x</span><span class="o">,</span><span class="n">y</span> <span class="k">with</span>
  <span class="o">|</span> <span class="nc">None</span><span class="o">,</span> <span class="o">_</span> <span class="o">|</span> <span class="o">_,</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="nc">None</span>
  <span class="o">|</span> <span class="nc">Some</span> <span class="n">a</span><span class="o">,</span> <span class="nc">Some</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="nc">Some</span> <span class="o">(</span><span class="nn">Stdlib</span><span class="p">.</span><span class="o">(</span> <span class="o">+</span> <span class="o">)</span> <span class="n">a</span> <span class="n">b</span><span class="o">)</span>

<span class="k">let</span> <span class="o">(</span> <span class="o">+</span> <span class="o">)</span> <span class="o">=</span> <span class="n">plus_opt</span>

<span class="k">let</span> <span class="n">minus_opt</span> <span class="o">(</span><span class="n">x</span><span class="o">:</span><span class="kt">int</span> <span class="n">option</span><span class="o">)</span> <span class="o">(</span><span class="n">y</span><span class="o">:</span><span class="kt">int</span> <span class="n">option</span><span class="o">)</span> <span class="o">:</span> <span class="kt">int</span> <span class="n">option</span> <span class="o">=</span>
  <span class="k">match</span> <span class="n">x</span><span class="o">,</span><span class="n">y</span> <span class="k">with</span>
  <span class="o">|</span> <span class="nc">None</span><span class="o">,</span> <span class="o">_</span> <span class="o">|</span> <span class="o">_,</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="nc">None</span>
  <span class="o">|</span> <span class="nc">Some</span> <span class="n">a</span><span class="o">,</span> <span class="nc">Some</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="nc">Some</span> <span class="o">(</span><span class="nn">Stdlib</span><span class="p">.</span><span class="o">(</span> <span class="o">-</span> <span class="o">)</span> <span class="n">a</span> <span class="n">b</span><span class="o">)</span>

<span class="k">let</span> <span class="o">(</span> <span class="o">-</span> <span class="o">)</span> <span class="o">=</span> <span class="n">minus_opt</span>

<span class="k">let</span> <span class="n">mult_opt</span> <span class="o">(</span><span class="n">x</span><span class="o">:</span><span class="kt">int</span> <span class="n">option</span><span class="o">)</span> <span class="o">(</span><span class="n">y</span><span class="o">:</span><span class="kt">int</span> <span class="n">option</span><span class="o">)</span> <span class="o">:</span> <span class="kt">int</span> <span class="n">option</span> <span class="o">=</span>
  <span class="k">match</span> <span class="n">x</span><span class="o">,</span><span class="n">y</span> <span class="k">with</span>
  <span class="o">|</span> <span class="nc">None</span><span class="o">,</span> <span class="o">_</span> <span class="o">|</span> <span class="o">_,</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="nc">None</span>
  <span class="o">|</span> <span class="nc">Some</span> <span class="n">a</span><span class="o">,</span> <span class="nc">Some</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="nc">Some</span> <span class="o">(</span><span class="nn">Stdlib</span><span class="p">.</span><span class="o">(</span> <span class="o">*</span> <span class="o">)</span> <span class="n">a</span> <span class="n">b</span><span class="o">)</span>

<span class="k">let</span> <span class="o">(</span> <span class="o">*</span> <span class="o">)</span> <span class="o">=</span> <span class="n">mult_opt</span>

<span class="k">let</span> <span class="n">div_opt</span> <span class="o">(</span><span class="n">x</span><span class="o">:</span><span class="kt">int</span> <span class="n">option</span><span class="o">)</span> <span class="o">(</span><span class="n">y</span><span class="o">:</span><span class="kt">int</span> <span class="n">option</span><span class="o">)</span> <span class="o">:</span> <span class="kt">int</span> <span class="n">option</span> <span class="o">=</span>
  <span class="k">match</span> <span class="n">x</span><span class="o">,</span><span class="n">y</span> <span class="k">with</span>
  <span class="o">|</span> <span class="nc">None</span><span class="o">,</span> <span class="o">_</span> <span class="o">|</span> <span class="o">_,</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="nc">None</span>
  <span class="o">|</span> <span class="nc">Some</span> <span class="n">a</span><span class="o">,</span> <span class="nc">Some</span> <span class="n">b</span> <span class="o">-&gt;</span>
    <span class="k">if</span> <span class="n">b</span><span class="o">=</span><span class="mi">0</span> <span class="k">then</span> <span class="nc">None</span> <span class="k">else</span> <span class="nc">Some</span> <span class="o">(</span><span class="nn">Stdlib</span><span class="p">.</span><span class="o">(</span> <span class="o">/</span> <span class="o">)</span> <span class="n">a</span> <span class="n">b</span><span class="o">)</span>

<span class="k">let</span> <span class="o">(</span> <span class="o">/</span> <span class="o">)</span> <span class="o">=</span> <span class="n">div_opt</span>
</pre></div>
</div>
</div>
<details class="hide below-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell output</span>
<span class="expanded">Hide code cell output</span>
</summary>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val plus_opt : int option -&gt; int option -&gt; int option = &lt;fun&gt;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val ( + ) : int option -&gt; int option -&gt; int option = &lt;fun&gt;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val minus_opt : int option -&gt; int option -&gt; int option = &lt;fun&gt;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val ( - ) : int option -&gt; int option -&gt; int option = &lt;fun&gt;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val mult_opt : int option -&gt; int option -&gt; int option = &lt;fun&gt;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val ( * ) : int option -&gt; int option -&gt; int option = &lt;fun&gt;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val div_opt : int option -&gt; int option -&gt; int option = &lt;fun&gt;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val ( / ) : int option -&gt; int option -&gt; int option = &lt;fun&gt;
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-OCaml notranslate"><div class="highlight"><pre><span></span><span class="c">(* does type check *)</span>
<span class="k">let</span> <span class="n">x</span> <span class="o">=</span> <span class="nc">Some</span> <span class="mi">1</span> <span class="o">+</span> <span class="o">(</span><span class="nc">Some</span> <span class="mi">4</span> <span class="o">/</span> <span class="nc">Some</span> <span class="mi">2</span><span class="o">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val x : int option = Some 3
</pre></div>
</div>
</div>
</div>
<p>But that’s a tremendous amount of code duplication. We ought to apply the
Abstraction Principle and deduplicate. Three of the four operators can be
handled by abstracting a function that just does some pattern matching to
propagate <code class="docutils literal notranslate"><span class="pre">None</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-OCaml notranslate"><div class="highlight"><pre><span></span><span class="k">let</span> <span class="n">propagate_none</span> <span class="o">(</span><span class="n">op</span> <span class="o">:</span> <span class="kt">int</span> <span class="o">-&gt;</span> <span class="kt">int</span> <span class="o">-&gt;</span> <span class="kt">int</span><span class="o">)</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="kt">int</span> <span class="n">option</span><span class="o">)</span> <span class="o">(</span><span class="n">y</span> <span class="o">:</span> <span class="kt">int</span> <span class="n">option</span><span class="o">)</span> <span class="o">=</span>
  <span class="k">match</span> <span class="n">x</span><span class="o">,</span> <span class="n">y</span> <span class="k">with</span>
  <span class="o">|</span> <span class="nc">None</span><span class="o">,</span> <span class="o">_</span> <span class="o">|</span> <span class="o">_,</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="nc">None</span>
  <span class="o">|</span> <span class="nc">Some</span> <span class="n">a</span><span class="o">,</span> <span class="nc">Some</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="nc">Some</span> <span class="o">(</span><span class="n">op</span> <span class="n">a</span> <span class="n">b</span><span class="o">)</span>

<span class="k">let</span> <span class="o">(</span> <span class="o">+</span> <span class="o">)</span> <span class="o">=</span> <span class="n">propagate_none</span> <span class="nn">Stdlib</span><span class="p">.</span><span class="o">(</span> <span class="o">+</span> <span class="o">)</span>
<span class="k">let</span> <span class="o">(</span> <span class="o">-</span> <span class="o">)</span> <span class="o">=</span> <span class="n">propagate_none</span> <span class="nn">Stdlib</span><span class="p">.</span><span class="o">(</span> <span class="o">-</span> <span class="o">)</span>
<span class="k">let</span> <span class="o">(</span> <span class="o">*</span> <span class="o">)</span> <span class="o">=</span> <span class="n">propagate_none</span> <span class="nn">Stdlib</span><span class="p">.</span><span class="o">(</span> <span class="o">*</span> <span class="o">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val propagate_none :
  (int -&gt; int -&gt; int) -&gt; int option -&gt; int option -&gt; int option = &lt;fun&gt;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val ( + ) : int option -&gt; int option -&gt; int option = &lt;fun&gt;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val ( - ) : int option -&gt; int option -&gt; int option = &lt;fun&gt;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val ( * ) : int option -&gt; int option -&gt; int option = &lt;fun&gt;
</pre></div>
</div>
</div>
</div>
<p>Unfortunately, division is harder to deduplicate. We can’t just pass
<code class="docutils literal notranslate"><span class="pre">Stdlib.(</span> <span class="pre">/</span> <span class="pre">)</span></code> to <code class="docutils literal notranslate"><span class="pre">propagate_none</span></code>, because neither of those functions will
check to see whether the divisor is zero. It would be nice if we could pass our
function <code class="docutils literal notranslate"><span class="pre">div</span> <span class="pre">:</span> <span class="pre">int</span> <span class="pre">-&gt;</span> <span class="pre">int</span> <span class="pre">-&gt;</span> <span class="pre">int</span> <span class="pre">option</span></code> to <code class="docutils literal notranslate"><span class="pre">propagate_none</span></code>, but the return
type of <code class="docutils literal notranslate"><span class="pre">div</span></code> makes that impossible.</p>
<p>So, let’s rewrite <code class="docutils literal notranslate"><span class="pre">propagate_none</span></code> to accept an operator of the same type as
<code class="docutils literal notranslate"><span class="pre">div</span></code>, which makes it easy to implement division:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-OCaml notranslate"><div class="highlight"><pre><span></span><span class="k">let</span> <span class="n">propagate_none</span>
  <span class="o">(</span><span class="n">op</span> <span class="o">:</span> <span class="kt">int</span> <span class="o">-&gt;</span> <span class="kt">int</span> <span class="o">-&gt;</span> <span class="kt">int</span> <span class="n">option</span><span class="o">)</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="kt">int</span> <span class="n">option</span><span class="o">)</span> <span class="o">(</span><span class="n">y</span> <span class="o">:</span> <span class="kt">int</span> <span class="n">option</span><span class="o">)</span>
<span class="o">=</span>
  <span class="k">match</span> <span class="n">x</span><span class="o">,</span> <span class="n">y</span> <span class="k">with</span>
  <span class="o">|</span> <span class="nc">None</span><span class="o">,</span> <span class="o">_</span> <span class="o">|</span> <span class="o">_,</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="nc">None</span>
  <span class="o">|</span> <span class="nc">Some</span> <span class="n">a</span><span class="o">,</span> <span class="nc">Some</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span> <span class="n">b</span>

<span class="k">let</span> <span class="o">(</span> <span class="o">/</span> <span class="o">)</span> <span class="o">=</span> <span class="n">propagate_none</span> <span class="n">div</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val propagate_none :
  (int -&gt; int -&gt; int option) -&gt; int option -&gt; int option -&gt; int option =
  &lt;fun&gt;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val ( / ) : int option -&gt; int option -&gt; int option = &lt;fun&gt;
</pre></div>
</div>
</div>
</div>
<p>Implementing the other three operations requires a little more work, because
their return type is <code class="docutils literal notranslate"><span class="pre">int</span></code> not <code class="docutils literal notranslate"><span class="pre">int</span> <span class="pre">option</span></code>. We need to wrap their return value
with <code class="docutils literal notranslate"><span class="pre">Some</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-OCaml notranslate"><div class="highlight"><pre><span></span><span class="k">let</span> <span class="n">wrap_output</span> <span class="o">(</span><span class="n">op</span> <span class="o">:</span> <span class="kt">int</span> <span class="o">-&gt;</span> <span class="kt">int</span> <span class="o">-&gt;</span> <span class="kt">int</span><span class="o">)</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="kt">int</span><span class="o">)</span> <span class="o">(</span><span class="n">y</span> <span class="o">:</span> <span class="kt">int</span><span class="o">)</span> <span class="o">:</span> <span class="kt">int</span> <span class="n">option</span> <span class="o">=</span>
  <span class="nc">Some</span> <span class="o">(</span><span class="n">op</span> <span class="n">x</span> <span class="n">y</span><span class="o">)</span>

<span class="k">let</span> <span class="o">(</span> <span class="o">+</span> <span class="o">)</span> <span class="o">=</span> <span class="n">propagate_none</span> <span class="o">(</span><span class="n">wrap_output</span> <span class="nn">Stdlib</span><span class="p">.</span><span class="o">(</span> <span class="o">+</span> <span class="o">))</span>
<span class="k">let</span> <span class="o">(</span> <span class="o">-</span> <span class="o">)</span> <span class="o">=</span> <span class="n">propagate_none</span> <span class="o">(</span><span class="n">wrap_output</span> <span class="nn">Stdlib</span><span class="p">.</span><span class="o">(</span> <span class="o">-</span> <span class="o">))</span>
<span class="k">let</span> <span class="o">(</span> <span class="o">*</span> <span class="o">)</span> <span class="o">=</span> <span class="n">propagate_none</span> <span class="o">(</span><span class="n">wrap_output</span> <span class="nn">Stdlib</span><span class="p">.</span><span class="o">(</span> <span class="o">*</span> <span class="o">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val wrap_output : (int -&gt; int -&gt; int) -&gt; int -&gt; int -&gt; int option = &lt;fun&gt;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val ( + ) : int option -&gt; int option -&gt; int option = &lt;fun&gt;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val ( - ) : int option -&gt; int option -&gt; int option = &lt;fun&gt;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val ( * ) : int option -&gt; int option -&gt; int option = &lt;fun&gt;
</pre></div>
</div>
</div>
</div>
<p>Finally, we could re-implement <code class="docutils literal notranslate"><span class="pre">div</span></code> to use <code class="docutils literal notranslate"><span class="pre">wrap_output</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-OCaml notranslate"><div class="highlight"><pre><span></span><span class="k">let</span> <span class="n">div</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="kt">int</span><span class="o">)</span> <span class="o">(</span><span class="n">y</span> <span class="o">:</span> <span class="kt">int</span><span class="o">)</span> <span class="o">:</span> <span class="kt">int</span> <span class="n">option</span> <span class="o">=</span>
  <span class="k">if</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">then</span> <span class="nc">None</span> <span class="k">else</span> <span class="n">wrap_output</span> <span class="nn">Stdlib</span><span class="p">.</span><span class="o">(</span> <span class="o">/</span> <span class="o">)</span> <span class="n">x</span> <span class="n">y</span>

<span class="k">let</span> <span class="o">(</span> <span class="o">/</span> <span class="o">)</span> <span class="o">=</span> <span class="n">propagate_none</span> <span class="n">div</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val div : int -&gt; int -&gt; int option = &lt;fun&gt;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val ( / ) : int option -&gt; int option -&gt; int option = &lt;fun&gt;
</pre></div>
</div>
</div>
</div>
<p><strong>Where’s the Monad?</strong> The work we just did was to take functions on integers
and transform them into functions on values that maybe are integers, but maybe
are not—that is, values that are either <code class="docutils literal notranslate"><span class="pre">Some</span> <span class="pre">i</span></code> where <code class="docutils literal notranslate"><span class="pre">i</span></code> is an integer,
or are <code class="docutils literal notranslate"><span class="pre">None</span></code>. We can think of these “upgraded” functions as computations that
<em>may have the effect of producing nothing</em>. They produce metaphorical boxes, and
those boxes may be full of something, or contain nothing.</p>
<p>There were two fundamental ideas in the code we just wrote, which correspond to
the monad operations of <code class="docutils literal notranslate"><span class="pre">return</span></code> and <code class="docutils literal notranslate"><span class="pre">bind</span></code>.</p>
<p>The first (which admittedly seems trivial) was upgrading a value from <code class="docutils literal notranslate"><span class="pre">int</span></code> to
<code class="docutils literal notranslate"><span class="pre">int</span> <span class="pre">option</span></code> by wrapping it with <code class="docutils literal notranslate"><span class="pre">Some</span></code>. That’s what the body of <code class="docutils literal notranslate"><span class="pre">wrap_output</span></code>
does. We could expose that idea even more clearly by defining the following
function:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-OCaml notranslate"><div class="highlight"><pre><span></span><span class="k">let</span> <span class="n">return</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="kt">int</span><span class="o">)</span> <span class="o">:</span> <span class="kt">int</span> <span class="n">option</span> <span class="o">=</span> <span class="nc">Some</span> <span class="n">x</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val return : int -&gt; int option = &lt;fun&gt;
</pre></div>
</div>
</div>
</div>
<p>This function has the <em>trivial effect</em> of putting a value into the metaphorical
box.</p>
<p>The second idea was factoring out code to handle all the pattern matching
against <code class="docutils literal notranslate"><span class="pre">None</span></code>. We had to upgrade functions whose inputs were of type <code class="docutils literal notranslate"><span class="pre">int</span></code> to
instead accept inputs of type <code class="docutils literal notranslate"><span class="pre">int</span> <span class="pre">option</span></code>. Here’s that idea expressed as its
own function:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-OCaml notranslate"><div class="highlight"><pre><span></span><span class="k">let</span> <span class="n">bind</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="kt">int</span> <span class="n">option</span><span class="o">)</span> <span class="o">(</span><span class="n">op</span> <span class="o">:</span> <span class="kt">int</span> <span class="o">-&gt;</span> <span class="kt">int</span> <span class="n">option</span><span class="o">)</span> <span class="o">:</span> <span class="kt">int</span> <span class="n">option</span> <span class="o">=</span>
  <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
  <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="nc">None</span>
  <span class="o">|</span> <span class="nc">Some</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span>

<span class="k">let</span> <span class="o">(</span> <span class="o">&gt;&gt;=</span> <span class="o">)</span> <span class="o">=</span> <span class="n">bind</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val bind : int option -&gt; (int -&gt; int option) -&gt; int option = &lt;fun&gt;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val ( &gt;&gt;= ) : int option -&gt; (int -&gt; int option) -&gt; int option = &lt;fun&gt;
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">bind</span></code> function can be understood as doing the core work of upgrading <code class="docutils literal notranslate"><span class="pre">op</span></code>
from a function that accepts an <code class="docutils literal notranslate"><span class="pre">int</span></code> as input to a function that accepts an
<code class="docutils literal notranslate"><span class="pre">int</span> <span class="pre">option</span></code> as input. In fact, we could even write a function that does that
upgrading for us using <code class="docutils literal notranslate"><span class="pre">bind</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-OCaml notranslate"><div class="highlight"><pre><span></span><span class="k">let</span> <span class="n">upgrade</span> <span class="o">:</span> <span class="o">(</span><span class="kt">int</span> <span class="o">-&gt;</span> <span class="kt">int</span> <span class="n">option</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="kt">int</span> <span class="n">option</span> <span class="o">-&gt;</span> <span class="kt">int</span> <span class="n">option</span><span class="o">)</span> <span class="o">=</span>
  <span class="k">fun</span> <span class="o">(</span><span class="n">op</span> <span class="o">:</span> <span class="kt">int</span> <span class="o">-&gt;</span> <span class="kt">int</span> <span class="n">option</span><span class="o">)</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="kt">int</span> <span class="n">option</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">x</span> <span class="o">&gt;&gt;=</span> <span class="n">op</span><span class="o">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val upgrade : (int -&gt; int option) -&gt; int option -&gt; int option = &lt;fun&gt;
</pre></div>
</div>
</div>
</div>
<p>All those type annotations are intended to help the reader understand
the function.  Of course, it could be written much more simply as:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-OCaml notranslate"><div class="highlight"><pre><span></span><span class="k">let</span> <span class="n">upgrade</span> <span class="n">op</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">&gt;&gt;=</span> <span class="n">op</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val upgrade : (int -&gt; int option) -&gt; int option -&gt; int option = &lt;fun&gt;
</pre></div>
</div>
</div>
</div>
<p>Using just the <code class="docutils literal notranslate"><span class="pre">return</span></code> and <code class="docutils literal notranslate"><span class="pre">&gt;&gt;=</span></code> functions, we could re-implement the
arithmetic operations from above:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-OCaml notranslate"><div class="highlight"><pre><span></span><span class="k">let</span> <span class="o">(</span> <span class="o">+</span> <span class="o">)</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="kt">int</span> <span class="n">option</span><span class="o">)</span> <span class="o">(</span><span class="n">y</span> <span class="o">:</span> <span class="kt">int</span> <span class="n">option</span><span class="o">)</span> <span class="o">:</span> <span class="kt">int</span> <span class="n">option</span> <span class="o">=</span>
  <span class="n">x</span> <span class="o">&gt;&gt;=</span> <span class="k">fun</span> <span class="n">a</span> <span class="o">-&gt;</span>
  <span class="n">y</span> <span class="o">&gt;&gt;=</span> <span class="k">fun</span> <span class="n">b</span> <span class="o">-&gt;</span>
  <span class="n">return</span> <span class="o">(</span><span class="nn">Stdlib</span><span class="p">.</span><span class="o">(</span> <span class="o">+</span> <span class="o">)</span> <span class="n">a</span> <span class="n">b</span><span class="o">)</span>

<span class="k">let</span> <span class="o">(</span> <span class="o">-</span> <span class="o">)</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="kt">int</span> <span class="n">option</span><span class="o">)</span> <span class="o">(</span><span class="n">y</span> <span class="o">:</span> <span class="kt">int</span> <span class="n">option</span><span class="o">)</span> <span class="o">:</span> <span class="kt">int</span> <span class="n">option</span> <span class="o">=</span>
  <span class="n">x</span> <span class="o">&gt;&gt;=</span> <span class="k">fun</span> <span class="n">a</span> <span class="o">-&gt;</span>
  <span class="n">y</span> <span class="o">&gt;&gt;=</span> <span class="k">fun</span> <span class="n">b</span> <span class="o">-&gt;</span>
  <span class="n">return</span> <span class="o">(</span><span class="nn">Stdlib</span><span class="p">.</span><span class="o">(</span> <span class="o">-</span> <span class="o">)</span> <span class="n">a</span> <span class="n">b</span><span class="o">)</span>

<span class="k">let</span> <span class="o">(</span> <span class="o">*</span> <span class="o">)</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="kt">int</span> <span class="n">option</span><span class="o">)</span> <span class="o">(</span><span class="n">y</span> <span class="o">:</span> <span class="kt">int</span> <span class="n">option</span><span class="o">)</span> <span class="o">:</span> <span class="kt">int</span> <span class="n">option</span> <span class="o">=</span>
  <span class="n">x</span> <span class="o">&gt;&gt;=</span> <span class="k">fun</span> <span class="n">a</span> <span class="o">-&gt;</span>
  <span class="n">y</span> <span class="o">&gt;&gt;=</span> <span class="k">fun</span> <span class="n">b</span> <span class="o">-&gt;</span>
  <span class="n">return</span> <span class="o">(</span><span class="nn">Stdlib</span><span class="p">.</span><span class="o">(</span> <span class="o">*</span> <span class="o">)</span> <span class="n">a</span> <span class="n">b</span><span class="o">)</span>

<span class="k">let</span> <span class="o">(</span> <span class="o">/</span> <span class="o">)</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="kt">int</span> <span class="n">option</span><span class="o">)</span> <span class="o">(</span><span class="n">y</span> <span class="o">:</span> <span class="kt">int</span> <span class="n">option</span><span class="o">)</span> <span class="o">:</span> <span class="kt">int</span> <span class="n">option</span> <span class="o">=</span>
  <span class="n">x</span> <span class="o">&gt;&gt;=</span> <span class="k">fun</span> <span class="n">a</span> <span class="o">-&gt;</span>
  <span class="n">y</span> <span class="o">&gt;&gt;=</span> <span class="k">fun</span> <span class="n">b</span> <span class="o">-&gt;</span>
  <span class="k">if</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">then</span> <span class="nc">None</span> <span class="k">else</span> <span class="n">return</span> <span class="o">(</span><span class="nn">Stdlib</span><span class="p">.</span><span class="o">(</span> <span class="o">/</span> <span class="o">)</span> <span class="n">a</span> <span class="n">b</span><span class="o">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val ( + ) : int option -&gt; int option -&gt; int option = &lt;fun&gt;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val ( - ) : int option -&gt; int option -&gt; int option = &lt;fun&gt;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val ( * ) : int option -&gt; int option -&gt; int option = &lt;fun&gt;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val ( / ) : int option -&gt; int option -&gt; int option = &lt;fun&gt;
</pre></div>
</div>
</div>
</div>
<p>Recall, from our discussion of the bind operator in Lwt, that the syntax above
should be parsed by your eye as</p>
<ul class="simple">
<li><p>take <code class="docutils literal notranslate"><span class="pre">x</span></code> and extract from it the value <code class="docutils literal notranslate"><span class="pre">a</span></code>,</p></li>
<li><p>then take <code class="docutils literal notranslate"><span class="pre">y</span></code> and extract from it <code class="docutils literal notranslate"><span class="pre">b</span></code>,</p></li>
<li><p>then use <code class="docutils literal notranslate"><span class="pre">a</span></code> and <code class="docutils literal notranslate"><span class="pre">b</span></code> to construct a return value.</p></li>
</ul>
<p>Of course, there’s still a fair amount of duplication going on there. We can
de-duplicate by using the same techniques as we did before:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-OCaml notranslate"><div class="highlight"><pre><span></span><span class="k">let</span> <span class="n">upgrade_binary</span> <span class="n">op</span> <span class="n">x</span> <span class="n">y</span> <span class="o">=</span>
  <span class="n">x</span> <span class="o">&gt;&gt;=</span> <span class="k">fun</span> <span class="n">a</span> <span class="o">-&gt;</span>
  <span class="n">y</span> <span class="o">&gt;&gt;=</span> <span class="k">fun</span> <span class="n">b</span> <span class="o">-&gt;</span>
  <span class="n">op</span> <span class="n">a</span> <span class="n">b</span>

<span class="k">let</span> <span class="n">return_binary</span> <span class="n">op</span> <span class="n">x</span> <span class="n">y</span> <span class="o">=</span> <span class="n">return</span> <span class="o">(</span><span class="n">op</span> <span class="n">x</span> <span class="n">y</span><span class="o">)</span>

<span class="k">let</span> <span class="o">(</span> <span class="o">+</span> <span class="o">)</span> <span class="o">=</span> <span class="n">upgrade_binary</span> <span class="o">(</span><span class="n">return_binary</span> <span class="nn">Stdlib</span><span class="p">.</span><span class="o">(</span> <span class="o">+</span> <span class="o">))</span>
<span class="k">let</span> <span class="o">(</span> <span class="o">-</span> <span class="o">)</span> <span class="o">=</span> <span class="n">upgrade_binary</span> <span class="o">(</span><span class="n">return_binary</span> <span class="nn">Stdlib</span><span class="p">.</span><span class="o">(</span> <span class="o">-</span> <span class="o">))</span>
<span class="k">let</span> <span class="o">(</span> <span class="o">*</span> <span class="o">)</span> <span class="o">=</span> <span class="n">upgrade_binary</span> <span class="o">(</span><span class="n">return_binary</span> <span class="nn">Stdlib</span><span class="p">.</span><span class="o">(</span> <span class="o">*</span> <span class="o">))</span>
<span class="k">let</span> <span class="o">(</span> <span class="o">/</span> <span class="o">)</span> <span class="o">=</span> <span class="n">upgrade_binary</span> <span class="n">div</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val upgrade_binary :
  (int -&gt; int -&gt; int option) -&gt; int option -&gt; int option -&gt; int option =
  &lt;fun&gt;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val return_binary : (&#39;a -&gt; &#39;b -&gt; int) -&gt; &#39;a -&gt; &#39;b -&gt; int option = &lt;fun&gt;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val ( + ) : int option -&gt; int option -&gt; int option = &lt;fun&gt;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val ( - ) : int option -&gt; int option -&gt; int option = &lt;fun&gt;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val ( * ) : int option -&gt; int option -&gt; int option = &lt;fun&gt;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val ( / ) : int option -&gt; int option -&gt; int option = &lt;fun&gt;
</pre></div>
</div>
</div>
</div>
<p><strong>The Maybe Monad.</strong> The monad we just discovered goes by several names: the
<em>maybe monad</em> (as in, “maybe there’s a value, maybe not”), the <em>error monad</em> (as
in, “either there’s a value or an error”, and error is represented by
<code class="docutils literal notranslate"><span class="pre">None</span></code>—though some authors would want an error monad to be able to
represent multiple kinds of errors rather than just collapse them all to
<code class="docutils literal notranslate"><span class="pre">None</span></code>), and the <em>option monad</em> (which is obvious).</p>
<p>Here’s an implementation of the monad signature for the maybe monad:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-OCaml notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="nc">Maybe</span> <span class="o">:</span> <span class="nc">Monad</span> <span class="o">=</span> <span class="k">struct</span>
  <span class="k">type</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span> <span class="o">=</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">option</span>

  <span class="k">let</span> <span class="n">return</span> <span class="n">x</span> <span class="o">=</span> <span class="nc">Some</span> <span class="n">x</span>

  <span class="k">let</span> <span class="o">(&gt;&gt;=)</span> <span class="n">m</span> <span class="n">f</span> <span class="o">=</span>
    <span class="k">match</span> <span class="n">m</span> <span class="k">with</span>
    <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="nc">None</span>
    <span class="o">|</span> <span class="nc">Some</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">x</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>module Maybe : Monad
</pre></div>
</div>
</div>
</div>
<p>These are the same implementations of <code class="docutils literal notranslate"><span class="pre">return</span></code> and <code class="docutils literal notranslate"><span class="pre">&gt;&gt;=</span></code> as we invented above,
but without the type annotations to force them to work only on integers. Indeed,
we never needed those annotations; they just helped make the code above a little
clearer.</p>
<p>In practice the <code class="docutils literal notranslate"><span class="pre">return</span></code> function here is quite trivial and not really
necessary. But the <code class="docutils literal notranslate"><span class="pre">&gt;&gt;=</span></code> operator can be used to replace a lot of boilerplate
pattern matching, as we saw in the final implementation of the arithmetic
operators above. There’s just a single pattern match, which is inside of <code class="docutils literal notranslate"><span class="pre">&gt;&gt;=</span></code>.
Compare that to the original implementations of <code class="docutils literal notranslate"><span class="pre">plus_opt</span></code>, etc., which had many
pattern matches.</p>
<p>The result is we get code that (once you understand how to read the bind
operator) is easier to read and easier to maintain.</p>
<p>Now that we’re done playing with integer operators, we should restore
their original meaning for the rest of this file:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-OCaml notranslate"><div class="highlight"><pre><span></span><span class="k">let</span> <span class="o">(</span> <span class="o">+</span> <span class="o">)</span> <span class="o">=</span> <span class="nn">Stdlib</span><span class="p">.</span><span class="o">(</span> <span class="o">+</span> <span class="o">)</span>
<span class="k">let</span> <span class="o">(</span> <span class="o">-</span> <span class="o">)</span> <span class="o">=</span> <span class="nn">Stdlib</span><span class="p">.</span><span class="o">(</span> <span class="o">-</span> <span class="o">)</span>
<span class="k">let</span> <span class="o">(</span> <span class="o">*</span> <span class="o">)</span> <span class="o">=</span> <span class="nn">Stdlib</span><span class="p">.</span><span class="o">(</span> <span class="o">*</span> <span class="o">)</span>
<span class="k">let</span> <span class="o">(</span> <span class="o">/</span> <span class="o">)</span> <span class="o">=</span> <span class="nn">Stdlib</span><span class="p">.</span><span class="o">(</span> <span class="o">/</span> <span class="o">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val ( + ) : int -&gt; int -&gt; int = &lt;fun&gt;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val ( - ) : int -&gt; int -&gt; int = &lt;fun&gt;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val ( * ) : int -&gt; int -&gt; int = &lt;fun&gt;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val ( / ) : int -&gt; int -&gt; int = &lt;fun&gt;
</pre></div>
</div>
</div>
</div>
</section>
<section id="example-the-writer-monad">
<h2><span class="section-number">8.8.3. </span>Example: The Writer Monad<a class="headerlink" href="#example-the-writer-monad" title="Permalink to this heading">#</a></h2>
<p>When trying to diagnose faults in a system, it’s often the case that a <em>log</em> of
what functions have been called, as well as what their inputs and outputs were,
would be helpful.</p>
<p>Imagine that we had two functions we wanted to debug, both of type <code class="docutils literal notranslate"><span class="pre">int</span> <span class="pre">-&gt;</span> <span class="pre">int</span></code>.
For example:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-OCaml notranslate"><div class="highlight"><pre><span></span><span class="k">let</span> <span class="n">inc</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span>
<span class="k">let</span> <span class="n">dec</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val inc : int -&gt; int = &lt;fun&gt;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val dec : int -&gt; int = &lt;fun&gt;
</pre></div>
</div>
</div>
</div>
<p>(Ok, those are really simple functions; we probably don’t need any help
debugging them. But imagine they compute something far more complicated, like
encryptions or decryptions of integers.)</p>
<p>One way to keep a log of function calls would be to augment each function to
return a pair: the integer value the function would normally return, as well as
a string containing a log message. For example:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-OCaml notranslate"><div class="highlight"><pre><span></span><span class="k">let</span> <span class="n">inc_log</span> <span class="n">x</span> <span class="o">=</span> <span class="o">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="o">,</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;Called inc on %i; &quot;</span> <span class="n">x</span><span class="o">)</span>
<span class="k">let</span> <span class="n">dec_log</span> <span class="n">x</span> <span class="o">=</span> <span class="o">(</span><span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="o">,</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;Called dec on %i; &quot;</span> <span class="n">x</span><span class="o">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val inc_log : int -&gt; int * string = &lt;fun&gt;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val dec_log : int -&gt; int * string = &lt;fun&gt;
</pre></div>
</div>
</div>
</div>
<p>But that changes the return type of both functions, which makes it hard to
<em>compose</em> the functions. Previously, we could have written code such as</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-OCaml notranslate"><div class="highlight"><pre><span></span><span class="k">let</span> <span class="n">id</span> <span class="n">x</span> <span class="o">=</span> <span class="n">dec</span> <span class="o">(</span><span class="n">inc</span> <span class="n">x</span><span class="o">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val id : int -&gt; int = &lt;fun&gt;
</pre></div>
</div>
</div>
</div>
<p>or even better</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-OCaml notranslate"><div class="highlight"><pre><span></span><span class="k">let</span> <span class="n">id</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">inc</span> <span class="o">|&gt;</span> <span class="n">dec</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val id : int -&gt; int = &lt;fun&gt;
</pre></div>
</div>
</div>
</div>
<p>or even better still, using the <em>composition operator</em> <code class="docutils literal notranslate"><span class="pre">&gt;&gt;</span></code>,</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-OCaml notranslate"><div class="highlight"><pre><span></span><span class="k">let</span> <span class="o">(</span> <span class="o">&gt;&gt;</span> <span class="o">)</span> <span class="n">f</span> <span class="n">g</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">f</span> <span class="o">|&gt;</span> <span class="n">g</span>
<span class="k">let</span> <span class="n">id</span> <span class="o">=</span> <span class="n">inc</span> <span class="o">&gt;&gt;</span> <span class="n">dec</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val ( &gt;&gt; ) : (&#39;a -&gt; &#39;b) -&gt; (&#39;b -&gt; &#39;c) -&gt; &#39;a -&gt; &#39;c = &lt;fun&gt;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val id : int -&gt; int = &lt;fun&gt;
</pre></div>
</div>
</div>
</div>
<p>and that would have worked just fine. But trying to do the same thing with the
loggable versions of the functions produces a type-checking error:</p>
<div class="cell tag_raises-exception docutils container">
<div class="cell_input docutils container">
<div class="highlight-OCaml notranslate"><div class="highlight"><pre><span></span><span class="k">let</span> <span class="n">id</span> <span class="o">=</span> <span class="n">inc_log</span> <span class="o">&gt;&gt;</span> <span class="n">dec_log</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="n">File</span> <span class="s2">&quot;[24]&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1</span><span class="p">,</span> <span class="n">characters</span> <span class="mi">20</span><span class="o">-</span><span class="mi">27</span><span class="p">:</span>
<span class="mi">1</span> <span class="o">|</span> <span class="n">let</span> <span class="nb">id</span> <span class="o">=</span> <span class="n">inc_log</span> <span class="o">&gt;&gt;</span> <span class="n">dec_log</span>
                        <span class="o">^^^^^^^</span>
<span class="ne">Error</span>: This expression has type int -&gt; int * string
       <span class="n">but</span> <span class="n">an</span> <span class="n">expression</span> <span class="n">was</span> <span class="n">expected</span> <span class="n">of</span> <span class="nb">type</span> <span class="nb">int</span> <span class="o">*</span> <span class="n">string</span> <span class="o">-&gt;</span> <span class="s1">&#39;a</span>
       <span class="n">Type</span> <span class="nb">int</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">compatible</span> <span class="k">with</span> <span class="nb">type</span> <span class="nb">int</span> <span class="o">*</span> <span class="n">string</span> 
</pre></div>
</div>
</div>
</div>
<p>That’s because <code class="docutils literal notranslate"><span class="pre">inc_log</span> <span class="pre">x</span></code> would be a pair, but <code class="docutils literal notranslate"><span class="pre">dec_log</span></code> expects simply an
integer as input.</p>
<p>We could code up an upgraded version of <code class="docutils literal notranslate"><span class="pre">dec_log</span></code> that is able to take a pair as
input:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-OCaml notranslate"><div class="highlight"><pre><span></span><span class="k">let</span> <span class="n">dec_log_upgraded</span> <span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">s</span><span class="o">)</span> <span class="o">=</span>
  <span class="o">(</span><span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="o">,</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;%s; Called dec on %i; &quot;</span> <span class="n">s</span> <span class="n">x</span><span class="o">)</span>

<span class="k">let</span> <span class="n">id</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">|&gt;</span> <span class="n">inc_log</span> <span class="o">|&gt;</span> <span class="n">dec_log_upgraded</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val dec_log_upgraded : int * string -&gt; int * string = &lt;fun&gt;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val id : int -&gt; int * string = &lt;fun&gt;
</pre></div>
</div>
</div>
</div>
<p>That works fine, but we also will need to code up a similar upgraded version of
<code class="docutils literal notranslate"><span class="pre">f_log</span></code> if we ever want to call them in reverse order, e.g.,
<code class="docutils literal notranslate"><span class="pre">let</span> <span class="pre">id</span> <span class="pre">=</span> <span class="pre">dec_log</span> <span class="pre">&gt;&gt;</span> <span class="pre">inc_log</span></code>. So we have to write:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-OCaml notranslate"><div class="highlight"><pre><span></span><span class="k">let</span> <span class="n">inc_log_upgraded</span> <span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">s</span><span class="o">)</span> <span class="o">=</span>
  <span class="o">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="o">,</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;%s; Called inc on %i; &quot;</span> <span class="n">s</span> <span class="n">x</span><span class="o">)</span>

<span class="k">let</span> <span class="n">id</span> <span class="o">=</span> <span class="n">dec_log</span> <span class="o">&gt;&gt;</span> <span class="n">inc_log_upgraded</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val inc_log_upgraded : int * string -&gt; int * string = &lt;fun&gt;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val id : int -&gt; int * string = &lt;fun&gt;
</pre></div>
</div>
</div>
</div>
<p>And at this point we’ve duplicated far too much code. The implementations of
<code class="docutils literal notranslate"><span class="pre">inc</span></code> and <code class="docutils literal notranslate"><span class="pre">dec</span></code> are duplicated inside both <code class="docutils literal notranslate"><span class="pre">inc_log</span></code> and <code class="docutils literal notranslate"><span class="pre">dec_log</span></code>, as well as
inside both upgraded versions of the functions. And both the upgrades duplicate
the code for concatenating log messages together. The more functions we want to
make loggable, the worse this duplication is going to become!</p>
<p>So, let’s start over, and factor out a couple helper functions. The first helper
calls a function and produces a log message:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-OCaml notranslate"><div class="highlight"><pre><span></span><span class="k">let</span> <span class="n">log</span> <span class="o">(</span><span class="n">name</span> <span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="kt">int</span> <span class="o">-&gt;</span> <span class="kt">int</span><span class="o">)</span> <span class="o">:</span> <span class="kt">int</span> <span class="o">-&gt;</span> <span class="kt">int</span> <span class="o">*</span> <span class="kt">string</span> <span class="o">=</span>
  <span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">f</span> <span class="n">x</span><span class="o">,</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;Called %s on %i; &quot;</span> <span class="n">name</span> <span class="n">x</span><span class="o">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val log : string -&gt; (int -&gt; int) -&gt; int -&gt; int * string = &lt;fun&gt;
</pre></div>
</div>
</div>
</div>
<p>The second helper produces a logging function of type
<code class="docutils literal notranslate"><span class="pre">'a</span> <span class="pre">*</span> <span class="pre">string</span> <span class="pre">-&gt;</span> <span class="pre">'b</span> <span class="pre">*</span> <span class="pre">string</span></code> out of a non-loggable function:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-OCaml notranslate"><div class="highlight"><pre><span></span><span class="k">let</span> <span class="n">loggable</span> <span class="o">(</span><span class="n">name</span> <span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="kt">int</span> <span class="o">-&gt;</span> <span class="kt">int</span><span class="o">)</span> <span class="o">:</span> <span class="kt">int</span> <span class="o">*</span> <span class="kt">string</span> <span class="o">-&gt;</span> <span class="kt">int</span> <span class="o">*</span> <span class="kt">string</span> <span class="o">=</span>
  <span class="k">fun</span> <span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">s1</span><span class="o">)</span> <span class="o">-&gt;</span>
    <span class="k">let</span> <span class="o">(</span><span class="n">y</span><span class="o">,</span> <span class="n">s2</span><span class="o">)</span> <span class="o">=</span> <span class="n">log</span> <span class="n">name</span> <span class="n">f</span> <span class="n">x</span> <span class="k">in</span>
    <span class="o">(</span><span class="n">y</span><span class="o">,</span> <span class="n">s1</span> <span class="o">^</span> <span class="n">s2</span><span class="o">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val loggable : string -&gt; (int -&gt; int) -&gt; int * string -&gt; int * string = &lt;fun&gt;
</pre></div>
</div>
</div>
</div>
<p>Using those helpers, we can implement the logging versions of our functions
without any duplication of code involving pairs or pattern matching or string
concatenation:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-OCaml notranslate"><div class="highlight"><pre><span></span><span class="k">let</span> <span class="n">inc&#39;</span> <span class="o">:</span> <span class="kt">int</span> <span class="o">*</span> <span class="kt">string</span> <span class="o">-&gt;</span> <span class="kt">int</span> <span class="o">*</span> <span class="kt">string</span> <span class="o">=</span>
  <span class="n">loggable</span> <span class="s2">&quot;inc&quot;</span> <span class="n">inc</span>

<span class="k">let</span> <span class="n">dec&#39;</span> <span class="o">:</span> <span class="kt">int</span> <span class="o">*</span> <span class="kt">string</span> <span class="o">-&gt;</span> <span class="kt">int</span> <span class="o">*</span> <span class="kt">string</span> <span class="o">=</span>
  <span class="n">loggable</span> <span class="s2">&quot;dec&quot;</span> <span class="n">dec</span>

<span class="k">let</span> <span class="n">id&#39;</span> <span class="o">:</span> <span class="kt">int</span> <span class="o">*</span> <span class="kt">string</span> <span class="o">-&gt;</span> <span class="kt">int</span> <span class="o">*</span> <span class="kt">string</span> <span class="o">=</span>
  <span class="n">inc&#39;</span> <span class="o">&gt;&gt;</span> <span class="n">dec&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val inc&#39; : int * string -&gt; int * string = &lt;fun&gt;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val dec&#39; : int * string -&gt; int * string = &lt;fun&gt;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val id&#39; : int * string -&gt; int * string = &lt;fun&gt;
</pre></div>
</div>
</div>
</div>
<p>Here’s an example usage:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-OCaml notranslate"><div class="highlight"><pre><span></span><span class="n">id&#39;</span> <span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="s2">&quot;&quot;</span><span class="o">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>- : int * string = (5, &quot;Called inc on 5; Called dec on 6; &quot;)
</pre></div>
</div>
</div>
</div>
<p>Notice how it’s inconvenient to call our loggable functions on integers, since
we have to pair the integer with a string. So let’s write one more function to
help with that by pairing an integer with the <em>empty</em> log:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-OCaml notranslate"><div class="highlight"><pre><span></span><span class="k">let</span> <span class="n">e</span> <span class="n">x</span> <span class="o">=</span> <span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="s2">&quot;&quot;</span><span class="o">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val e : &#39;a -&gt; &#39;a * string = &lt;fun&gt;
</pre></div>
</div>
</div>
</div>
<p>And now we can write <code class="docutils literal notranslate"><span class="pre">id'</span> <span class="pre">(e</span> <span class="pre">5)</span></code> instead of <code class="docutils literal notranslate"><span class="pre">id'</span> <span class="pre">(5,</span> <span class="pre">&quot;&quot;)</span></code>.</p>
<p><strong>Where’s the Monad?</strong> The work we just did was to take functions on integers
and transform them into functions on integers paired with log messages. We can
think of these “upgraded” functions as computations that log. They produce
metaphorical boxes, and those boxes contain function outputs as well as log
messages.</p>
<p>There were two fundamental ideas in the code we just wrote, which correspond to
the monad operations of <code class="docutils literal notranslate"><span class="pre">return</span></code> and <code class="docutils literal notranslate"><span class="pre">bind</span></code>.</p>
<p>The first was upgrading a value from <code class="docutils literal notranslate"><span class="pre">int</span></code> to <code class="docutils literal notranslate"><span class="pre">int</span> <span class="pre">*</span> <span class="pre">string</span></code> by pairing it with
the empty string. That’s what <code class="docutils literal notranslate"><span class="pre">e</span></code> does. We could rename it <code class="docutils literal notranslate"><span class="pre">return</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-OCaml notranslate"><div class="highlight"><pre><span></span><span class="k">let</span> <span class="n">return</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="kt">int</span><span class="o">)</span> <span class="o">:</span> <span class="kt">int</span> <span class="o">*</span> <span class="kt">string</span> <span class="o">=</span> <span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="s2">&quot;&quot;</span><span class="o">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val return : int -&gt; int * string = &lt;fun&gt;
</pre></div>
</div>
</div>
</div>
<p>This function has the <em>trivial effect</em> of putting a value into the metaphorical
box along with the empty log message.</p>
<p>The second idea was factoring out code to handle pattern matching against pairs
and string concatenation. Here’s that idea expressed as its own function:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-OCaml notranslate"><div class="highlight"><pre><span></span><span class="k">let</span> <span class="o">(</span> <span class="o">&gt;&gt;=</span> <span class="o">)</span> <span class="o">(</span><span class="n">m</span> <span class="o">:</span> <span class="kt">int</span> <span class="o">*</span> <span class="kt">string</span><span class="o">)</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="kt">int</span> <span class="o">-&gt;</span> <span class="kt">int</span> <span class="o">*</span> <span class="kt">string</span><span class="o">)</span> <span class="o">:</span> <span class="kt">int</span> <span class="o">*</span> <span class="kt">string</span> <span class="o">=</span>
  <span class="k">let</span> <span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">s1</span><span class="o">)</span> <span class="o">=</span> <span class="n">m</span> <span class="k">in</span>
  <span class="k">let</span> <span class="o">(</span><span class="n">y</span><span class="o">,</span> <span class="n">s2</span><span class="o">)</span> <span class="o">=</span> <span class="n">f</span> <span class="n">x</span> <span class="k">in</span>
  <span class="o">(</span><span class="n">y</span><span class="o">,</span> <span class="n">s1</span> <span class="o">^</span> <span class="n">s2</span><span class="o">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val ( &gt;&gt;= ) : int * string -&gt; (int -&gt; int * string) -&gt; int * string = &lt;fun&gt;
</pre></div>
</div>
</div>
</div>
<p>Using <code class="docutils literal notranslate"><span class="pre">&gt;&gt;=</span></code>, we can re-implement <code class="docutils literal notranslate"><span class="pre">loggable</span></code>, such that no pairs
or pattern matching are ever used in its body:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-OCaml notranslate"><div class="highlight"><pre><span></span><span class="k">let</span> <span class="n">loggable</span> <span class="o">(</span><span class="n">name</span> <span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="o">(</span><span class="n">f</span> <span class="o">:</span> <span class="kt">int</span> <span class="o">-&gt;</span> <span class="kt">int</span><span class="o">)</span> <span class="o">:</span> <span class="kt">int</span> <span class="o">*</span> <span class="kt">string</span> <span class="o">-&gt;</span> <span class="kt">int</span> <span class="o">*</span> <span class="kt">string</span> <span class="o">=</span>
  <span class="k">fun</span> <span class="n">m</span> <span class="o">-&gt;</span>
    <span class="n">m</span> <span class="o">&gt;&gt;=</span> <span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span>
    <span class="n">log</span> <span class="n">name</span> <span class="n">f</span> <span class="n">x</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val loggable : string -&gt; (int -&gt; int) -&gt; int * string -&gt; int * string = &lt;fun&gt;
</pre></div>
</div>
</div>
</div>
<p><strong>The Writer Monad.</strong> The monad we just discovered is usually called the <em>writer
monad</em> (as in, “additionally writing to a log or string”). Here’s an
implementation of the monad signature for it:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-OCaml notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="nc">Writer</span> <span class="o">:</span> <span class="nc">Monad</span> <span class="o">=</span> <span class="k">struct</span>
  <span class="k">type</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span> <span class="o">=</span> <span class="k">&#39;</span><span class="n">a</span> <span class="o">*</span> <span class="kt">string</span>

  <span class="k">let</span> <span class="n">return</span> <span class="n">x</span> <span class="o">=</span> <span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="s2">&quot;&quot;</span><span class="o">)</span>

  <span class="k">let</span> <span class="o">(</span> <span class="o">&gt;&gt;=</span> <span class="o">)</span> <span class="n">m</span> <span class="n">f</span> <span class="o">=</span>
    <span class="k">let</span> <span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">s1</span><span class="o">)</span> <span class="o">=</span> <span class="n">m</span> <span class="k">in</span>
    <span class="k">let</span> <span class="o">(</span><span class="n">y</span><span class="o">,</span> <span class="n">s2</span><span class="o">)</span> <span class="o">=</span> <span class="n">f</span> <span class="n">x</span> <span class="k">in</span>
    <span class="o">(</span><span class="n">y</span><span class="o">,</span> <span class="n">s1</span> <span class="o">^</span> <span class="n">s2</span><span class="o">)</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>module Writer : Monad
</pre></div>
</div>
</div>
</div>
<p>As we saw with the maybe monad, these are the same implementations of <code class="docutils literal notranslate"><span class="pre">return</span></code>
and <code class="docutils literal notranslate"><span class="pre">&gt;&gt;=</span></code> as we invented above, but without the type annotations to force them
to work only on integers. Indeed, we never needed those annotations; they just
helped make the code above a little clearer.</p>
<p>It’s debatable which version of <code class="docutils literal notranslate"><span class="pre">loggable</span></code> is easier to read. Certainly you need
to be comfortable with the monadic style of programming to appreciate the
version of it that uses <code class="docutils literal notranslate"><span class="pre">&gt;&gt;=</span></code>. But if you were developing a much larger code
base (i.e., with more functions involving paired strings than just <code class="docutils literal notranslate"><span class="pre">loggable</span></code>),
using the <code class="docutils literal notranslate"><span class="pre">&gt;&gt;=</span></code> operator is likely to be a good choice: it means the code you
write can concentrate on the <code class="docutils literal notranslate"><span class="pre">'a</span></code> in the type <code class="docutils literal notranslate"><span class="pre">'a</span> <span class="pre">Writer.t</span></code> instead of on the
strings. In other words, the writer monad will take care of the strings for you,
as long as you use <code class="docutils literal notranslate"><span class="pre">return</span></code> and <code class="docutils literal notranslate"><span class="pre">&gt;&gt;=</span></code>.</p>
</section>
<section id="example-the-lwt-monad">
<h2><span class="section-number">8.8.4. </span>Example: The Lwt Monad<a class="headerlink" href="#example-the-lwt-monad" title="Permalink to this heading">#</a></h2>
<p>By now, it’s probably obvious that the Lwt promises library that we discussed is
also a monad. The type <code class="docutils literal notranslate"><span class="pre">'a</span> <span class="pre">Lwt.t</span></code> of promises has a <code class="docutils literal notranslate"><span class="pre">return</span></code> and <code class="docutils literal notranslate"><span class="pre">bind</span></code>
operation of the right types to be a monad:</p>
<div class="highlight-ocaml notranslate"><div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">return</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span>
<span class="k">val</span> <span class="n">bind</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="k">&#39;</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">b</span> <span class="n">t</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">b</span> <span class="n">t</span>
</pre></div>
</div>
<p>And <code class="docutils literal notranslate"><span class="pre">Lwt.Infix.(</span> <span class="pre">&gt;&gt;=</span> <span class="pre">)</span></code> is a synonym for <code class="docutils literal notranslate"><span class="pre">Lwt.bind</span></code>, so the library does provide
an infix bind operator.</p>
<p>Now we start to see some of the great power of the monad design pattern. The
implementation of <code class="docutils literal notranslate"><span class="pre">'a</span> <span class="pre">t</span></code> and <code class="docutils literal notranslate"><span class="pre">return</span></code> that we saw before involves creating
references, but those references are completely hidden behind the monadic
interface. Moreover, we know that <code class="docutils literal notranslate"><span class="pre">bind</span></code> involves registering callbacks, but
that functionality (which as you might imagine involves maintaining collections
of callbacks) is entirely encapsulated.</p>
<p>Metaphorically, as we discussed before, the box involved here is one that starts
out empty but eventually will be filled with a value of type <code class="docutils literal notranslate"><span class="pre">'a</span></code>. The
“something more” in these computations is that values are being produced
asynchronously, rather than immediately.</p>
</section>
<section id="monad-laws">
<h2><span class="section-number">8.8.5. </span>Monad Laws<a class="headerlink" href="#monad-laws" title="Permalink to this heading">#</a></h2>
<p>Every data structure has not just a signature, but some expected behavior. For
example, a stack has a push and a pop operation, and we expect those operations
to satisfy certain algebraic laws.  We saw those for stacks when we studied
equational specification:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">peek</span> <span class="pre">(push</span> <span class="pre">x</span> <span class="pre">s)</span> <span class="pre">=</span> <span class="pre">x</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pop</span> <span class="pre">(push</span> <span class="pre">x</span> <span class="pre">s)</span> <span class="pre">=</span> <span class="pre">s</span></code></p></li>
<li><p>etc.</p></li>
</ul>
<p>A monad, though, is not just a single data structure. It’s a design pattern for
data structures. So it’s impossible to write specifications of <code class="docutils literal notranslate"><span class="pre">return</span></code> and
<code class="docutils literal notranslate"><span class="pre">&gt;&gt;=</span></code> for monads in general: the specifications would need to discuss the
particular monad, like the writer monad or the Lwt monad.</p>
<p>On the other hand, it turns out that we can write down some laws that ought to
hold of any monad. The reason for that goes back to one of the intuitions we
gave about monads, namely, that they represent computations that have effects.
Consider Lwt, for example. We might register a callback C on promise X with
<code class="docutils literal notranslate"><span class="pre">bind</span></code>. That produces a new promise Y, on which we could register another
callback D. We expect a sequential ordering on those callbacks: C must run
before D, because Y cannot be resolved before X.</p>
<p>That notion of <em>sequential order</em> is part of what the monad laws stipulate. We
will state those laws below. But first, let’s pause to consider sequential order
in imperative languages.</p>
<p>*<em>Sequential Order.</em> In languages like Java and C, there is a semicolon that
imposes a sequential order on statements, e.g.:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
<span class="n">x</span><span class="o">++</span><span class="p">;</span>
<span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
</pre></div>
</div>
<p>First <code class="docutils literal notranslate"><span class="pre">x</span></code> is printed, then incremented, then printed again. The effects that
those statements have must occur in that sequential order.</p>
<p>Let’s imagine a hypothetical statement that causes no effect whatsoever. For
example, <code class="docutils literal notranslate"><span class="pre">assert</span> <span class="pre">true</span></code> causes nothing to happen in Java. (Some compilers will
completely ignore it and not even produce bytecode for it.) In most assembly
languages, there is likewise a “no op” instruction whose mnemonic is usually
<code class="docutils literal notranslate"><span class="pre">NOP</span></code> that also causes nothing to happen. (Technically, some clock cycles would
elapse. But there wouldn’t be any changes to registers or memory.) In the theory
of programming languages, statements like this are usually called <code class="docutils literal notranslate"><span class="pre">skip</span></code>, as in,
“skip over me because I don’t do anything interesting.”</p>
<p>Here are two laws that should hold of <code class="docutils literal notranslate"><span class="pre">skip</span></code> and semicolon:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">skip;</span> <span class="pre">s;</span></code> should behave the same as just <code class="docutils literal notranslate"><span class="pre">s;</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">s;</span> <span class="pre">skip;</span></code> should behave the same as just <code class="docutils literal notranslate"><span class="pre">s;</span></code>.</p></li>
</ul>
<p>In other words, you can remove any occurrences of <code class="docutils literal notranslate"><span class="pre">skip</span></code>, because it has no
effects. Mathematically, we say that <code class="docutils literal notranslate"><span class="pre">skip</span></code> is a <em>left identity</em> (the first law)
and a <em>right identity</em> (the second law) of semicolon.</p>
<p>Imperative languages also usually have a way of grouping statements together
into blocks. In Java and C, this is usually done with curly braces. Here is a
law that should hold of blocks and semicolon:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">{s1;</span> <span class="pre">s2;}</span> <span class="pre">s3;</span></code> should behave the same as <code class="docutils literal notranslate"><span class="pre">s1;</span> <span class="pre">{s2;</span> <span class="pre">s3;}</span></code>.</p></li>
</ul>
<p>In other words, the order is always <code class="docutils literal notranslate"><span class="pre">s1</span></code> then <code class="docutils literal notranslate"><span class="pre">s2</span></code> then <code class="docutils literal notranslate"><span class="pre">s3</span></code>, regardless of
whether you group the first two statements into a block or the second two into a
block. So you could even remove the braces and just write <code class="docutils literal notranslate"><span class="pre">s1;</span> <span class="pre">s2;</span> <span class="pre">s3;</span></code>, which
is what we normally do anyway. Mathematically, we say that semicolon is
<em>associative.</em></p>
<p><strong>Sequential Order with the Monad Laws.</strong> The three laws above embody exactly
the same intuition as the monad laws, which we will now state. The monad laws
are just a bit more abstract hence harder to understand at first.</p>
<p>Suppose that we have any monad, which as usual must have the following
signature:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-OCaml notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="k">type</span> <span class="nc">Monad</span> <span class="o">=</span> <span class="k">sig</span>
  <span class="k">type</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span>
  <span class="k">val</span> <span class="n">return</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span>
  <span class="k">val</span> <span class="o">(</span> <span class="o">&gt;&gt;=</span> <span class="o">)</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="k">&#39;</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">b</span> <span class="n">t</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">b</span> <span class="n">t</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>module type Monad =
  sig
    type &#39;a t
    val return : &#39;a -&gt; &#39;a t
    val ( &gt;&gt;= ) : &#39;a t -&gt; (&#39;a -&gt; &#39;b t) -&gt; &#39;b t
  end
</pre></div>
</div>
</div>
</div>
<p>The three monad laws are as follows:</p>
<ul class="simple">
<li><p><strong>Law 1:</strong> <code class="docutils literal notranslate"><span class="pre">return</span> <span class="pre">x</span> <span class="pre">&gt;&gt;=</span> <span class="pre">f</span></code> behaves the same as <code class="docutils literal notranslate"><span class="pre">f</span> <span class="pre">x</span></code>.</p></li>
<li><p><strong>Law 2:</strong> <code class="docutils literal notranslate"><span class="pre">m</span> <span class="pre">&gt;&gt;=</span> <span class="pre">return</span></code> behaves the same as <code class="docutils literal notranslate"><span class="pre">m</span></code>.</p></li>
<li><p><strong>Law 3:</strong> <code class="docutils literal notranslate"><span class="pre">(m</span> <span class="pre">&gt;&gt;=</span> <span class="pre">f)</span> <span class="pre">&gt;&gt;=</span> <span class="pre">g</span></code> behaves the same as <code class="docutils literal notranslate"><span class="pre">m</span> <span class="pre">&gt;&gt;=</span> <span class="pre">(fun</span> <span class="pre">x</span> <span class="pre">-&gt;</span> <span class="pre">f</span> <span class="pre">x</span> <span class="pre">&gt;&gt;=</span> <span class="pre">g)</span></code>.</p></li>
</ul>
<p>Here, “behaves the same as” means that the two expressions will both evaluate to
the same value, or they will both go into an infinite loop, or they will both
raise the same exception.</p>
<p>These laws are mathematically saying the same things as the laws for <code class="docutils literal notranslate"><span class="pre">skip</span></code>,
semicolon, and braces that we saw above: <code class="docutils literal notranslate"><span class="pre">return</span></code> is a left and right identity
of <code class="docutils literal notranslate"><span class="pre">&gt;&gt;=</span></code>, and <code class="docutils literal notranslate"><span class="pre">&gt;&gt;=</span></code> is associative. Let’s look at each law in more detail.</p>
<p><em>Law 1</em> says that having the trivial effect on a value, then binding a function
on it, is the same as just calling the function on the value. Consider the maybe
monad: <code class="docutils literal notranslate"><span class="pre">return</span> <span class="pre">x</span></code> would be <code class="docutils literal notranslate"><span class="pre">Some</span> <span class="pre">x</span></code>, and <code class="docutils literal notranslate"><span class="pre">&gt;&gt;=</span> <span class="pre">f</span></code> would extract <code class="docutils literal notranslate"><span class="pre">x</span></code> and apply <code class="docutils literal notranslate"><span class="pre">f</span></code>
to it. Or consider the Lwt monad: <code class="docutils literal notranslate"><span class="pre">return</span> <span class="pre">x</span></code> would be a promise that is already
resolved with <code class="docutils literal notranslate"><span class="pre">x</span></code>, and <code class="docutils literal notranslate"><span class="pre">&gt;&gt;=</span> <span class="pre">f</span></code> would register <code class="docutils literal notranslate"><span class="pre">f</span></code> as a callback to run on <code class="docutils literal notranslate"><span class="pre">x</span></code>.</p>
<p><em>Law 2</em> says that binding on the trivial effect is the same as just not having
the effect. Consider the maybe monad: <code class="docutils literal notranslate"><span class="pre">m</span> <span class="pre">&gt;&gt;=</span> <span class="pre">return</span></code> would depend upon whether
<code class="docutils literal notranslate"><span class="pre">m</span></code> is <code class="docutils literal notranslate"><span class="pre">Some</span> <span class="pre">x</span></code> or <code class="docutils literal notranslate"><span class="pre">None</span></code>. In the former case, binding would extract <code class="docutils literal notranslate"><span class="pre">x</span></code>, and
<code class="docutils literal notranslate"><span class="pre">return</span></code> would just re-wrap it with <code class="docutils literal notranslate"><span class="pre">Some</span></code>. In the latter case, binding would
just return <code class="docutils literal notranslate"><span class="pre">None</span></code>. Similarly, with Lwt, binding on <code class="docutils literal notranslate"><span class="pre">m</span></code> would register <code class="docutils literal notranslate"><span class="pre">return</span></code>
as a callback to be run on the contents of <code class="docutils literal notranslate"><span class="pre">m</span></code> after it is resolved, and
<code class="docutils literal notranslate"><span class="pre">return</span></code> would just take those contents and put them back into an already
resolved promise.</p>
<p><em>Law 3</em> says that bind sequences effects correctly, but it’s harder to see it in
this law than it was in the version above with semicolon and braces. Law 3 would
be clearer if we could rewrite it as</p>
<blockquote>
<div><p><code class="docutils literal notranslate"><span class="pre">(m</span> <span class="pre">&gt;&gt;=</span> <span class="pre">f)</span> <span class="pre">&gt;&gt;=</span> <span class="pre">g</span></code> behaves the same as <code class="docutils literal notranslate"><span class="pre">m</span> <span class="pre">&gt;&gt;=</span> <span class="pre">(f</span> <span class="pre">&gt;&gt;=</span> <span class="pre">g)</span></code>.</p>
</div></blockquote>
<p>But the problem is that doesn’t type check: <code class="docutils literal notranslate"><span class="pre">f</span> <span class="pre">&gt;&gt;=</span> <span class="pre">g</span></code> doesn’t have the right
type to be on the right-hand side of <code class="docutils literal notranslate"><span class="pre">&gt;&gt;=</span></code>. So we have to insert an extra
anonymous function <code class="docutils literal notranslate"><span class="pre">fun</span> <span class="pre">x</span> <span class="pre">-&gt;</span> <span class="pre">...</span></code> to make the types correct.</p>
</section>
<section id="composition-and-monad-laws">
<h2><span class="section-number">8.8.6. </span>Composition and Monad Laws<a class="headerlink" href="#composition-and-monad-laws" title="Permalink to this heading">#</a></h2>
<p>There is another monad operator called <code class="docutils literal notranslate"><span class="pre">compose</span></code> that can be used to compose
monadic functions. For example, suppose you have a monad with type <code class="docutils literal notranslate"><span class="pre">'a</span> <span class="pre">t</span></code>, and
two functions:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">f</span> <span class="pre">:</span> <span class="pre">'a</span> <span class="pre">-&gt;</span> <span class="pre">'b</span> <span class="pre">t</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">g</span> <span class="pre">:</span> <span class="pre">'b</span> <span class="pre">-&gt;</span> <span class="pre">'c</span> <span class="pre">t</span></code></p></li>
</ul>
<p>The composition of those functions would be</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">compose</span> <span class="pre">f</span> <span class="pre">g</span> <span class="pre">:</span> <span class="pre">'a</span> <span class="pre">-&gt;</span> <span class="pre">'c</span> <span class="pre">t</span></code></p></li>
</ul>
<p>That is, the composition would take a value of type <code class="docutils literal notranslate"><span class="pre">'a</span></code>, apply <code class="docutils literal notranslate"><span class="pre">f</span></code> to it, extract
the <code class="docutils literal notranslate"><span class="pre">'b</span></code> out of the result, apply <code class="docutils literal notranslate"><span class="pre">g</span></code> to it, and return that value.</p>
<p>We can code up <code class="docutils literal notranslate"><span class="pre">compose</span></code> using <code class="docutils literal notranslate"><span class="pre">&gt;&gt;=</span></code>; we don’t need to know anything more about
the inner workings of the monad:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-OCaml notranslate"><div class="highlight"><pre><span></span><span class="k">let</span> <span class="n">compose</span> <span class="n">f</span> <span class="n">g</span> <span class="n">x</span> <span class="o">=</span>
  <span class="n">f</span> <span class="n">x</span> <span class="o">&gt;&gt;=</span> <span class="k">fun</span> <span class="n">y</span> <span class="o">-&gt;</span>
  <span class="n">g</span> <span class="n">y</span>

<span class="k">let</span> <span class="o">(</span> <span class="o">&gt;=&gt;</span> <span class="o">)</span> <span class="o">=</span> <span class="n">compose</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val compose :
  (&#39;a -&gt; int * string) -&gt; (int -&gt; int * string) -&gt; &#39;a -&gt; int * string = &lt;fun&gt;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val ( &gt;=&gt; ) :
  (&#39;a -&gt; int * string) -&gt; (int -&gt; int * string) -&gt; &#39;a -&gt; int * string = &lt;fun&gt;
</pre></div>
</div>
</div>
</div>
<p>As the last line suggests, <code class="docutils literal notranslate"><span class="pre">compose</span></code> can be expressed as infix operator written
<code class="docutils literal notranslate"><span class="pre">&gt;=&gt;</span></code>.</p>
<p>Returning to our example of the maybe monad with a safe division operator,
imagine that we have increment and decrement functions:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-OCaml notranslate"><div class="highlight"><pre><span></span><span class="k">let</span> <span class="n">inc</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="kt">int</span><span class="o">)</span> <span class="o">:</span> <span class="kt">int</span> <span class="n">option</span> <span class="o">=</span> <span class="nc">Some</span> <span class="o">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span>
<span class="k">let</span> <span class="n">dec</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="kt">int</span><span class="o">)</span> <span class="o">:</span> <span class="kt">int</span> <span class="n">option</span> <span class="o">=</span> <span class="nc">Some</span> <span class="o">(</span><span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span>
<span class="k">let</span> <span class="o">(</span> <span class="o">&gt;&gt;=</span> <span class="o">)</span> <span class="n">x</span> <span class="n">op</span> <span class="o">=</span>
  <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
  <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="nc">None</span>
  <span class="o">|</span> <span class="nc">Some</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">op</span> <span class="n">a</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val inc : int -&gt; int option = &lt;fun&gt;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val dec : int -&gt; int option = &lt;fun&gt;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val ( &gt;&gt;= ) : &#39;a option -&gt; (&#39;a -&gt; &#39;b option) -&gt; &#39;b option = &lt;fun&gt;
</pre></div>
</div>
</div>
</div>
<p>The monadic compose operator would enable us to compose those two into
an identity function without having to write any additional code:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-OCaml notranslate"><div class="highlight"><pre><span></span><span class="k">let</span> <span class="o">(</span> <span class="o">&gt;=&gt;</span> <span class="o">)</span> <span class="n">f</span> <span class="n">g</span> <span class="n">x</span> <span class="o">=</span>
  <span class="n">f</span> <span class="n">x</span> <span class="o">&gt;&gt;=</span> <span class="k">fun</span> <span class="n">y</span> <span class="o">-&gt;</span>
  <span class="n">g</span> <span class="n">y</span>

<span class="k">let</span> <span class="n">id</span> <span class="o">:</span> <span class="kt">int</span> <span class="o">-&gt;</span> <span class="kt">int</span> <span class="n">option</span> <span class="o">=</span> <span class="n">inc</span> <span class="o">&gt;=&gt;</span> <span class="n">dec</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val ( &gt;=&gt; ) : (&#39;a -&gt; &#39;b option) -&gt; (&#39;b -&gt; &#39;c option) -&gt; &#39;a -&gt; &#39;c option =
  &lt;fun&gt;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val id : int -&gt; int option = &lt;fun&gt;
</pre></div>
</div>
</div>
</div>
<p>Using the compose operator, there is a much cleaner formulation of the monad
laws:</p>
<ul class="simple">
<li><p><strong>Law 1:</strong> <code class="docutils literal notranslate"><span class="pre">return</span> <span class="pre">&gt;=&gt;</span> <span class="pre">f</span></code> behaves the same as <code class="docutils literal notranslate"><span class="pre">f</span></code>.</p></li>
<li><p><strong>Law 2:</strong> <code class="docutils literal notranslate"><span class="pre">f</span> <span class="pre">&gt;=&gt;</span> <span class="pre">return</span></code> behaves the same as <code class="docutils literal notranslate"><span class="pre">f</span></code>.</p></li>
<li><p><strong>Law 3:</strong> <code class="docutils literal notranslate"><span class="pre">(f</span> <span class="pre">&gt;=&gt;</span> <span class="pre">g)</span> <span class="pre">&gt;=&gt;</span> <span class="pre">h</span></code> behaves the same as <code class="docutils literal notranslate"><span class="pre">f</span> <span class="pre">&gt;=&gt;</span> <span class="pre">(g</span> <span class="pre">&gt;=&gt;</span> <span class="pre">h)</span></code>.</p></li>
</ul>
<p>In that formulation, it becomes immediately clear that <code class="docutils literal notranslate"><span class="pre">return</span></code> is a left and
right identity, and that composition is associative.</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "cs3110/textbook",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "ocaml-jupyter"
        },
        kernelOptions: {
            name: "ocaml-jupyter",
            path: "./chapters/ds"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'ocaml-jupyter'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="promises.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title"><span class="section-number">8.7. </span>Promises</p>
      </div>
    </a>
    <a class="right-next"
       href="summary.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">8.9. </span>Summary</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-monad-signature">8.8.1. The Monad Signature</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-maybe-monad">8.8.2. The Maybe Monad</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#example-the-writer-monad">8.8.3. Example: The Writer Monad</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#example-the-lwt-monad">8.8.4. Example: The Lwt Monad</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#monad-laws">8.8.5. Monad Laws</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#composition-and-monad-laws">8.8.6. Composition and Monad Laws</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Michael R. Clarkson et al.
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=bd9e20870c6007c4c509"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=bd9e20870c6007c4c509"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>