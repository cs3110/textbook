

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>9.7. Two-Three Trees &#8212; OCaml Programming: Correct + Efficient + Beautiful</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=bd9e20870c6007c4c509" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=bd9e20870c6007c4c509" />
  <script src="../../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=bd9e20870c6007c4c509"></script>

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js"></script>
    <script async="async" kind="hypothesis" src="https://hypothes.is/embed.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'chapters/ds/twothree';</script>
    <link rel="shortcut icon" href="../../_static/op.png"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="9.8. Summary" href="summary.html" />
    <link rel="prev" title="9.6. Persistent Arrays" href="parrays.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <header>


  <div class="bd-header-announcement container-fluid bd-header-announcement">
    <div class="bd-header-announcement__content">Using this book as part of a course? Please <a style="color:white" href="https://docs.google.com/forms/d/e/1FAIpQLSfEW65AJPBnk732zZZM9CFpWMobWUkym6Nf-pgslRqqwoWYIA/viewform?usp=preview">let us know</a>!</div>
  </div>

  
    <div class="bd-header navbar navbar-expand-lg bd-navbar">
    </div>
  
  </header>

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="../../cover.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/op_title.png" class="logo__image only-light" alt="OCaml Programming: Correct + Efficient + Beautiful - Home"/>
    <script>document.write(`<img src="../../_static/op_title.png" class="logo__image only-dark" alt="OCaml Programming: Correct + Efficient + Beautiful - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Preface</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../preface/about.html">About This Book</a></li>
<li class="toctree-l1"><a class="reference internal" href="../preface/install.html">Installing OCaml</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../intro/intro.html">1. Better Programming Through OCaml</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../intro/past.html">1.1. The Past of OCaml</a></li>
<li class="toctree-l2"><a class="reference internal" href="../intro/present.html">1.2. The Present of OCaml</a></li>
<li class="toctree-l2"><a class="reference internal" href="../intro/future.html">1.3. Look to Your Future</a></li>
<li class="toctree-l2"><a class="reference internal" href="../intro/3110.html">1.4. A Brief History of CS 3110</a></li>
<li class="toctree-l2"><a class="reference internal" href="../intro/summary.html">1.5. Summary</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../basics/intro.html">2. The Basics of OCaml</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../basics/toplevel.html">2.1. The OCaml Toplevel</a></li>
<li class="toctree-l2"><a class="reference internal" href="../basics/compiling.html">2.2. Compiling OCaml Programs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../basics/expressions.html">2.3. Expressions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../basics/functions.html">2.4. Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../basics/documentation.html">2.5. Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../basics/printing.html">2.6. Printing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../basics/debugging.html">2.7. Debugging</a></li>
<li class="toctree-l2"><a class="reference internal" href="../basics/summary.html">2.8. Summary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../basics/exercises.html">2.9. Exercises</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">OCaml Programming</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../data/intro.html">3. Data and Types</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-3"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../data/lists.html">3.1. Lists</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data/variants.html">3.2. Variants</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data/ounit.html">3.3. Unit Testing with OUnit</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data/records_tuples.html">3.4. Records and Tuples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data/pattern_matching_advanced.html">3.5. Advanced Pattern Matching</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data/type_synonym.html">3.6. Type Synonyms</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data/options.html">3.7. Options</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data/assoc_list.html">3.8. Association Lists</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data/algebraic_data_types.html">3.9. Algebraic Data Types</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data/exceptions.html">3.10. Exceptions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data/trees.html">3.11. Example: Trees</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data/nats.html">3.12. Example: Natural Numbers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data/summary.html">3.13. Summary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data/exercises.html">3.14. Exercises</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../hop/intro.html">4. Higher-Order Programming</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-4"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../hop/higher_order.html">4.1. Higher-Order Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hop/map.html">4.2. Map</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hop/filter.html">4.3. Filter</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hop/fold.html">4.4. Fold</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hop/beyond_lists.html">4.5. Beyond Lists</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hop/pipelining.html">4.6. Pipelining</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hop/currying.html">4.7. Currying</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hop/summary.html">4.8. Summary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hop/exercises.html">4.9. Exercises</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../modules/intro.html">5. Modular Programming</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-5"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../modules/module_systems.html">5.1. Module Systems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/modules.html">5.2. Modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/toplevel.html">5.3. Modules and the Toplevel</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/encapsulation.html">5.4. Encapsulation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/compilation_units.html">5.5. Compilation Units</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/functional_data_structures.html">5.6. Functional Data Structures</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/module_type_constraints.html">5.7. Module Type Constraints</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/includes.html">5.8. Includes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/functors.html">5.9. Functors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/summary.html">5.10. Summary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/exercises.html">5.11. Exercises</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../mut/intro.html">6. Mutability</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-6"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../mut/refs.html">6.1. Refs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mut/mutable_fields.html">6.2. Mutable Fields</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mut/arrays.html">6.3. Arrays and Loops</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mut/summary.html">6.4. Summary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mut/exercises.html">6.5. Exercises</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../conc/intro.html">7. Concurrency</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-7"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../conc/concurrency.html">7.1. Concurrency</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conc/promises.html">7.2. Promises</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conc/impl_promises.html">7.3. Implementing Promises</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conc/io_promises.html">7.4. Asynchronous Input and Output</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conc/callbacks.html">7.5. Callbacks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conc/impl_callbacks.html">7.6. Implementing Callbacks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conc/full_promises_impl.html">7.7. The Full Promises Implementation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conc/monads.html">7.8. Monads</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conc/summary.html">7.9. Summary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conc/exercises.html">7.10. Exercises</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Correctness and Efficiency</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../correctness/intro.html">8. Correctness</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-8"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../correctness/specifications.html">8.1. Specifications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../correctness/function_docs.html">8.2. Function Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../correctness/module_docs.html">8.3. Module Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../correctness/test_debug.html">8.4. Testing and Debugging</a></li>
<li class="toctree-l2"><a class="reference internal" href="../correctness/black_glass_box.html">8.5. Black-box and Glass-box Testing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../correctness/randomized.html">8.6. Randomized Testing with QCheck</a></li>
<li class="toctree-l2"><a class="reference internal" href="../correctness/proving_correctness.html">8.7. Proving Correctness</a></li>
<li class="toctree-l2"><a class="reference internal" href="../correctness/structural_induction.html">8.8. Structural Induction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../correctness/eq_spec.html">8.9. Equational Specification</a></li>
<li class="toctree-l2"><a class="reference internal" href="../correctness/summary.html">8.10. Summary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../correctness/exercises.html">8.11. Exercises</a></li>
</ul>
</li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="intro.html">9. Data Structures</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-9"><i class="fa-solid fa-chevron-down"></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="hash_tables.html">9.1. Hash Tables</a></li>
<li class="toctree-l2"><a class="reference internal" href="amortized.html">9.2. Amortized Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="rb.html">9.3. Red-Black Trees</a></li>
<li class="toctree-l2"><a class="reference internal" href="sequence.html">9.4. Sequences</a></li>
<li class="toctree-l2"><a class="reference internal" href="memoization.html">9.5. Memoization</a></li>
<li class="toctree-l2"><a class="reference internal" href="parrays.html">9.6. Persistent Arrays</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">9.7. Two-Three Trees</a></li>
<li class="toctree-l2"><a class="reference internal" href="summary.html">9.8. Summary</a></li>
<li class="toctree-l2"><a class="reference internal" href="exercises.html">9.9. Exercises</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Language Implementation</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../interp/intro.html">10. Interpreters</a><input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-10"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../interp/calculator.html">10.1. Example: Calculator</a></li>
<li class="toctree-l2"><a class="reference internal" href="../interp/parsing.html">10.2. Parsing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../interp/substitution.html">10.3. Substitution Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../interp/environment.html">10.4. Environment Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../interp/typecheck.html">10.5. Type Checking</a></li>
<li class="toctree-l2"><a class="reference internal" href="../interp/inference.html">10.6. Type Inference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../interp/summary.html">10.7. Summary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../interp/exercises.html">10.8. Exercises</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Lagniappe</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../adv/curry-howard.html">The Curry-Howard Correspondence</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Appendix</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../appendix/bigoh.html">Big-Oh Notation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../appendix/vm.html">Virtual Machine</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/cs3110/textbook/main?urlpath=tree/src/chapters/ds/twothree.md" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onBinder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../../_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="initThebeSBT()"
  class="btn btn-sm btn-launch-thebe dropdown-item"
  title="Launch Thebe"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="btn__text-container">Live Code</span>
</button>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/cs3110/textbook" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/cs3110/textbook/edit/main/src/chapters/ds/twothree.md" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/cs3110/textbook/issues/new?title=Issue%20on%20page%20%2Fchapters/ds/twothree.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/chapters/ds/twothree.ipynb" target="_blank"
   class="btn btn-sm btn-download-notebook-button dropdown-item"
   title="Download notebook file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-code"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li><a href="../../_sources/chapters/ds/twothree.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Two-Three Trees</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#representation-type">9.7.1. Representation Type</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#membership">9.7.2. Membership</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#insertion-appel-s-algorithm">9.7.3. Insertion: Appel’s Algorithm</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#merge">9.7.3.1. Merge</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#split">9.7.3.2. Split</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#finishing-insertion">9.7.3.3. Finishing Insertion</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="two-three-trees">
<h1><span class="section-number">9.7. </span>Two-Three Trees<a class="headerlink" href="#two-three-trees" title="Permalink to this heading">#</a></h1>
<p>A <em>two-three tree</em>, or <em>2-3 tree</em>, is another balanced tree data structure that can be used to implement sets and maps.
Like red-black trees, the 2-3 tree achieves logarithmic time performance while avoiding mutability.</p>
<section id="representation-type">
<h2><span class="section-number">9.7.1. </span>Representation Type<a class="headerlink" href="#representation-type" title="Permalink to this heading">#</a></h2>
<p>The 2-3 tree generalizes the binary tree, in that every node in a 2-3 tree either has two children or three children.
Those are called <em>2-nodes</em> and <em>3-nodes</em>, respectively.
A 2-node contains one value, and a 3-node contains two values:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-OCaml notranslate"><div class="highlight"><pre><span></span><span class="k">type</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span> <span class="o">=</span>
  <span class="o">|</span> <span class="nc">Leaf</span>
  <span class="o">|</span> <span class="nc">Two</span> <span class="k">of</span> <span class="o">{</span>
      <span class="n">lt</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span><span class="o">;</span> <span class="c">(* left subtree *)</span>
      <span class="n">v</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span><span class="o">;</span>    <span class="c">(* value *)</span>
      <span class="n">rt</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span>  <span class="c">(* right subtree *)</span>
    <span class="o">}</span>
  <span class="o">|</span> <span class="nc">Three</span> <span class="k">of</span> <span class="o">{</span>
      <span class="n">lt</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span><span class="o">;</span> <span class="c">(* left subtree *)</span>
      <span class="n">vl</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span><span class="o">;</span>   <span class="c">(* left value *)</span>
      <span class="n">mt</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span><span class="o">;</span> <span class="c">(* middle subtree *)</span>
      <span class="n">vr</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span><span class="o">;</span>   <span class="c">(* right value *)</span>
      <span class="n">rt</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span>  <span class="c">(* right subtree *)</span>
    <span class="o">}</span>

<span class="k">let</span> <span class="n">empty</span> <span class="o">=</span> <span class="nc">Leaf</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>type &#39;a t =
    Leaf
  | Two of { lt : &#39;a t; v : &#39;a; rt : &#39;a t; }
  | Three of { lt : &#39;a t; vl : &#39;a; mt : &#39;a t; vr : &#39;a; rt : &#39;a t; }
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val empty : &#39;a t = Leaf
</pre></div>
</div>
</div>
</div>
<p>When used to represent a set, the abstraction function is that the elements in the set are values (of type <code class="docutils literal notranslate"><span class="pre">'a</span></code>) stored in the nodes.</p>
<p>The representation invariant for a 2-3 tree has two pieces.
The first piece is the <em>ordering invariant</em>, which generalizes the BST invariant.
The ordering invariant says:</p>
<ul class="simple">
<li><p>For any two-node <code class="docutils literal notranslate"><span class="pre">{lt;</span> <span class="pre">v;</span> <span class="pre">rt}</span></code>, the values are ordered <code class="docutils literal notranslate"><span class="pre">lt</span> <span class="pre">&lt;</span> <span class="pre">v</span> <span class="pre">&lt;</span> <span class="pre">rt</span></code>, where by <code class="docutils literal notranslate"><span class="pre">lt</span> <span class="pre">&lt;</span> <span class="pre">v</span></code> we mean that all the values in <code class="docutils literal notranslate"><span class="pre">lt</span></code> are less than <code class="docutils literal notranslate"><span class="pre">v</span></code>, and symmetrically for <code class="docutils literal notranslate"><span class="pre">v</span> <span class="pre">&lt;</span> <span class="pre">rt</span></code>.</p></li>
<li><p>For any three-node <code class="docutils literal notranslate"><span class="pre">{lt;</span> <span class="pre">vl;</span> <span class="pre">mt;</span> <span class="pre">vr;</span> <span class="pre">rt}</span></code>, the values are ordered <code class="docutils literal notranslate"><span class="pre">lt</span> <span class="pre">&lt;</span> <span class="pre">vl</span> <span class="pre">&lt;</span> <span class="pre">mt</span> <span class="pre">&lt;</span> <span class="pre">vr</span> <span class="pre">&lt;</span> <span class="pre">rt</span></code>.</p></li>
</ul>
<p>The second piece of the representation invariant is the <em>balance invariant</em>, which can be stated in three equivalent ways:</p>
<ol class="arabic simple">
<li><p>Every leaf in the tree is at the same depth.</p></li>
<li><p>Every sibling in the tree is at the same height.</p></li>
<li><p>Every full path (that is, from the root to a leaf) in the tree has the same length.</p></li>
</ol>
<p>The latter is perhaps the most useful way to state the balance invariant if we want to compare to red-black trees.
Recall that red-black trees permitted path lengths to differ by up to a factor of two.
Thus, 2-3 trees are more strict about balance than red-black trees.</p>
<p>The length of every full path in a 2-3 tree is logarithmic in the number of nodes in the tree, which will yield logarithmic time operations.</p>
</section>
<section id="membership">
<h2><span class="section-number">9.7.2. </span>Membership<a class="headerlink" href="#membership" title="Permalink to this heading">#</a></h2>
<p>To check for membership in a 2-3 tree, we use a generalization of the algorithm for BST membership.
The ordering invariant tells us, at each branch, which direction to go to look for an element.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-OCaml notranslate"><div class="highlight"><pre><span></span><span class="k">let</span> <span class="k">rec</span> <span class="n">mem</span> <span class="n">x</span> <span class="o">=</span> <span class="k">function</span>
 <span class="o">|</span> <span class="nc">Leaf</span> <span class="o">-&gt;</span> <span class="bp">false</span>
 <span class="o">|</span> <span class="nc">Two</span> <span class="o">{</span> <span class="n">lt</span><span class="o">;</span> <span class="n">v</span><span class="o">;</span> <span class="n">rt</span> <span class="o">}</span> <span class="o">-&gt;</span>
     <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">v</span> <span class="k">then</span> <span class="n">mem</span> <span class="n">x</span> <span class="n">lt</span> <span class="k">else</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">v</span> <span class="k">then</span> <span class="n">mem</span> <span class="n">x</span> <span class="n">rt</span> <span class="k">else</span> <span class="bp">true</span>
 <span class="o">|</span> <span class="nc">Three</span> <span class="o">{</span> <span class="n">lt</span><span class="o">;</span> <span class="n">vl</span><span class="o">;</span> <span class="n">mt</span><span class="o">;</span> <span class="n">vr</span><span class="o">;</span> <span class="n">rt</span> <span class="o">}</span> <span class="o">-&gt;</span>
     <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">vl</span> <span class="k">then</span> <span class="n">mem</span> <span class="n">x</span> <span class="n">lt</span>
     <span class="k">else</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">vr</span> <span class="k">then</span> <span class="n">mem</span> <span class="n">x</span> <span class="n">rt</span>
     <span class="k">else</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">vl</span> <span class="o">&amp;&amp;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">vr</span> <span class="k">then</span> <span class="n">mem</span> <span class="n">x</span> <span class="n">mt</span>
     <span class="k">else</span> <span class="bp">true</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val mem : &#39;a -&gt; &#39;a t -&gt; bool = &lt;fun&gt;
</pre></div>
</div>
</div>
</div>
</section>
<section id="insertion-appel-s-algorithm">
<h2><span class="section-number">9.7.3. </span>Insertion: Appel’s Algorithm<a class="headerlink" href="#insertion-appel-s-algorithm" title="Permalink to this heading">#</a></h2>
<p>To insert an element, as usual we use the same search procedure as in <code class="docutils literal notranslate"><span class="pre">mem</span></code> to find where the element ought to be.
If the element is already in the tree, no change is made.
If the element is not already in the tree, the search ends at a leaf.
But how can we insert the new element at that leaf while maintaining the balance invariant?
The following algorithm for accomplishing that task may be folklore; if any readers know a solid citation for it, please let us know.
But for now, since Michael Clarkson learned it from Andrew Appel, we will call it Appel’s algorithm.</p>
<p>With Appel’s algorithm, we transform the leaf at which the search ends into a new 2-node with no children that contains the inserted value.
That maintains the ordering invariant, but in general violates the balance invariant, because the new 2-node causes the length of the search path to grow by one.
Another way to put that is: the height of the tree grows by one.</p>
<p>So, we recurse back up the tree to restore the balance invariant and ensure that all paths have the same length.
The goal is to find a place to <em>absorb</em> the change in height, if possible.
Since we just created a new 2-node, as we recurse up, there are two cases to consider:
the parent of the new node is a 2-node, in which case we perform a <em>merge</em> operation; or it is a 3-node, in which case we perform a <em>split</em> operation.
Those operations work as described below.</p>
<section id="merge">
<h3><span class="section-number">9.7.3.1. </span>Merge<a class="headerlink" href="#merge" title="Permalink to this heading">#</a></h3>
<p>The problem we’re trying to solve, again, is that a 2-node may have become too tall — its height might be one greater than its siblings.
Let’s call such a 2-node a <em>tall</em> node.
If a tall 2-node has a 2-node parent, then the parent can absorb the change in height, as shown in the diagram below:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>    y              x,y              x
   / \           /  |  \           / \
 *x*  c   ==&gt;   a   b   c  &lt;==    a  *y*
 / \                                 / \
a   b                               b   c
</pre></div>
</div>
<p>In that diagram, <code class="docutils literal notranslate"><span class="pre">a</span></code>, <code class="docutils literal notranslate"><span class="pre">b</span></code>, and <code class="docutils literal notranslate"><span class="pre">c</span></code> represent subtrees.
There are two cases: merging a tall node <code class="docutils literal notranslate"><span class="pre">*x*</span></code> from the left, and merging a tall node <code class="docutils literal notranslate"><span class="pre">*y*</span></code> from the right.
In either case, the tall node’s value is merged into its parent, which transforms the parent from a 2-node into a 3-node.
The extra height is absorbed, thus restoring the balance invariant.</p>
<p>After a merge occurs, we’re done with the insertion operation and can recurse all the way back up to the root without making further changes.</p>
</section>
<section id="split">
<h3><span class="section-number">9.7.3.2. </span>Split<a class="headerlink" href="#split" title="Permalink to this heading">#</a></h3>
<p>What if a tall 2-node has a 3-node parent?
Then we can’t merge, because that would create a 4-node.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>There are such things as <em>2-3-4 trees</em>, and perhaps surprisingly they are closely related to red-black trees.
But here we will stick with 2-3 trees.</p>
</div>
<p>Instead, we <em>split</em> the 3-node parent into two 2-nodes.
Together with the already existing tall 2-node, that changes a tree with two 2-nodes and one 3-node into a tree with three 2-nodes, as shown below:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>    y,z             *y*              x,y
   / | \           /   \            / | \
 *x* c  d  ==&gt;    x     z    &lt;==   a  b *z*
 / \             / \   / \              / \
a   b           a   b c   d            c   d

                     ⇑

                    x,z
                   / | \
                  a *y* d
                    / \
                   b   c
</pre></div>
</div>
<p>There are three cases to consider: splitting to accomodate a tall node from the left (<code class="docutils literal notranslate"><span class="pre">*x*</span></code>), the middle (<code class="docutils literal notranslate"><span class="pre">*y*</span></code>), or the right (<code class="docutils literal notranslate"><span class="pre">*z*</span></code>).
After the split, the new root <code class="docutils literal notranslate"><span class="pre">*y*</span></code> has become tall, but its children all have the same height.
So balance has been restored within the subtree rooted at <code class="docutils literal notranslate"><span class="pre">*y*</span></code>.
Unless that is actually the root of the entire tree, we need to continue recursing back up to the ultimate root to continue restoring balance.</p>
</section>
<section id="finishing-insertion">
<h3><span class="section-number">9.7.3.3. </span>Finishing Insertion<a class="headerlink" href="#finishing-insertion" title="Permalink to this heading">#</a></h3>
<p>To review, we decided to create a tall 2-node any time we inserted a new value.
We saw that a tall 2-node could be merged into a 2-node parent, thus restoring balance; or, a 3-node parent could be split, thus creating a new tall 2-node whose height we continue to try to absorb higher in the tree.
Note that we have never produced a tall 3-node as a result of any of these insert, merge, or split operations.
Therefore, we do not have to consider any cases for merging or splitting with a tall 3-node.
That means we’ve finished designing the algorithm.</p>
<p>We can implement insertion as shown below.
Each helper function returns a pair of a tree and a boolean, where the boolean indicates whether the tree has grown or not — that is, whether the root of the returned tree is tall.</p>
<p>The code is considerably longer than red-black tree insertion.
In part that’s because of all the comments we’ve added to explain it.
But also, having two different node shapes (2-node vs. 3-node) inherently makes the code more complicated.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-OCaml notranslate"><div class="highlight"><pre><span></span><span class="k">let</span> <span class="n">impossible</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">failwith</span> <span class="s2">&quot;impossible: grow returns Two&quot;</span>

<span class="c">(** [ins x t] inserts [x] into [t] using Appel&#39;s algorithm. Returns:</span>
<span class="c">    [new_t, grew], where [new_t] is the new tree (including [x]) and [grew] is</span>
<span class="c">    whether the tree height grew. *)</span>
<span class="k">let</span> <span class="k">rec</span> <span class="n">ins</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span><span class="o">)</span> <span class="o">(</span><span class="n">t</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span><span class="o">)</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span> <span class="o">*</span> <span class="kt">bool</span> <span class="o">=</span>
  <span class="k">match</span> <span class="n">t</span> <span class="k">with</span>
  <span class="o">|</span> <span class="nc">Leaf</span> <span class="o">-&gt;</span>
      <span class="c">(* Insertion into a leaf creates a new 2-node, which grows the</span>
<span class="c">          height. *)</span>
      <span class="o">(</span><span class="nc">Two</span> <span class="o">{</span> <span class="n">lt</span> <span class="o">=</span> <span class="nc">Leaf</span><span class="o">;</span> <span class="n">v</span> <span class="o">=</span> <span class="n">x</span><span class="o">;</span> <span class="n">rt</span> <span class="o">=</span> <span class="nc">Leaf</span> <span class="o">},</span> <span class="bp">true</span><span class="o">)</span>
  <span class="o">|</span> <span class="nc">Two</span> <span class="o">{</span> <span class="n">lt</span><span class="o">;</span> <span class="n">v</span><span class="o">;</span> <span class="n">rt</span> <span class="o">}</span> <span class="o">-&gt;</span>
      <span class="k">if</span> <span class="n">x</span> <span class="o">=</span> <span class="n">v</span> <span class="k">then</span>
        <span class="c">(* If [x] is already in the tree, no change is needed. *)</span>
        <span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="bp">false</span><span class="o">)</span>
      <span class="k">else</span>
        <span class="c">(* Otherwise, insert [x] into the left or right subtree, and</span>
<span class="c">            incorporate the current 2-node into the result *)</span>
        <span class="n">ins_sub2</span> <span class="n">x</span> <span class="n">lt</span> <span class="n">v</span> <span class="n">rt</span>
  <span class="o">|</span> <span class="nc">Three</span> <span class="o">{</span> <span class="n">lt</span><span class="o">;</span> <span class="n">vl</span><span class="o">;</span> <span class="n">mt</span><span class="o">;</span> <span class="n">vr</span><span class="o">;</span> <span class="n">rt</span> <span class="o">}</span> <span class="o">-&gt;</span>
      <span class="k">if</span> <span class="n">x</span> <span class="o">=</span> <span class="n">vl</span> <span class="o">||</span> <span class="n">x</span> <span class="o">=</span> <span class="n">vr</span> <span class="k">then</span>
        <span class="c">(* If [x] is already in the tree, no change is needed. *)</span>
        <span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="bp">false</span><span class="o">)</span>
      <span class="k">else</span>
        <span class="c">(* Otherwise, insert [x] into the left, middle, or right subtree, and</span>
<span class="c">            incorporate the current 3-node into the result*)</span>
        <span class="n">ins_sub3</span> <span class="n">x</span> <span class="n">lt</span> <span class="n">vl</span> <span class="n">mt</span> <span class="n">vr</span> <span class="n">rt</span>

<span class="c">(** [ins_sub2 x lt v rt] inserts [x] into one of the subtrees of a 2-node,</span>
<span class="c">    where that two-node is [Two {lt; v; rt}]. Returns [new_t, grew], where</span>
<span class="c">    [new_t] is the new tree (including [lt], [v], and [rt]) and [grew] is</span>
<span class="c">    whether the tree height grew as a result of the insert. Requires:</span>
<span class="c">    [x &lt;&gt; v]. *)</span>
<span class="k">and</span> <span class="n">ins_sub2</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span><span class="o">)</span> <span class="o">(</span><span class="n">lt</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span><span class="o">)</span> <span class="o">(</span><span class="n">v</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span><span class="o">)</span> <span class="o">(</span><span class="n">rt</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span><span class="o">)</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span> <span class="o">*</span> <span class="kt">bool</span> <span class="o">=</span>
  <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">v</span> <span class="k">then</span>
    <span class="c">(* [x] belongs in [lt]. *)</span>
    <span class="n">ins_sub2_left</span> <span class="n">x</span> <span class="n">lt</span> <span class="n">v</span> <span class="n">rt</span>
  <span class="k">else</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">v</span> <span class="k">then</span> <span class="c">(* [x] belongs in [rt]. *)</span>
    <span class="n">ins_sub2_right</span> <span class="n">x</span> <span class="n">lt</span> <span class="n">v</span> <span class="n">rt</span>
  <span class="k">else</span>
    <span class="c">(* [x] belongs in neither [lt] nor [rt], but then we should never have</span>
<span class="c">        called [ins_sub2] on it. *)</span>
    <span class="n">failwith</span> <span class="s2">&quot;precondition violated&quot;</span>

<span class="c">(** [ins_sub2_left x lt v rt] inserts [x] into the left subtree of a 2-node,</span>
<span class="c">    where that two-node is [Two {lt; v; rt}]. Returns [new_t, grew], where</span>
<span class="c">    [new_t] is the new tree (including [lt], [v], and [rt]) and [grew] is</span>
<span class="c">    whether the tree height grew as a result of the insert. *)</span>
<span class="k">and</span> <span class="n">ins_sub2_left</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span><span class="o">)</span> <span class="o">(</span><span class="n">lt</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span><span class="o">)</span> <span class="o">(</span><span class="n">v</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span><span class="o">)</span> <span class="o">(</span><span class="n">rt</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span><span class="o">)</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span> <span class="o">*</span> <span class="kt">bool</span> <span class="o">=</span>
  <span class="k">match</span> <span class="n">ins</span> <span class="n">x</span> <span class="n">lt</span> <span class="k">with</span>
  <span class="o">|</span> <span class="n">new_lt</span><span class="o">,</span> <span class="bp">false</span> <span class="o">-&gt;</span>
      <span class="c">(* [x] was inserted into [lt] without growing the height, so we can</span>
<span class="c">          safely reattach the resulting subtree without doing any more work to</span>
<span class="c">          rebalance. *)</span>
      <span class="o">(</span><span class="nc">Two</span> <span class="o">{</span> <span class="n">lt</span> <span class="o">=</span> <span class="n">new_lt</span><span class="o">;</span> <span class="n">v</span><span class="o">;</span> <span class="n">rt</span> <span class="o">},</span> <span class="bp">false</span><span class="o">)</span>
  <span class="o">|</span> <span class="nc">Two</span> <span class="o">{</span> <span class="n">lt</span> <span class="o">=</span> <span class="n">child_lt</span><span class="o">;</span> <span class="n">v</span> <span class="o">=</span> <span class="n">child_v</span><span class="o">;</span> <span class="n">rt</span> <span class="o">=</span> <span class="n">child_rt</span> <span class="o">},</span> <span class="bp">true</span> <span class="o">-&gt;</span>
      <span class="c">(* [x] was inserted into [lt], and that caused [lt] to grow in height</span>
<span class="c">          and have a 2-node at its root. We can merge that 2-node into the</span>
<span class="c">          current 2-node to form a 3-node, which absorbs the change in</span>
<span class="c">          height. *)</span>
      <span class="o">(</span><span class="nc">Three</span> <span class="o">{</span> <span class="n">lt</span> <span class="o">=</span> <span class="n">child_lt</span><span class="o">;</span> <span class="n">vl</span> <span class="o">=</span> <span class="n">child_v</span><span class="o">;</span> <span class="n">mt</span> <span class="o">=</span> <span class="n">child_rt</span><span class="o">;</span> <span class="n">vr</span> <span class="o">=</span> <span class="n">v</span><span class="o">;</span> <span class="n">rt</span> <span class="o">},</span> <span class="bp">false</span><span class="o">)</span>
  <span class="o">|</span> <span class="o">_,</span> <span class="bp">true</span> <span class="o">-&gt;</span>
      <span class="c">(* Growth must produce a 2-node at the root, which would have been</span>
<span class="c">          handled by the previous branch. *)</span>
      <span class="n">impossible</span> <span class="bp">()</span>

<span class="c">(** [ins_sub2_right x lt v rt] inserts [x] into the right subtree of a 2-node,</span>
<span class="c">    where that two-node is [Two {lt; v; rt}]. Returns [new_t, grew], where</span>
<span class="c">    [new_t] is the new tree (including [lt], [v], and [rt]) and [grew] is</span>
<span class="c">    whether the tree height grew as a result of the insert. *)</span>
<span class="k">and</span> <span class="n">ins_sub2_right</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span><span class="o">)</span> <span class="o">(</span><span class="n">lt</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span><span class="o">)</span> <span class="o">(</span><span class="n">v</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span><span class="o">)</span> <span class="o">(</span><span class="n">rt</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span><span class="o">)</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span> <span class="o">*</span> <span class="kt">bool</span> <span class="o">=</span>
  <span class="k">match</span> <span class="n">ins</span> <span class="n">x</span> <span class="n">rt</span> <span class="k">with</span>
  <span class="o">|</span> <span class="n">new_rt</span><span class="o">,</span> <span class="bp">false</span> <span class="o">-&gt;</span>
      <span class="c">(* [x] was inserted into [rt] without growing the height, so we can</span>
<span class="c">          safely reattach the resulting subtree without doing any more work to</span>
<span class="c">          rebalance. *)</span>
      <span class="o">(</span><span class="nc">Two</span> <span class="o">{</span> <span class="n">lt</span><span class="o">;</span> <span class="n">v</span><span class="o">;</span> <span class="n">rt</span> <span class="o">=</span> <span class="n">new_rt</span> <span class="o">},</span> <span class="bp">false</span><span class="o">)</span>
  <span class="o">|</span> <span class="nc">Two</span> <span class="o">{</span> <span class="n">lt</span> <span class="o">=</span> <span class="n">child_lt</span><span class="o">;</span> <span class="n">v</span> <span class="o">=</span> <span class="n">child_v</span><span class="o">;</span> <span class="n">rt</span> <span class="o">=</span> <span class="n">child_rt</span> <span class="o">},</span> <span class="bp">true</span> <span class="o">-&gt;</span>
      <span class="c">(* [x] was inserted into [rt], and that caused [rt] to grow in height</span>
<span class="c">          and have a 2-node at its root. We can merge that 2-node into the</span>
<span class="c">          current 2-node to form a 3-node, which absorbs the change in</span>
<span class="c">          height. *)</span>
      <span class="o">(</span><span class="nc">Three</span> <span class="o">{</span> <span class="n">lt</span><span class="o">;</span> <span class="n">vl</span> <span class="o">=</span> <span class="n">v</span><span class="o">;</span> <span class="n">mt</span> <span class="o">=</span> <span class="n">child_lt</span><span class="o">;</span> <span class="n">vr</span> <span class="o">=</span> <span class="n">child_v</span><span class="o">;</span> <span class="n">rt</span> <span class="o">=</span> <span class="n">child_rt</span> <span class="o">},</span> <span class="bp">false</span><span class="o">)</span>
  <span class="o">|</span> <span class="o">_,</span> <span class="bp">true</span> <span class="o">-&gt;</span> <span class="n">impossible</span> <span class="bp">()</span>

<span class="c">(** [ins_sub3 x lt vl mt vr rt] inserts [x] into one of the subtrees of a</span>
<span class="c">    3-node, where that 3-node is [Three {lt; vl; mt; vr; rt}]. Returns</span>
<span class="c">    [new_t, grew], where [new_t] is the new tree (including [lt], [vl], [mt],</span>
<span class="c">    [vr], and [rt]) and [grew] is whether the tree height grew as a result of</span>
<span class="c">    the insert. Requires: [x &lt;&gt; vl &amp;&amp; x &lt;&gt; vr]. *)</span>
<span class="k">and</span> <span class="n">ins_sub3</span> <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span><span class="o">)</span> <span class="o">(</span><span class="n">lt</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span><span class="o">)</span> <span class="o">(</span><span class="n">vl</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span><span class="o">)</span> <span class="o">(</span><span class="n">mt</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span><span class="o">)</span> <span class="o">(</span><span class="n">vr</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span><span class="o">)</span> <span class="o">(</span><span class="n">rt</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span><span class="o">)</span>
    <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span> <span class="o">*</span> <span class="kt">bool</span> <span class="o">=</span>
  <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">vl</span> <span class="k">then</span>
    <span class="c">(* [x] belongs in [lt]. *)</span>
    <span class="n">ins_sub3_left</span> <span class="n">x</span> <span class="n">lt</span> <span class="n">vl</span> <span class="n">mt</span> <span class="n">vr</span> <span class="n">rt</span>
  <span class="k">else</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">vr</span> <span class="k">then</span>
    <span class="c">(* [x] belongs in [rt]. *)</span>
    <span class="n">ins_sub3_right</span> <span class="n">x</span> <span class="n">lt</span> <span class="n">vl</span> <span class="n">mt</span> <span class="n">vr</span> <span class="n">rt</span>
  <span class="k">else</span> <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">vl</span> <span class="o">&amp;&amp;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">vr</span> <span class="k">then</span>
    <span class="c">(* [x] belongs in [mt]. *)</span>
    <span class="n">ins_sub3_middle</span> <span class="n">x</span> <span class="n">lt</span> <span class="n">vl</span> <span class="n">mt</span> <span class="n">vr</span> <span class="n">rt</span>
  <span class="k">else</span>
    <span class="c">(* [x] belongs in neither [lt] nor [mt] nor [rt], but then we should never</span>
<span class="c">        have called [ins_sub3] on it. *)</span>
    <span class="n">failwith</span> <span class="s2">&quot;precondition violated&quot;</span>

<span class="c">(** [ins_sub3_left x lt vl mt vr rt] inserts [x] into the left subtree of a</span>
<span class="c">    3-node, where that 3-node is [Three {lt; vl; mt; vr; rt}]. Returns</span>
<span class="c">    [new_t, grew], where [new_t] is the new tree (including [lt], [vl], [mt],</span>
<span class="c">    [vr], and [rt]) and [grew] is whether the tree height grew as a result of</span>
<span class="c">    the insert. *)</span>
<span class="k">and</span> <span class="n">ins_sub3_left</span>
    <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span><span class="o">)</span>
    <span class="o">(</span><span class="n">lt</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span><span class="o">)</span>
    <span class="o">(</span><span class="n">vl</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span><span class="o">)</span>
    <span class="o">(</span><span class="n">mt</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span><span class="o">)</span>
    <span class="o">(</span><span class="n">vr</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span><span class="o">)</span>
    <span class="o">(</span><span class="n">rt</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span><span class="o">)</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span> <span class="o">*</span> <span class="kt">bool</span> <span class="o">=</span>
  <span class="k">match</span> <span class="n">ins</span> <span class="n">x</span> <span class="n">lt</span> <span class="k">with</span>
  <span class="o">|</span> <span class="n">new_lt</span><span class="o">,</span> <span class="bp">false</span> <span class="o">-&gt;</span>
      <span class="c">(* [x] was inserted into [lt] without growing the height, so we can</span>
<span class="c">          safely reattach the resulting subtree without doing any more work to</span>
<span class="c">          rebalance. *)</span>
      <span class="o">(</span><span class="nc">Three</span> <span class="o">{</span> <span class="n">lt</span> <span class="o">=</span> <span class="n">new_lt</span><span class="o">;</span> <span class="n">vl</span><span class="o">;</span> <span class="n">mt</span><span class="o">;</span> <span class="n">vr</span><span class="o">;</span> <span class="n">rt</span> <span class="o">},</span> <span class="bp">false</span><span class="o">)</span>
  <span class="o">|</span> <span class="nc">Two</span> <span class="o">{</span> <span class="n">lt</span> <span class="o">=</span> <span class="n">child_lt</span><span class="o">;</span> <span class="n">v</span> <span class="o">=</span> <span class="n">child_v</span><span class="o">;</span> <span class="n">rt</span> <span class="o">=</span> <span class="n">child_rt</span> <span class="o">},</span> <span class="bp">true</span> <span class="o">-&gt;</span>
      <span class="c">(* [x] was inserted into [lt], and that caused [lt] to grow in height</span>
<span class="c">          and have a 2-node at its root. We cannot merge that 2-node into the</span>
<span class="c">          current 3-node. Instead, we split the 3-node into 2-nodes, which</span>
<span class="c">          causes the growth to continue upward in the tree. *)</span>
      <span class="o">(</span> <span class="nc">Two</span>
          <span class="o">{</span>
            <span class="n">lt</span> <span class="o">=</span> <span class="nc">Two</span> <span class="o">{</span> <span class="n">lt</span> <span class="o">=</span> <span class="n">child_lt</span><span class="o">;</span> <span class="n">v</span> <span class="o">=</span> <span class="n">child_v</span><span class="o">;</span> <span class="n">rt</span> <span class="o">=</span> <span class="n">child_rt</span> <span class="o">};</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">vl</span><span class="o">;</span>
            <span class="n">rt</span> <span class="o">=</span> <span class="nc">Two</span> <span class="o">{</span> <span class="n">lt</span> <span class="o">=</span> <span class="n">mt</span><span class="o">;</span> <span class="n">v</span> <span class="o">=</span> <span class="n">vr</span><span class="o">;</span> <span class="n">rt</span> <span class="o">};</span>
          <span class="o">},</span>
        <span class="bp">true</span> <span class="o">)</span>
  <span class="o">|</span> <span class="o">_,</span> <span class="bp">true</span> <span class="o">-&gt;</span>
      <span class="c">(* Growth must produce a 2-node at the root, which would have been</span>
<span class="c">          handled by the previous branch. *)</span>
      <span class="n">impossible</span> <span class="bp">()</span>

<span class="c">(** [ins_sub3_right x lt vl mt vr rt] inserts [x] into the right subtree of a</span>
<span class="c">    3-node, where that 3-node is [Three {lt; vl; mt; vr; rt}]. Returns</span>
<span class="c">    [new_t, grew], where [new_t] is the new tree (including [lt], [vl], [mt],</span>
<span class="c">    [vr], and [rt]) and [grew] is whether the tree height grew as a result of</span>
<span class="c">    the insert. *)</span>
<span class="k">and</span> <span class="n">ins_sub3_right</span>
    <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span><span class="o">)</span>
    <span class="o">(</span><span class="n">lt</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span><span class="o">)</span>
    <span class="o">(</span><span class="n">vl</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span><span class="o">)</span>
    <span class="o">(</span><span class="n">mt</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span><span class="o">)</span>
    <span class="o">(</span><span class="n">vr</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span><span class="o">)</span>
    <span class="o">(</span><span class="n">rt</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span><span class="o">)</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span> <span class="o">*</span> <span class="kt">bool</span> <span class="o">=</span>
  <span class="k">match</span> <span class="n">ins</span> <span class="n">x</span> <span class="n">rt</span> <span class="k">with</span>
  <span class="o">|</span> <span class="n">new_rt</span><span class="o">,</span> <span class="bp">false</span> <span class="o">-&gt;</span>
      <span class="c">(* [x] was inserted into [rt] without growing the height, so we can</span>
<span class="c">          safely reattach the resulting subtree without doing any more work to</span>
<span class="c">          rebalance. *)</span>
      <span class="o">(</span><span class="nc">Three</span> <span class="o">{</span> <span class="n">lt</span><span class="o">;</span> <span class="n">vl</span><span class="o">;</span> <span class="n">mt</span><span class="o">;</span> <span class="n">vr</span><span class="o">;</span> <span class="n">rt</span> <span class="o">=</span> <span class="n">new_rt</span> <span class="o">},</span> <span class="bp">false</span><span class="o">)</span>
  <span class="o">|</span> <span class="nc">Two</span> <span class="o">{</span> <span class="n">lt</span> <span class="o">=</span> <span class="n">child_lt</span><span class="o">;</span> <span class="n">v</span> <span class="o">=</span> <span class="n">child_v</span><span class="o">;</span> <span class="n">rt</span> <span class="o">=</span> <span class="n">child_rt</span> <span class="o">},</span> <span class="bp">true</span> <span class="o">-&gt;</span>
      <span class="c">(* [x] was inserted into [rt], and that caused [rt] to grow in height</span>
<span class="c">          and have a 2-node at its root. We cannot merge that 2-node into the</span>
<span class="c">          current 3-node. Instead, we split the 3-node into 2-nodes, which</span>
<span class="c">          causes the growth to continue upward in the tree. *)</span>
      <span class="o">(</span> <span class="nc">Two</span>
          <span class="o">{</span>
            <span class="n">lt</span> <span class="o">=</span> <span class="nc">Two</span> <span class="o">{</span> <span class="n">lt</span><span class="o">;</span> <span class="n">v</span> <span class="o">=</span> <span class="n">vl</span><span class="o">;</span> <span class="n">rt</span> <span class="o">=</span> <span class="n">mt</span> <span class="o">};</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">vr</span><span class="o">;</span>
            <span class="n">rt</span> <span class="o">=</span> <span class="nc">Two</span> <span class="o">{</span> <span class="n">lt</span> <span class="o">=</span> <span class="n">child_lt</span><span class="o">;</span> <span class="n">v</span> <span class="o">=</span> <span class="n">child_v</span><span class="o">;</span> <span class="n">rt</span> <span class="o">=</span> <span class="n">child_rt</span> <span class="o">};</span>
          <span class="o">},</span>
        <span class="bp">true</span> <span class="o">)</span>
  <span class="o">|</span> <span class="o">_,</span> <span class="bp">true</span> <span class="o">-&gt;</span>
      <span class="c">(* Growth must produce a 2-node at the root, which would have been</span>
<span class="c">          handled by the previous branch. *)</span>
      <span class="n">impossible</span> <span class="bp">()</span>

<span class="c">(** [ins_sub3_middle x lt vl mt vr rt] inserts [x] into the middle subtree of</span>
<span class="c">    a 3-node, where that 3-node is [Three {lt; vl; mt; vr; rt}]. Returns</span>
<span class="c">    [new_t, grew], where [new_t] is the new tree (including [lt], [vl], [mt],</span>
<span class="c">    [vr], and [rt]) and [grew] is whether the tree height grew as a result of</span>
<span class="c">    the insert. *)</span>
<span class="k">and</span> <span class="n">ins_sub3_middle</span>
    <span class="o">(</span><span class="n">x</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span><span class="o">)</span>
    <span class="o">(</span><span class="n">lt</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span><span class="o">)</span>
    <span class="o">(</span><span class="n">vl</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span><span class="o">)</span>
    <span class="o">(</span><span class="n">mt</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span><span class="o">)</span>
    <span class="o">(</span><span class="n">vr</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span><span class="o">)</span>
    <span class="o">(</span><span class="n">rt</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span><span class="o">)</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span> <span class="o">*</span> <span class="kt">bool</span> <span class="o">=</span>
  <span class="k">match</span> <span class="n">ins</span> <span class="n">x</span> <span class="n">mt</span> <span class="k">with</span>
  <span class="o">|</span> <span class="n">new_mt</span><span class="o">,</span> <span class="bp">false</span> <span class="o">-&gt;</span>
      <span class="c">(* [x] was inserted into [mt] without growing the height, so we can</span>
<span class="c">          safely reattach the resulting subtree without doing any more work to</span>
<span class="c">          rebalance. *)</span>
      <span class="o">(</span><span class="nc">Three</span> <span class="o">{</span> <span class="n">lt</span><span class="o">;</span> <span class="n">vl</span><span class="o">;</span> <span class="n">mt</span> <span class="o">=</span> <span class="n">new_mt</span><span class="o">;</span> <span class="n">vr</span><span class="o">;</span> <span class="n">rt</span> <span class="o">},</span> <span class="bp">false</span><span class="o">)</span>
  <span class="o">|</span> <span class="nc">Two</span> <span class="o">{</span> <span class="n">lt</span> <span class="o">=</span> <span class="n">child_lt</span><span class="o">;</span> <span class="n">v</span> <span class="o">=</span> <span class="n">child_v</span><span class="o">;</span> <span class="n">rt</span> <span class="o">=</span> <span class="n">child_rt</span> <span class="o">},</span> <span class="bp">true</span> <span class="o">-&gt;</span>
      <span class="c">(* [x] was inserted into [mt], and that caused [mt] to grow in height</span>
<span class="c">          and have a 2-node at its root. We cannot merge that 2-node into the</span>
<span class="c">          current 3-node. Instead, we split the 3-node into 2-nodes, which</span>
<span class="c">          causes the growth to continue upward in the tree. *)</span>
      <span class="o">(</span> <span class="nc">Two</span>
          <span class="o">{</span>
            <span class="n">lt</span> <span class="o">=</span> <span class="nc">Two</span> <span class="o">{</span> <span class="n">lt</span><span class="o">;</span> <span class="n">v</span> <span class="o">=</span> <span class="n">vl</span><span class="o">;</span> <span class="n">rt</span> <span class="o">=</span> <span class="n">child_lt</span> <span class="o">};</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">child_v</span><span class="o">;</span>
            <span class="n">rt</span> <span class="o">=</span> <span class="nc">Two</span> <span class="o">{</span> <span class="n">lt</span> <span class="o">=</span> <span class="n">child_rt</span><span class="o">;</span> <span class="n">v</span> <span class="o">=</span> <span class="n">vr</span><span class="o">;</span> <span class="n">rt</span> <span class="o">};</span>
          <span class="o">},</span>
        <span class="bp">true</span> <span class="o">)</span>
  <span class="o">|</span> <span class="o">_,</span> <span class="bp">true</span> <span class="o">-&gt;</span>
      <span class="c">(* Growth must produce a 2-node at the root, which would have been</span>
<span class="c">          handled by the previous branch. *)</span>
      <span class="n">impossible</span> <span class="bp">()</span>

<span class="k">let</span> <span class="n">insert</span> <span class="n">x</span> <span class="n">s</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">new_tree</span><span class="o">,</span> <span class="o">_</span><span class="n">grew</span> <span class="o">=</span> <span class="n">ins</span> <span class="n">x</span> <span class="n">s</span> <span class="k">in</span>
  <span class="n">new_tree</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val impossible : unit -&gt; &#39;a = &lt;fun&gt;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val ins : &#39;a -&gt; &#39;a t -&gt; &#39;a t * bool = &lt;fun&gt;
val ins_sub2 : &#39;a -&gt; &#39;a t -&gt; &#39;a -&gt; &#39;a t -&gt; &#39;a t * bool = &lt;fun&gt;
val ins_sub2_left : &#39;a -&gt; &#39;a t -&gt; &#39;a -&gt; &#39;a t -&gt; &#39;a t * bool = &lt;fun&gt;
val ins_sub2_right : &#39;a -&gt; &#39;a t -&gt; &#39;a -&gt; &#39;a t -&gt; &#39;a t * bool = &lt;fun&gt;
val ins_sub3 : &#39;a -&gt; &#39;a t -&gt; &#39;a -&gt; &#39;a t -&gt; &#39;a -&gt; &#39;a t -&gt; &#39;a t * bool = &lt;fun&gt;
val ins_sub3_left : &#39;a -&gt; &#39;a t -&gt; &#39;a -&gt; &#39;a t -&gt; &#39;a -&gt; &#39;a t -&gt; &#39;a t * bool =
  &lt;fun&gt;
val ins_sub3_right : &#39;a -&gt; &#39;a t -&gt; &#39;a -&gt; &#39;a t -&gt; &#39;a -&gt; &#39;a t -&gt; &#39;a t * bool =
  &lt;fun&gt;
val ins_sub3_middle : &#39;a -&gt; &#39;a t -&gt; &#39;a -&gt; &#39;a t -&gt; &#39;a -&gt; &#39;a t -&gt; &#39;a t * bool =
  &lt;fun&gt;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val insert : &#39;a -&gt; &#39;a t -&gt; &#39;a t = &lt;fun&gt;
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "cs3110/textbook",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "ocaml-jupyter"
        },
        kernelOptions: {
            name: "ocaml-jupyter",
            path: "./chapters/ds"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'ocaml-jupyter'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="parrays.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title"><span class="section-number">9.6. </span>Persistent Arrays</p>
      </div>
    </a>
    <a class="right-next"
       href="summary.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">9.8. </span>Summary</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#representation-type">9.7.1. Representation Type</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#membership">9.7.2. Membership</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#insertion-appel-s-algorithm">9.7.3. Insertion: Appel’s Algorithm</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#merge">9.7.3.1. Merge</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#split">9.7.3.2. Split</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#finishing-insertion">9.7.3.3. Finishing Insertion</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Michael R. Clarkson et al.
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2025.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=bd9e20870c6007c4c509"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=bd9e20870c6007c4c509"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>