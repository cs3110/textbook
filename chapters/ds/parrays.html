

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>9.6. Persistent Arrays &#8212; OCaml Programming: Correct + Efficient + Beautiful</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=bd9e20870c6007c4c509" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=bd9e20870c6007c4c509" />
  <script src="../../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=bd9e20870c6007c4c509"></script>

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js"></script>
    <script async="async" kind="hypothesis" src="https://hypothes.is/embed.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'chapters/ds/parrays';</script>
    <link rel="shortcut icon" href="../../_static/op.png"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="9.7. Summary" href="summary.html" />
    <link rel="prev" title="9.5. Memoization" href="memoization.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <header>


  <div class="bd-header-announcement container-fluid bd-header-announcement">
    <div class="bd-header-announcement__content">Using this book as part of a course? Please <a style="color:white" href="https://docs.google.com/forms/d/e/1FAIpQLSfEW65AJPBnk732zZZM9CFpWMobWUkym6Nf-pgslRqqwoWYIA/viewform?usp=preview">let us know</a>!</div>
  </div>

  
    <div class="bd-header navbar navbar-expand-lg bd-navbar">
    </div>
  
  </header>

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="../../cover.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/op_title.png" class="logo__image only-light" alt="OCaml Programming: Correct + Efficient + Beautiful - Home"/>
    <script>document.write(`<img src="../../_static/op_title.png" class="logo__image only-dark" alt="OCaml Programming: Correct + Efficient + Beautiful - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Preface</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../preface/about.html">About This Book</a></li>
<li class="toctree-l1"><a class="reference internal" href="../preface/install.html">Installing OCaml</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../intro/intro.html">1. Better Programming Through OCaml</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../intro/past.html">1.1. The Past of OCaml</a></li>
<li class="toctree-l2"><a class="reference internal" href="../intro/present.html">1.2. The Present of OCaml</a></li>
<li class="toctree-l2"><a class="reference internal" href="../intro/future.html">1.3. Look to Your Future</a></li>
<li class="toctree-l2"><a class="reference internal" href="../intro/3110.html">1.4. A Brief History of CS 3110</a></li>
<li class="toctree-l2"><a class="reference internal" href="../intro/summary.html">1.5. Summary</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../basics/intro.html">2. The Basics of OCaml</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../basics/toplevel.html">2.1. The OCaml Toplevel</a></li>
<li class="toctree-l2"><a class="reference internal" href="../basics/compiling.html">2.2. Compiling OCaml Programs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../basics/expressions.html">2.3. Expressions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../basics/functions.html">2.4. Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../basics/documentation.html">2.5. Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../basics/printing.html">2.6. Printing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../basics/debugging.html">2.7. Debugging</a></li>
<li class="toctree-l2"><a class="reference internal" href="../basics/summary.html">2.8. Summary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../basics/exercises.html">2.9. Exercises</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">OCaml Programming</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../data/intro.html">3. Data and Types</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-3"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../data/lists.html">3.1. Lists</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data/variants.html">3.2. Variants</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data/ounit.html">3.3. Unit Testing with OUnit</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data/records_tuples.html">3.4. Records and Tuples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data/pattern_matching_advanced.html">3.5. Advanced Pattern Matching</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data/type_synonym.html">3.6. Type Synonyms</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data/options.html">3.7. Options</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data/assoc_list.html">3.8. Association Lists</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data/algebraic_data_types.html">3.9. Algebraic Data Types</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data/exceptions.html">3.10. Exceptions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data/trees.html">3.11. Example: Trees</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data/nats.html">3.12. Example: Natural Numbers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data/summary.html">3.13. Summary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data/exercises.html">3.14. Exercises</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../hop/intro.html">4. Higher-Order Programming</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-4"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../hop/higher_order.html">4.1. Higher-Order Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hop/map.html">4.2. Map</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hop/filter.html">4.3. Filter</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hop/fold.html">4.4. Fold</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hop/beyond_lists.html">4.5. Beyond Lists</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hop/pipelining.html">4.6. Pipelining</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hop/currying.html">4.7. Currying</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hop/summary.html">4.8. Summary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hop/exercises.html">4.9. Exercises</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../modules/intro.html">5. Modular Programming</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-5"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../modules/module_systems.html">5.1. Module Systems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/modules.html">5.2. Modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/toplevel.html">5.3. Modules and the Toplevel</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/encapsulation.html">5.4. Encapsulation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/compilation_units.html">5.5. Compilation Units</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/functional_data_structures.html">5.6. Functional Data Structures</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/module_type_constraints.html">5.7. Module Type Constraints</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/includes.html">5.8. Includes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/functors.html">5.9. Functors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/summary.html">5.10. Summary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/exercises.html">5.11. Exercises</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../mut/intro.html">6. Mutability</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-6"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../mut/refs.html">6.1. Refs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mut/mutable_fields.html">6.2. Mutable Fields</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mut/arrays.html">6.3. Arrays and Loops</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mut/summary.html">6.4. Summary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mut/exercises.html">6.5. Exercises</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../conc/intro.html">7. Concurrency</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-7"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../conc/concurrency.html">7.1. Concurrency</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conc/promises.html">7.2. Promises</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conc/impl_promises.html">7.3. Implementing Promises</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conc/io_promises.html">7.4. Asynchronous Input and Output</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conc/callbacks.html">7.5. Callbacks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conc/impl_callbacks.html">7.6. Implementing Callbacks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conc/full_promises_impl.html">7.7. The Full Promises Implementation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conc/monads.html">7.8. Monads</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conc/summary.html">7.9. Summary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../conc/exercises.html">7.10. Exercises</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Correctness and Efficiency</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../correctness/intro.html">8. Correctness</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-8"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../correctness/specifications.html">8.1. Specifications</a></li>
<li class="toctree-l2"><a class="reference internal" href="../correctness/function_docs.html">8.2. Function Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../correctness/module_docs.html">8.3. Module Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../correctness/test_debug.html">8.4. Testing and Debugging</a></li>
<li class="toctree-l2"><a class="reference internal" href="../correctness/black_glass_box.html">8.5. Black-box and Glass-box Testing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../correctness/randomized.html">8.6. Randomized Testing with QCheck</a></li>
<li class="toctree-l2"><a class="reference internal" href="../correctness/proving_correctness.html">8.7. Proving Correctness</a></li>
<li class="toctree-l2"><a class="reference internal" href="../correctness/structural_induction.html">8.8. Structural Induction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../correctness/eq_spec.html">8.9. Equational Specification</a></li>
<li class="toctree-l2"><a class="reference internal" href="../correctness/summary.html">8.10. Summary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../correctness/exercises.html">8.11. Exercises</a></li>
</ul>
</li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="intro.html">9. Data Structures</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-9"><i class="fa-solid fa-chevron-down"></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="hash_tables.html">9.1. Hash Tables</a></li>
<li class="toctree-l2"><a class="reference internal" href="amortized.html">9.2. Amortized Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="rb.html">9.3. Red-Black Trees</a></li>
<li class="toctree-l2"><a class="reference internal" href="sequence.html">9.4. Sequences</a></li>
<li class="toctree-l2"><a class="reference internal" href="memoization.html">9.5. Memoization</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">9.6. Persistent Arrays</a></li>
<li class="toctree-l2"><a class="reference internal" href="summary.html">9.7. Summary</a></li>
<li class="toctree-l2"><a class="reference internal" href="exercises.html">9.8. Exercises</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Language Implementation</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../interp/intro.html">10. Interpreters</a><input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-10"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../interp/calculator.html">10.1. Example: Calculator</a></li>
<li class="toctree-l2"><a class="reference internal" href="../interp/parsing.html">10.2. Parsing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../interp/substitution.html">10.3. Substitution Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../interp/environment.html">10.4. Environment Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../interp/typecheck.html">10.5. Type Checking</a></li>
<li class="toctree-l2"><a class="reference internal" href="../interp/inference.html">10.6. Type Inference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../interp/summary.html">10.7. Summary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../interp/exercises.html">10.8. Exercises</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Lagniappe</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../adv/curry-howard.html">The Curry-Howard Correspondence</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Appendix</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../appendix/bigoh.html">Big-Oh Notation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../appendix/vm.html">Virtual Machine</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/cs3110/textbook/main?urlpath=tree/src/chapters/ds/parrays.md" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onBinder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../../_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="initThebeSBT()"
  class="btn btn-sm btn-launch-thebe dropdown-item"
  title="Launch Thebe"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="btn__text-container">Live Code</span>
</button>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/cs3110/textbook" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/cs3110/textbook/edit/main/src/chapters/ds/parrays.md" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/cs3110/textbook/issues/new?title=Issue%20on%20page%20%2Fchapters/ds/parrays.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/chapters/ds/parrays.ipynb" target="_blank"
   class="btn btn-sm btn-download-notebook-button dropdown-item"
   title="Download notebook file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-code"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li><a href="../../_sources/chapters/ds/parrays.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Persistent Arrays</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#copy-on-set-arrays">9.6.1. Copy-On-Set Arrays</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#version-tree-arrays">9.6.2. Version-Tree Arrays</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#rebasing-version-tree-arrays">9.6.3. Rebasing Version-Tree Arrays</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#citations">9.6.4. Citations</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="persistent-arrays">
<h1><span class="section-number">9.6. </span>Persistent Arrays<a class="headerlink" href="#persistent-arrays" title="Permalink to this heading">#</a></h1>
<p>OCaml’s built-in <code class="docutils literal notranslate"><span class="pre">array</span></code> type offers constant-time get and set operations. But it is an ephemeral data structure. That leads to the question: could we have persistent arrays, and if so, how good of performance could we get?</p>
<p>Here is the interface we would like to implement:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-OCaml notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="k">type</span> <span class="nc">PersistentArray</span> <span class="o">=</span> <span class="k">sig</span>
  <span class="k">type</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span>
  <span class="c">(** The type of persistent arrays whose elements have type [&#39;a]. The</span>
<span class="c">      array indexing is zero based, meaning that the first element is at</span>
<span class="c">      index [0], and the last element is at index [n - 1], where [n] is </span>
<span class="c">      the length of the array. Any index less than [0] or greater</span>
<span class="c">      than [n - 1] is out of bounds. *)</span>

  <span class="k">val</span> <span class="n">make</span> <span class="o">:</span> <span class="kt">int</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span>
  <span class="c">(** [make n x] is a persistent array of length [n], with each element</span>
<span class="c">      initialized to [x]. Raises [Invalid_argument] if [n] is negative</span>
<span class="c">      or too large for the system. *)</span>

  <span class="k">val</span> <span class="n">length</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="kt">int</span>
  <span class="c">(** [length a] is the number of elements in [a]. *)</span>

  <span class="k">val</span> <span class="n">get</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="kt">int</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span>
  <span class="c">(** [get a i] is the element at index [i] in [a]. Raises [Invalid_argument]</span>
<span class="c">      if [i] is out of bounds. *)</span>

  <span class="k">val</span> <span class="n">set</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="kt">int</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span>
  <span class="c">(** [set a i x] is an array that stores [x] at index [i] and otherwise is</span>
<span class="c">      the same as [a]. Raises: [Invalid_argument] if [i] is out of bounds. *)</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>module type PersistentArray =
  sig
    type &#39;a t
    val make : int -&gt; &#39;a -&gt; &#39;a t
    val length : &#39;a t -&gt; int
    val get : &#39;a t -&gt; int -&gt; &#39;a
    val set : &#39;a t -&gt; int -&gt; &#39;a -&gt; &#39;a t
  end
</pre></div>
</div>
</div>
</div>
<p>That interface essentially the same as OCaml’s <code class="docutils literal notranslate"><span class="pre">Array</span></code> module, but reduced to just four essential functions.</p>
<p>We’ll next see three implementations of that interface. Each will achieve progressively better performance. Our final implementation is based on Conchon and Filliâtre (2007); see the end of this section for citations.</p>
<section id="copy-on-set-arrays">
<h2><span class="section-number">9.6.1. </span>Copy-On-Set Arrays<a class="headerlink" href="#copy-on-set-arrays" title="Permalink to this heading">#</a></h2>
<p>The easiest implementation of persistent arrays is to just make a copy of the entire array on each <code class="docutils literal notranslate"><span class="pre">set</span></code> operation. That way, old copies of the array persist—they are not changed by later <code class="docutils literal notranslate"><span class="pre">set</span></code> operations. Here is the implementation:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-OCaml notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="nc">CopyOnSetArray</span> <span class="o">:</span> <span class="nc">PersistentArray</span> <span class="o">=</span> <span class="k">struct</span>
  <span class="k">type</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span> <span class="o">=</span> <span class="k">&#39;</span><span class="n">a</span> <span class="kt">array</span>

  <span class="c">(** Efficiency: O(n). *)</span>
  <span class="k">let</span> <span class="n">make</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">make</span>

  <span class="c">(** Efficiency: O(1). *)</span>
  <span class="k">let</span> <span class="n">length</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span>

  <span class="c">(** Efficiency: O(1). *)</span>
  <span class="k">let</span> <span class="n">get</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">get</span>
  
  <span class="c">(** Efficiency: O(n). *)</span>
  <span class="k">let</span> <span class="n">set</span> <span class="n">a</span> <span class="n">i</span> <span class="n">x</span> <span class="o">=</span>
    <span class="k">let</span> <span class="n">a&#39;</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">copy</span> <span class="n">a</span> <span class="k">in</span> <span class="c">(* copy the array *)</span>
    <span class="n">a&#39;</span><span class="o">.(</span><span class="n">i</span><span class="o">)</span> <span class="o">&lt;-</span> <span class="n">x</span><span class="o">;</span> <span class="c">(* mutate one element *)</span>
    <span class="n">a&#39;</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>module CopyOnSetArray : PersistentArray
</pre></div>
</div>
</div>
</div>
<p>We pay a large price for <code class="docutils literal notranslate"><span class="pre">set</span></code> in this implementation: instead of <span class="math notranslate nohighlight">\(O(1)\)</span> like <code class="docutils literal notranslate"><span class="pre">array</span></code>, it is <span class="math notranslate nohighlight">\(O(n)\)</span>. We’ll improve on that in our next implementation.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Before moving on, let’s pause and consider one aspect of <code class="docutils literal notranslate"><span class="pre">CopyOnSetArray</span></code> that is different than any data structure we’ve seen before. The interface it satisfies is written in the functional style, but the implementation uses imperative features. Note that the <code class="docutils literal notranslate"><span class="pre">set</span></code> operation does not return <code class="docutils literal notranslate"><span class="pre">unit</span></code>; instead, it produces a new array out of an old array. Underneath the hood, it achieves that persistence despite using an ephemeral data structure, the <code class="docutils literal notranslate"><span class="pre">array</span></code>. A lesson we can learn is that it is possible to build persistent data structures in imperative languages using the features they provide.</p>
</div>
</section>
<section id="version-tree-arrays">
<h2><span class="section-number">9.6.2. </span>Version-Tree Arrays<a class="headerlink" href="#version-tree-arrays" title="Permalink to this heading">#</a></h2>
<p>The expensive <code class="docutils literal notranslate"><span class="pre">set</span></code> operation in copy-on-set is doing way too much work. Even though only one array element is being changed, all of the array elements are copied. To achieve better performance, we could eliminate the copying and instead keep a little log of all the <code class="docutils literal notranslate"><span class="pre">set</span></code> operations that have occurred. Each entry in the log would need to record just one change that has been made. For example, suppose we had the following sequence of operations:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">let</span> <span class="n">a0</span> <span class="o">=</span> <span class="n">make</span> <span class="mi">3</span> <span class="mi">0</span>
<span class="n">let</span> <span class="n">a1</span> <span class="o">=</span> <span class="nb">set</span> <span class="n">a0</span> <span class="mi">1</span> <span class="mi">7</span>
<span class="n">let</span> <span class="n">a2</span> <span class="o">=</span> <span class="nb">set</span> <span class="n">a1</span> <span class="mi">2</span> <span class="mi">8</span>
<span class="n">let</span> <span class="n">a3</span> <span class="o">=</span> <span class="nb">set</span> <span class="n">a1</span> <span class="mi">2</span> <span class="mi">9</span>
</pre></div>
</div>
<p>Our log would say:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">a0</span></code> is <code class="docutils literal notranslate"><span class="pre">[|0;</span> <span class="pre">0;</span> <span class="pre">0|]</span></code>. That takes linear space to store.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">a1</span></code> is the same as <code class="docutils literal notranslate"><span class="pre">a0</span></code> except that index <code class="docutils literal notranslate"><span class="pre">1</span></code> is <code class="docutils literal notranslate"><span class="pre">7</span></code>. That takes only constant space to store.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">a2</span></code> is the same as <code class="docutils literal notranslate"><span class="pre">a1</span></code> except that index <code class="docutils literal notranslate"><span class="pre">2</span></code> is <code class="docutils literal notranslate"><span class="pre">8</span></code>. Again, constant space.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">a3</span></code> is the same as <code class="docutils literal notranslate"><span class="pre">a1</span></code> except that index <code class="docutils literal notranslate"><span class="pre">2</span></code> is <code class="docutils literal notranslate"><span class="pre">9</span></code>. Again, constant space.</p></li>
</ul>
<p>Note how both <code class="docutils literal notranslate"><span class="pre">a2</span></code> and <code class="docutils literal notranslate"><span class="pre">a3</span></code> share the same base array <code class="docutils literal notranslate"><span class="pre">a1</span></code>, but diverge in different ways by setting index <code class="docutils literal notranslate"><span class="pre">2</span></code> to either <code class="docutils literal notranslate"><span class="pre">8</span></code> or <code class="docutils literal notranslate"><span class="pre">9</span></code>. So the structure of this log is best represented not as a list, but as a tree:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>       (entry for a0)
             |
       (entry for a1)
       /            \
(entry for a2)     (entry for a3)
</pre></div>
</div>
<p>Each of the nodes in that tree tell us what different <em>versions</em> of the array should be. That idea leads us to introduce the following tree type:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-OCaml notranslate"><div class="highlight"><pre><span></span><span class="k">type</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">version_tree</span> <span class="o">=</span>
  <span class="o">|</span> <span class="nc">Base</span> <span class="k">of</span> <span class="k">&#39;</span><span class="n">a</span> <span class="kt">array</span>
  <span class="o">|</span> <span class="nc">Diff</span> <span class="k">of</span> <span class="kt">int</span> <span class="o">*</span> <span class="k">&#39;</span><span class="n">a</span> <span class="o">*</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">version_tree</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>type &#39;a version_tree = Base of &#39;a array | Diff of int * &#39;a * &#39;a version_tree
</pre></div>
</div>
</div>
</div>
<p>A <code class="docutils literal notranslate"><span class="pre">Base</span></code> node contains the base version of the array; in our example above, that would be <code class="docutils literal notranslate"><span class="pre">a0</span></code>. A <code class="docutils literal notranslate"><span class="pre">Diff</span></code> node records a difference that is created by a <code class="docutils literal notranslate"><span class="pre">set</span></code> operation. The version tree for our example above would look like this:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>              (Base [|0; 0; 0|])      &lt;---- a0
                      |
                  (Diff 1 7)          &lt;---- a1
                 /          \
a2 ----&gt; (Diff 2 8)        (Diff 2 9) &lt;---- a3
</pre></div>
</div>
<p>The tree itself is shown in the middle of that diagram. The pointers for <code class="docutils literal notranslate"><span class="pre">a0</span></code> through <code class="docutils literal notranslate"><span class="pre">a3</span></code> are to individual nodes of that tree and capture each of the persistent versions of the array.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>In understanding this version tree type, there is a possibly helpful analogy to association lists. Each of the <code class="docutils literal notranslate"><span class="pre">Diff</span></code> nodes is like a cons cell in an association list: both contain a pair of a key (the array index) and a value (the element at that index). Moreover each cons cell then continues onto another cons cell until eventually reaching the the base case of nil, just like a version tree eventually reaches the base case of a <code class="docutils literal notranslate"><span class="pre">Base</span></code> node. The <code class="docutils literal notranslate"><span class="pre">Base</span></code> node is a little more interesting than the empty list though, because it contains an entire array.</p>
</div>
<p><strong>Set.</strong> To implement <code class="docutils literal notranslate"><span class="pre">set</span> <span class="pre">a</span> <span class="pre">i</span> <span class="pre">x</span></code>, all we have to do is create a new <code class="docutils literal notranslate"><span class="pre">Diff</span></code> node:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-OCaml notranslate"><div class="highlight"><pre><span></span><span class="k">let</span> <span class="n">set</span> <span class="n">a</span> <span class="n">i</span> <span class="n">x</span> <span class="o">=</span> <span class="nc">Diff</span> <span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="n">x</span><span class="o">,</span> <span class="n">a</span><span class="o">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val set : &#39;a version_tree -&gt; int -&gt; &#39;a -&gt; &#39;a version_tree = &lt;fun&gt;
</pre></div>
</div>
</div>
</div>
<p>The efficiency of that is merely <span class="math notranslate nohighlight">\(O(1)\)</span>, which is a great improvement over copy-on-set arrays.</p>
<p><strong>Get.</strong> To implement <code class="docutils literal notranslate"><span class="pre">get</span> <span class="pre">a</span> <span class="pre">i</span></code>, we just have to walk a path in the tree starting at <code class="docutils literal notranslate"><span class="pre">a</span></code> to find the first <code class="docutils literal notranslate"><span class="pre">Diff</span></code> that records a change in index <code class="docutils literal notranslate"><span class="pre">i</span></code>. If there never is such a change found, we can return the value at that index in the <code class="docutils literal notranslate"><span class="pre">Base</span></code> node:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-OCaml notranslate"><div class="highlight"><pre><span></span><span class="k">let</span> <span class="k">rec</span> <span class="n">get</span> <span class="n">a</span> <span class="n">i</span> <span class="o">=</span>
  <span class="k">match</span> <span class="n">a</span> <span class="k">with</span>
  <span class="o">|</span> <span class="nc">Base</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">b</span><span class="o">.(</span><span class="n">i</span><span class="o">)</span>
  <span class="o">|</span> <span class="nc">Diff</span> <span class="o">(</span><span class="n">j</span><span class="o">,</span> <span class="n">v</span><span class="o">,</span> <span class="n">a&#39;</span><span class="o">)</span> <span class="o">-&gt;</span>
      <span class="k">if</span> <span class="n">i</span> <span class="o">=</span> <span class="n">j</span> <span class="k">then</span> <span class="n">v</span> <span class="k">else</span> <span class="n">get</span> <span class="n">a&#39;</span> <span class="n">i</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val get : &#39;a version_tree -&gt; int -&gt; &#39;a = &lt;fun&gt;
</pre></div>
</div>
</div>
</div>
<p>The efficiency of that implementation is <span class="math notranslate nohighlight">\(O(k)\)</span>, where <span class="math notranslate nohighlight">\(k\)</span> is the number of <code class="docutils literal notranslate"><span class="pre">set</span></code> operations that have been performed on the persistent array. In the worst case, all of those <code class="docutils literal notranslate"><span class="pre">set</span></code> operations were performed on a different index than we want to <code class="docutils literal notranslate"><span class="pre">get</span></code>, and they were all performed without creating any branches in the tree — for example, <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">2</span> <span class="pre">0</span> <span class="pre">|&gt;</span> <span class="pre">set</span> <span class="pre">0</span> <span class="pre">1</span> <span class="pre">|&gt;</span> <span class="pre">set</span> <span class="pre">0</span> <span class="pre">2</span> <span class="pre">|&gt;</span> <span class="pre">...</span> <span class="pre">|&gt;</span> <span class="pre">set</span> <span class="pre">0</span> <span class="pre">k</span> <span class="pre">|&gt;</span> <span class="pre">get</span> <span class="pre">1</span></code>. Then the tree degenerates to a linked list, and <code class="docutils literal notranslate"><span class="pre">get</span></code> is forced to walk down the entire list to the <code class="docutils literal notranslate"><span class="pre">Base</span></code> node to find the original value.</p>
<p>Note that <span class="math notranslate nohighlight">\(k\)</span> might be much bigger or much smaller than <span class="math notranslate nohighlight">\(n\)</span>, the size of the array. So in improving the performance of <code class="docutils literal notranslate"><span class="pre">set</span></code>, we potentially worsened the performance of <code class="docutils literal notranslate"><span class="pre">get</span></code>. In our next implementation, we’ll return to this issue and improve the performance of <code class="docutils literal notranslate"><span class="pre">get</span></code>.</p>
<p><strong>Version-tree implementation.</strong> Pulling it all together, here is an implementation of persistent arrays using version trees:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-OCaml notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="nc">VersionTreeArray</span> <span class="o">:</span> <span class="nc">PersistentArray</span> <span class="o">=</span> <span class="k">struct</span>
  <span class="c">(** AF: A rep such as [Diff (i, x, Diff (j, y, Base a))] represents the </span>
<span class="c">      array [a] except element [j] is [y] and element [i] is [x]. If there </span>
<span class="c">      are multiple diffs for an index, the outermost wins. E.g.,</span>
<span class="c">      [Diff (i, x, Diff (i, y, Base a))] represents an array whose </span>
<span class="c">      element [i] is [x], not [y]. *)</span>
  <span class="k">type</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span> <span class="o">=</span>
    <span class="o">|</span> <span class="nc">Base</span> <span class="k">of</span> <span class="k">&#39;</span><span class="n">a</span> <span class="kt">array</span>
    <span class="o">|</span> <span class="nc">Diff</span> <span class="k">of</span> <span class="kt">int</span> <span class="o">*</span> <span class="k">&#39;</span><span class="n">a</span> <span class="o">*</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span>

  <span class="c">(** Efficiency: O(n). *)</span>
  <span class="k">let</span> <span class="n">make</span> <span class="n">n</span> <span class="n">x</span> <span class="o">=</span> <span class="nc">Base</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">make</span> <span class="n">n</span> <span class="n">x</span><span class="o">)</span>

  <span class="c">(** Efficiency: O(k), where k is the number of [set] operations that have</span>
<span class="c">      been performed on the array. *)</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">length</span> <span class="o">=</span> <span class="k">function</span>
    <span class="o">|</span> <span class="nc">Base</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="n">b</span>
    <span class="o">|</span> <span class="nc">Diff</span> <span class="o">(_,</span> <span class="o">_,</span> <span class="n">a</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">length</span> <span class="n">a</span>

  <span class="c">(** Efficiency: O(k). *)</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">get</span> <span class="n">a</span> <span class="n">i</span> <span class="o">=</span>
    <span class="k">match</span> <span class="n">a</span> <span class="k">with</span>
    <span class="o">|</span> <span class="nc">Base</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">b</span><span class="o">.(</span><span class="n">i</span><span class="o">)</span>
    <span class="o">|</span> <span class="nc">Diff</span> <span class="o">(</span><span class="n">j</span><span class="o">,</span> <span class="n">x</span><span class="o">,</span> <span class="n">a&#39;</span><span class="o">)</span> <span class="o">-&gt;</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">=</span> <span class="n">j</span> <span class="k">then</span> <span class="n">x</span> <span class="k">else</span> <span class="n">get</span> <span class="n">a&#39;</span> <span class="n">i</span>

  <span class="c">(** Efficiency: O(1). *)</span>
  <span class="k">let</span> <span class="n">set</span> <span class="n">a</span> <span class="n">i</span> <span class="n">x</span> <span class="o">=</span> <span class="nc">Diff</span> <span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="n">x</span><span class="o">,</span> <span class="n">a</span><span class="o">)</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>module VersionTreeArray : PersistentArray
</pre></div>
</div>
</div>
</div>
</section>
<section id="rebasing-version-tree-arrays">
<h2><span class="section-number">9.6.3. </span>Rebasing Version-Tree Arrays<a class="headerlink" href="#rebasing-version-tree-arrays" title="Permalink to this heading">#</a></h2>
<p>With version trees, we achieved constant-time <code class="docutils literal notranslate"><span class="pre">set</span></code> operations for a persistent array, but <code class="docutils literal notranslate"><span class="pre">get</span></code> operations were no longer constant time — they were <span class="math notranslate nohighlight">\(O(k)\)</span> where <span class="math notranslate nohighlight">\(k\)</span> was the number of <code class="docutils literal notranslate"><span class="pre">set</span></code> operations that had been perfromed. Is there a way to make both operations constant time while still being persistent? The answer is: almost!</p>
<p>Right now, the original version of the array as stored in the <code class="docutils literal notranslate"><span class="pre">Base</span></code> node is <em>primary</em> and always has constant-time access with <code class="docutils literal notranslate"><span class="pre">get</span></code>. We are going to introduce a new <em>rebasing</em> operation that can make any other version of the array become primary. Then that version will have constant-time access with <code class="docutils literal notranslate"><span class="pre">get</span></code>, even though other versions will still be <span class="math notranslate nohighlight">\(O(k)\)</span>. When a version <span class="math notranslate nohighlight">\(v\)</span> of an array is accessed (either with <code class="docutils literal notranslate"><span class="pre">length</span></code> or <code class="docutils literal notranslate"><span class="pre">set</span></code>), we will mutate the version tree to make <span class="math notranslate nohighlight">\(v\)</span> primary. That means changing the <code class="docutils literal notranslate"><span class="pre">Base</span></code> node to store the contents according to <span class="math notranslate nohighlight">\(v\)</span>, and adjusting <code class="docutils literal notranslate"><span class="pre">Diff</span></code> nodes as needed to compensate for that change in the base.</p>
<p>Since we will now be mutating trees, the representation type needs to change to add a level of indirection:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-OCaml notranslate"><div class="highlight"><pre><span></span><span class="k">type</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">rebasing_tree</span> <span class="o">=</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">node</span> <span class="n">ref</span>
<span class="k">and</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">node</span> <span class="o">=</span>
  <span class="o">|</span> <span class="nc">Base</span> <span class="k">of</span> <span class="k">&#39;</span><span class="n">a</span> <span class="kt">array</span>
  <span class="o">|</span> <span class="nc">Diff</span> <span class="k">of</span> <span class="kt">int</span> <span class="o">*</span> <span class="k">&#39;</span><span class="n">a</span> <span class="o">*</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">rebasing_tree</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>type &#39;a rebasing_tree = &#39;a node ref
and &#39;a node = Base of &#39;a array | Diff of int * &#39;a * &#39;a rebasing_tree
</pre></div>
</div>
</div>
</div>
<p><strong>Make and set.</strong> The <code class="docutils literal notranslate"><span class="pre">make</span></code> and <code class="docutils literal notranslate"><span class="pre">set</span></code> operations require just the insertion of a call to <code class="docutils literal notranslate"><span class="pre">ref</span></code> to adapt to the new representation type:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-OCaml notranslate"><div class="highlight"><pre><span></span><span class="k">let</span> <span class="n">make</span> <span class="n">n</span> <span class="n">x</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">(</span><span class="nc">Base</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">make</span> <span class="n">n</span> <span class="n">x</span><span class="o">))</span>
<span class="k">let</span> <span class="n">set</span> <span class="n">a</span> <span class="n">i</span> <span class="n">x</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">(</span><span class="nc">Diff</span> <span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="n">x</span><span class="o">,</span> <span class="n">a</span><span class="o">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val make : int -&gt; &#39;a -&gt; &#39;a node ref = &lt;fun&gt;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val set : &#39;a rebasing_tree -&gt; int -&gt; &#39;a -&gt; &#39;a node ref = &lt;fun&gt;
</pre></div>
</div>
</div>
</div>
<p>Their efficiency is unchanged: <span class="math notranslate nohighlight">\(O(n)\)</span> for <code class="docutils literal notranslate"><span class="pre">make</span></code>, and <span class="math notranslate nohighlight">\(O(1)\)</span> for <code class="docutils literal notranslate"><span class="pre">set</span></code>.</p>
<p><strong>Rebase.</strong> To rebase a tree we introduce a new recursive helper function <code class="docutils literal notranslate"><span class="pre">rebase</span> <span class="pre">:</span> <span class="pre">'a</span> <span class="pre">rebasing_tree</span> <span class="pre">-&gt;</span> <span class="pre">'a</span> <span class="pre">rebasing</span> <span class="pre">tree</span></code> such that <code class="docutils literal notranslate"><span class="pre">rebase</span> <span class="pre">t</span></code> mutates tree <code class="docutils literal notranslate"><span class="pre">t</span></code> to make the version of the array represented by <code class="docutils literal notranslate"><span class="pre">t</span></code> be primary. Therefore, when <code class="docutils literal notranslate"><span class="pre">rebase</span></code> returns <code class="docutils literal notranslate"><span class="pre">t</span></code> is guaranteed to be a ref to a <code class="docutils literal notranslate"><span class="pre">Base</span></code> node.</p>
<p>There are two cases to consider. First, if <code class="docutils literal notranslate"><span class="pre">t</span></code> is a ref to a <code class="docutils literal notranslate"><span class="pre">Base</span></code> node, then our work is already done. That version is already primary.</p>
<p>Second, if <code class="docutils literal notranslate"><span class="pre">t</span></code> is a ref to a <code class="docutils literal notranslate"><span class="pre">Diff</span></code> node, then we have work to do. That node has the form <code class="docutils literal notranslate"><span class="pre">Diff(i,</span> <span class="pre">x,</span> <span class="pre">t')</span></code> where <code class="docutils literal notranslate"><span class="pre">t'</span></code> represents another version of the array. We call <code class="docutils literal notranslate"><span class="pre">rebase</span></code> on <code class="docutils literal notranslate"><span class="pre">t'</span></code> to make it primary; after that, <code class="docutils literal notranslate"><span class="pre">t'</span></code> must be a ref to a <code class="docutils literal notranslate"><span class="pre">Base</span></code> node. That means we have the following situation, where <code class="docutils literal notranslate"><span class="pre">a</span></code> is an array:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>t  ---&gt; Diff (i, x, t&#39;)
t&#39; ---&gt; Base a
</pre></div>
</div>
<p>To make <code class="docutils literal notranslate"><span class="pre">t</span></code> primary, we just need to swap those nodes around, as well as swap the values found at index <code class="docutils literal notranslate"><span class="pre">i</span></code>. Suppose that in the <code class="docutils literal notranslate"><span class="pre">Base</span></code> node <code class="docutils literal notranslate"><span class="pre">a.(i)</span></code> is <code class="docutils literal notranslate"><span class="pre">y</span></code>. We mutate <code class="docutils literal notranslate"><span class="pre">a.(i)</span></code> to be <code class="docutils literal notranslate"><span class="pre">x</span></code>; let’s call that array <code class="docutils literal notranslate"><span class="pre">a'</span></code>. And we create a new <code class="docutils literal notranslate"><span class="pre">Diff</span></code> node with <code class="docutils literal notranslate"><span class="pre">y</span></code>:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>t  ---&gt; Base a&#39;
t&#39; ---&gt; Diff (i, y, t)
</pre></div>
</div>
<p>Now <code class="docutils literal notranslate"><span class="pre">t</span></code> is primary and represents the same version of the array as it did before the rebase.</p>
<p>Here is the code that implements rebasing:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-OCaml notranslate"><div class="highlight"><pre><span></span><span class="k">let</span> <span class="k">rec</span> <span class="n">rebase</span> <span class="n">a</span> <span class="o">=</span>
  <span class="k">match</span> <span class="o">!</span><span class="n">a</span> <span class="k">with</span>
  <span class="o">|</span> <span class="nc">Base</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">b</span>
  <span class="o">|</span> <span class="nc">Diff</span> <span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="n">x</span><span class="o">,</span> <span class="n">a&#39;</span><span class="o">)</span> <span class="o">-&gt;</span>
      <span class="k">let</span> <span class="n">b</span> <span class="o">=</span> <span class="n">rebase</span> <span class="n">a&#39;</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">old_x</span> <span class="o">=</span> <span class="n">b</span><span class="o">.(</span><span class="n">i</span><span class="o">)</span> <span class="k">in</span>
      <span class="n">b</span><span class="o">.(</span><span class="n">i</span><span class="o">)</span> <span class="o">&lt;-</span> <span class="n">x</span><span class="o">;</span>
      <span class="n">a</span> <span class="o">:=</span> <span class="nc">Base</span> <span class="n">b</span><span class="o">;</span>
      <span class="n">a&#39;</span> <span class="o">:=</span> <span class="nc">Diff</span> <span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="n">old_x</span><span class="o">,</span> <span class="n">a</span><span class="o">);</span>
      <span class="n">b</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val rebase : &#39;a rebasing_tree -&gt; &#39;a array = &lt;fun&gt;
</pre></div>
</div>
</div>
</div>
<p>The efficiency of <code class="docutils literal notranslate"><span class="pre">rebase</span></code> is <span class="math notranslate nohighlight">\(O(k)\)</span>, because there could be up to <span class="math notranslate nohighlight">\(k\)</span> <code class="docutils literal notranslate"><span class="pre">Diff</span></code> nodes between <code class="docutils literal notranslate"><span class="pre">t</span></code> and its original <code class="docutils literal notranslate"><span class="pre">Base</span></code>. Immediately after calling <code class="docutils literal notranslate"><span class="pre">rebase</span> <span class="pre">t</span></code>, any further calls to <code class="docutils literal notranslate"><span class="pre">rebase</span> <span class="pre">t</span></code> will be only <span class="math notranslate nohighlight">\(O(1)\)</span>, because <code class="docutils literal notranslate"><span class="pre">t</span></code> is now primary.</p>
<p><strong>Get and length.</strong> Now that we have <code class="docutils literal notranslate"><span class="pre">rebase</span></code>, there is only a small modification needed to <code class="docutils literal notranslate"><span class="pre">length</span></code> and <code class="docutils literal notranslate"><span class="pre">get</span></code> to call <code class="docutils literal notranslate"><span class="pre">rebase</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-OCaml notranslate"><div class="highlight"><pre><span></span><span class="k">let</span> <span class="n">length</span> <span class="n">a</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="o">(</span><span class="n">rebase</span> <span class="n">a</span><span class="o">)</span>
<span class="k">let</span> <span class="n">get</span> <span class="n">a</span> <span class="n">i</span> <span class="o">=</span> <span class="o">(</span><span class="n">rebase</span> <span class="n">a</span><span class="o">).(</span><span class="n">i</span><span class="o">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val length : &#39;a rebasing_tree -&gt; int = &lt;fun&gt;
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>val get : &#39;a rebasing_tree -&gt; int -&gt; &#39;a = &lt;fun&gt;
</pre></div>
</div>
</div>
</div>
<p>The efficiency of these is the same as <code class="docutils literal notranslate"><span class="pre">rebase</span></code>: <span class="math notranslate nohighlight">\(O(k)\)</span> on the first call, then <span class="math notranslate nohighlight">\(O(1)\)</span> on future calls as long as no other version of the array has been accessed in the mean time.</p>
<p><strong>Rebasing version-tree implementation:</strong> Pulling it all together, here is an implementation of persistent arrays using rebasing version trees:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-OCaml notranslate"><div class="highlight"><pre><span></span><span class="k">module</span> <span class="nc">RebasingVersionTreeArray</span> <span class="o">:</span> <span class="nc">PersistentArray</span> <span class="o">=</span> <span class="k">struct</span>
  <span class="k">type</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span> <span class="o">=</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">node</span> <span class="n">ref</span>
  <span class="c">(** See [VersionTreeArray]. *)</span>

  <span class="k">and</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">node</span> <span class="o">=</span>
    <span class="o">|</span> <span class="nc">Base</span> <span class="k">of</span> <span class="k">&#39;</span><span class="n">a</span> <span class="kt">array</span>
    <span class="o">|</span> <span class="nc">Diff</span> <span class="k">of</span> <span class="kt">int</span> <span class="o">*</span> <span class="k">&#39;</span><span class="n">a</span> <span class="o">*</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">t</span>

  <span class="c">(** Efficiency: O(n). *)</span>
  <span class="k">let</span> <span class="n">make</span> <span class="n">n</span> <span class="n">x</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">(</span><span class="nc">Base</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">make</span> <span class="n">n</span> <span class="n">x</span><span class="o">))</span>

  <span class="c">(** Efficiency: O(k), where k is the number of diffs between this version</span>
<span class="c">      of the array and its base. At most, that is the number of [set] </span>
<span class="c">      operations performed on all versions of the array. If there aren&#39;t </span>
<span class="c">      any diffs, O(1). After a [rebase], remains O(1) until a different </span>
<span class="c">      version of the array is accessed. Not tail recursive. *)</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">rebase</span> <span class="n">a</span> <span class="o">=</span>
    <span class="k">match</span> <span class="o">!</span><span class="n">a</span> <span class="k">with</span>
    <span class="o">|</span> <span class="nc">Base</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">b</span>
    <span class="o">|</span> <span class="nc">Diff</span> <span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="n">x</span><span class="o">,</span> <span class="n">a&#39;</span><span class="o">)</span> <span class="o">-&gt;</span>
        <span class="k">let</span> <span class="n">b</span> <span class="o">=</span> <span class="n">rebase</span> <span class="n">a&#39;</span> <span class="k">in</span>
        <span class="k">let</span> <span class="n">old_x</span> <span class="o">=</span> <span class="n">b</span><span class="o">.(</span><span class="n">i</span><span class="o">)</span> <span class="k">in</span>
        <span class="n">b</span><span class="o">.(</span><span class="n">i</span><span class="o">)</span> <span class="o">&lt;-</span> <span class="n">x</span><span class="o">;</span>
        <span class="n">a</span> <span class="o">:=</span> <span class="nc">Base</span> <span class="n">b</span><span class="o">;</span>
        <span class="n">a&#39;</span> <span class="o">:=</span> <span class="nc">Diff</span> <span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="n">old_x</span><span class="o">,</span> <span class="n">a</span><span class="o">);</span>
        <span class="n">b</span>

  <span class="c">(** Efficiency: Same as [rebase]. *)</span>
  <span class="k">let</span> <span class="n">length</span> <span class="n">a</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="o">(</span><span class="n">rebase</span> <span class="n">a</span><span class="o">)</span>

  <span class="c">(** Efficiency: Same as [rebase]. *)</span>
  <span class="k">let</span> <span class="n">get</span> <span class="n">a</span> <span class="n">i</span> <span class="o">=</span> <span class="o">(</span><span class="n">rebase</span> <span class="n">a</span><span class="o">).(</span><span class="n">i</span><span class="o">)</span>

  <span class="c">(** Efficiency: O(1). *)</span>
  <span class="k">let</span> <span class="n">set</span> <span class="n">a</span> <span class="n">i</span> <span class="n">v</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">(</span><span class="nc">Diff</span> <span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="n">v</span><span class="o">,</span> <span class="n">a</span><span class="o">))</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>module RebasingVersionTreeArray : PersistentArray
</pre></div>
</div>
</div>
</div>
<p>With rebasing we now have <span class="math notranslate nohighlight">\(O(1)\)</span> <code class="docutils literal notranslate"><span class="pre">get</span></code> and <code class="docutils literal notranslate"><span class="pre">set</span></code> operations on the primary (most recently accessed version) of the array. We pay an <span class="math notranslate nohighlight">\(O(k)\)</span> price to change to a new primary version, but after that, access to it remains <span class="math notranslate nohighlight">\(O(1)\)</span> until another rebase occurs.</p>
</section>
<section id="citations">
<h2><span class="section-number">9.6.4. </span>Citations<a class="headerlink" href="#citations" title="Permalink to this heading">#</a></h2>
<p>Our final implementation is most similar to that of Sylvain Conchon and Jean-Christophe Filliâtre (<em>A persistent union-find data structure</em>, ACM Workshop on ML, 2007). They credit Henry Baker for the idea of version trees (Shallow binding in LISP 1.5, <em>CACM</em> 21:7, 1978) and rebasing (Shallow binding makes functional arrays fast, <em>SIGPLAN Not.</em>, 26(8):145-147, 1991).</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "cs3110/textbook",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "ocaml-jupyter"
        },
        kernelOptions: {
            name: "ocaml-jupyter",
            path: "./chapters/ds"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'ocaml-jupyter'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="memoization.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title"><span class="section-number">9.5. </span>Memoization</p>
      </div>
    </a>
    <a class="right-next"
       href="summary.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">9.7. </span>Summary</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#copy-on-set-arrays">9.6.1. Copy-On-Set Arrays</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#version-tree-arrays">9.6.2. Version-Tree Arrays</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#rebasing-version-tree-arrays">9.6.3. Rebasing Version-Tree Arrays</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#citations">9.6.4. Citations</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Michael R. Clarkson et al.
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2025.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=bd9e20870c6007c4c509"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=bd9e20870c6007c4c509"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>